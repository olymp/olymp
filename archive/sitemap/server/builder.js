var http = require('http');
var url = require('url');
var util = require('util');
var EventEmitter = require('events').EventEmitter;
var Crawler = require('simplecrawler');
var cheerio = require('cheerio');
var xmlbuilder = require('xmlbuilder');
var assign = require('lodash/assign');
var forIn = require('lodash/forIn');
var format = require('date-fns/format');

/**
 * Builds an URL string from a parsed URL Object.
 *
 * @return {String} stringified URL
 */
function stringifyUrl(parsedUrl) {
  return parsedUrl.protocol + '://' + parsedUrl.host + parsedUrl.uriPath;
}

/**
 * Generator object, handling the crawler and sitemap generation.
 *
 * @param  {String} uri       URL to parse
 * @param  {Object} options   various options
 */
function SitemapGenerator(uri, options) {
  var self = this;

  // defaults
  var defaultOptions = {
    stripQuerystring: true,
    restrictToBasepath: false
  };

  // excluded filetypes
  var exclude = ['gif', 'jpg', 'jpeg', 'png', 'ico', 'bmp', 'ogg', 'webp', 'mp4', 'webm', 'mp3', 'ttf', 'woff', 'json', 'rss', 'atom', 'gz', 'zip', 'rar', '7z', 'css', 'js', 'gzip', 'exe', 'svg'];
  var exts = exclude.join('|');
  var extRegex = new RegExp('.(' + exts + ')', 'i');

  // throw error if no baseUrl is provided
  if (!uri) {
    throw new TypeError("First parameter 'uri' is required!");
  }

  // set default status
  this.status = 'idle';

  // assign default options
  this.options = assign({}, defaultOptions, options);

  // store for discovered ressources
  this.store = {
    error: [],
    found: [],
    ignored: []
  };

  // prepend protocol if not provided
  var baseUrl = uri;
  if (!/^https?:\/\//.test(uri)) {
    baseUrl = 'http://' + baseUrl;
  }

  // create URL object
  this.baseUrl = url.parse(baseUrl);

  // create Crawler
  this.crawler = new Crawler(this.baseUrl.href);

  // set initial path to subpage if provided
  var initialPath = '/';
  if (this.baseUrl.pathname) {
    initialPath = this.baseUrl.pathname;
  }
  // set initial path
  this.crawler.initialPath = initialPath;

  // decode responses
  this.crawler.decodeResponses = true;

  // respect robots txt rules
  this.crawler.respectRobotsTxt = true;

  // set initial protocol
  this.crawler.initialProtocol = this.baseUrl.protocol.replace(':', '');

  // set user agent
  this.crawler.userAgent = 'Node/SitemapGenerator';

  // pass query string handling option to crawler
  this.crawler.stripQuerystring = this.options.stripQuerystring;

  // restrict crawler to subpages if initial page is privided
  if (this.options.restrictToBasepath) {
    this.crawler.addFetchCondition(function (parsedUrl) {
      var baseUrlPath = url.resolve(self.baseUrl.hostname, self.baseUrl.pathname);
      var baseUrlRegex = new RegExp(baseUrlPath + '.*');
      return stringifyUrl(parsedUrl).match(baseUrlRegex);
    });
  }

  // file type exclusion
  this.crawler.addFetchCondition(function (parsedUrl) {
    return !parsedUrl.path.match(extRegex);
  });

  // array with urls that are crawled but shouldn't be indexed
  this.crawler.noindex = [];

  // custom discover function
  this.crawler.discoverResources = this._discoverResources;

  // register event handlers and emit own events
  this.crawler.on('fetch404', function (queueItem) {
    self.store.error.push(queueItem.url);
    self.emit('fetch', http.STATUS_CODES['404'], queueItem.url);
  });

  this.crawler.on('fetchtimeout', function (queueItem, response) {
    self.store.error.push(queueItem.url);
    self.emit('fetch', http.STATUS_CODES['408'], response);
  });

  this.crawler.on('clienterror', function (queueError, errorData) {
    self.emit('clienterror', queueError, errorData);
  });

  this.crawler.on('fetchdisallowed', function (queueItem) {
    if (self.store.ignored.indexOf(queueItem.url) === -1) {
      self.store.ignored.push(queueItem.url);
      self.emit('ignore', queueItem.url);
    }
  });

  // fetch complete event
  this.crawler.on('fetchcomplete', function (queueItem) {
    self.store.found.push(queueItem.url);
    self.emit('fetch', http.STATUS_CODES['200'], queueItem.url);
  });

  // crawler done event
  this.crawler.on('complete', this._buildXML.bind(this, function (sitemap) {
    // update status
    this.status = 'idle';

    // emit done event
    this.emit('done', sitemap, this.store);
  }));

  EventEmitter.call(this);
}

util.inherits(SitemapGenerator, EventEmitter);

/**
 * Parses response data for links.
 */
SitemapGenerator.prototype._discoverResources = function (buffer, queueItem) {
  var $ = cheerio.load(buffer.toString('utf8'));

  // cancel if meta robots nofollow is present
  var metaRobots = $('meta[name="robots"]');

  // add to noindex for it later to be removed from the store before a sitemap is built
  if (metaRobots.length && /noindex/i.test(metaRobots.attr('content'))) {
    this.noindex.push(queueItem.url);
  }

  if (metaRobots.length && /nofollow/i.test(metaRobots.attr('content'))) {
    return [];
  }

  // parse links
  var links = $('a[href]').map(function () {
    var href = $(this).attr('href');

    // exclude "mailto:" etc
    if (/^[a-z]+:(?!\/\/)/i.test(href)) {
      return null;
    }

    // remove anchors
    href = href.replace(/(#.*)$/, '');

    // handle "//"
    if (/^\/\//.test(href)) {
      return queueItem.protocol + ':' + href;
    }

    // check if link is relative
    // (does not start with "http(s)" or "//")
    if (!/^https?:\/\//.test(href)) {
      var base = $('base').first();
      if (base.length) {
        // base tag is set, prepend it
        href = url.resolve(base.attr('href'), href);
      }

      // handle links such as "./foo", "../foo", "/foo"
      if (/^\.\.?\/.*/.test(href) || /^\/[^\/].*/.test(href)) {
        href = url.resolve(queueItem.url, href);
      }
    }

    return href;
  });

  return links.get();
};

/**
 * Creates the XML markup.
 *
 * @param  {Function} callback Callback function to execute
 */
SitemapGenerator.prototype._buildXML = function (callback) {
  var sitemap = null;

  if (this.store.found.length > 0 && this.store.found.length !== this.crawler.noindex.length) {
    // Remove urls with a robots meta tag 'noindex' before building the sitemap
    this.crawler.noindex.forEach(function (page) {
      var index = this.store.found.indexOf(page);
      if (index !== -1) {
        // remove url from found array
        var ignored = this.store.found.splice(index, 1)[0];
        // add url to ignored url
        this.store.ignored.push(ignored);
      }
    }, this);

    // xml base
    var xml = xmlbuilder.create('urlset', { version: '1.0', encoding: 'UTF-8' }).att('xmlns', 'http://www.sitemaps.org/schemas/sitemap/0.9');

    // add elements
    forIn(this.store.found, function (foundURL) {
      xml.ele('url').ele({
        loc: foundURL,
        lastmod: format(new Date(), 'YYYY-MM-DDTHH:mm:ss-00:00') // 2016-06-06T20:00:00-00:00
      });
    });

    // finish xml markup
    sitemap = xml.end({ pretty: true, indent: '  ', newline: '\n' });
  }

  if (typeof callback === 'function') {
    callback.call(this, sitemap);
  }
};

/**
 * Starts the crawler.
 */
SitemapGenerator.prototype.start = function () {
  if (this.status === 'crawling') {
    throw new Error('This SitemapGenerator instance is already crawling a site.');
  }

  // update status
  this.status = 'crawling';

  // start the crawler
  this.crawler.start();

  return this;
};

module.exports = SitemapGenerator;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhY2thZ2VzL3NpdGVtYXAvc2VydmVyL2J1aWxkZXIuZXM2Il0sIm5hbWVzIjpbImh0dHAiLCJyZXF1aXJlIiwidXJsIiwidXRpbCIsIkV2ZW50RW1pdHRlciIsIkNyYXdsZXIiLCJjaGVlcmlvIiwieG1sYnVpbGRlciIsImFzc2lnbiIsImZvckluIiwiZm9ybWF0Iiwic3RyaW5naWZ5VXJsIiwicGFyc2VkVXJsIiwicHJvdG9jb2wiLCJob3N0IiwidXJpUGF0aCIsIlNpdGVtYXBHZW5lcmF0b3IiLCJ1cmkiLCJvcHRpb25zIiwic2VsZiIsImRlZmF1bHRPcHRpb25zIiwic3RyaXBRdWVyeXN0cmluZyIsInJlc3RyaWN0VG9CYXNlcGF0aCIsImV4Y2x1ZGUiLCJleHRzIiwiam9pbiIsImV4dFJlZ2V4IiwiUmVnRXhwIiwiVHlwZUVycm9yIiwic3RhdHVzIiwic3RvcmUiLCJlcnJvciIsImZvdW5kIiwiaWdub3JlZCIsImJhc2VVcmwiLCJ0ZXN0IiwicGFyc2UiLCJjcmF3bGVyIiwiaHJlZiIsImluaXRpYWxQYXRoIiwicGF0aG5hbWUiLCJkZWNvZGVSZXNwb25zZXMiLCJyZXNwZWN0Um9ib3RzVHh0IiwiaW5pdGlhbFByb3RvY29sIiwicmVwbGFjZSIsInVzZXJBZ2VudCIsImFkZEZldGNoQ29uZGl0aW9uIiwiYmFzZVVybFBhdGgiLCJyZXNvbHZlIiwiaG9zdG5hbWUiLCJiYXNlVXJsUmVnZXgiLCJtYXRjaCIsInBhdGgiLCJub2luZGV4IiwiZGlzY292ZXJSZXNvdXJjZXMiLCJfZGlzY292ZXJSZXNvdXJjZXMiLCJvbiIsInB1c2giLCJxdWV1ZUl0ZW0iLCJlbWl0IiwiU1RBVFVTX0NPREVTIiwicmVzcG9uc2UiLCJxdWV1ZUVycm9yIiwiZXJyb3JEYXRhIiwiaW5kZXhPZiIsIl9idWlsZFhNTCIsImJpbmQiLCJzaXRlbWFwIiwiY2FsbCIsImluaGVyaXRzIiwicHJvdG90eXBlIiwiYnVmZmVyIiwiJCIsImxvYWQiLCJ0b1N0cmluZyIsIm1ldGFSb2JvdHMiLCJsZW5ndGgiLCJhdHRyIiwibGlua3MiLCJtYXAiLCJiYXNlIiwiZmlyc3QiLCJnZXQiLCJjYWxsYmFjayIsImZvckVhY2giLCJwYWdlIiwiaW5kZXgiLCJzcGxpY2UiLCJ4bWwiLCJjcmVhdGUiLCJ2ZXJzaW9uIiwiZW5jb2RpbmciLCJhdHQiLCJlbGUiLCJsb2MiLCJmb3VuZFVSTCIsImxhc3Rtb2QiLCJEYXRlIiwiZW5kIiwicHJldHR5IiwiaW5kZW50IiwibmV3bGluZSIsInN0YXJ0IiwiRXJyb3IiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQSxJQUFNQSxPQUFPQyxRQUFRLE1BQVIsQ0FBYjtBQUNBLElBQU1DLE1BQU1ELFFBQVEsS0FBUixDQUFaO0FBQ0EsSUFBTUUsT0FBT0YsUUFBUSxNQUFSLENBQWI7QUFDQSxJQUFNRyxlQUFlSCxRQUFRLFFBQVIsRUFBa0JHLFlBQXZDO0FBQ0EsSUFBTUMsVUFBVUosUUFBUSxlQUFSLENBQWhCO0FBQ0EsSUFBTUssVUFBVUwsUUFBUSxTQUFSLENBQWhCO0FBQ0EsSUFBTU0sYUFBYU4sUUFBUSxZQUFSLENBQW5CO0FBQ0EsSUFBTU8sU0FBU1AsUUFBUSxlQUFSLENBQWY7QUFDQSxJQUFNUSxRQUFRUixRQUFRLGNBQVIsQ0FBZDtBQUNBLElBQU1TLFNBQVNULFFBQVEsaUJBQVIsQ0FBZjs7QUFFQTs7Ozs7QUFLQSxTQUFTVSxZQUFULENBQXNCQyxTQUF0QixFQUFpQztBQUMvQixTQUFVQSxVQUFVQyxRQUFwQixXQUFrQ0QsVUFBVUUsSUFBNUMsR0FBbURGLFVBQVVHLE9BQTdEO0FBQ0Q7O0FBRUQ7Ozs7OztBQU1BLFNBQVNDLGdCQUFULENBQTBCQyxHQUExQixFQUErQkMsT0FBL0IsRUFBd0M7QUFDdEMsTUFBTUMsT0FBTyxJQUFiOztBQUVBO0FBQ0EsTUFBTUMsaUJBQWlCO0FBQ3JCQyxzQkFBa0IsSUFERztBQUVyQkMsd0JBQW9CO0FBRkMsR0FBdkI7O0FBS0E7QUFDQSxNQUFNQyxVQUFVLENBQ2QsS0FEYyxFQUVkLEtBRmMs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Y0FBVXFCLElBQUlVLEdBQUosQ0FBUSxFQUFFQyxRQUFRLElBQVYsRUFBZ0JDLFFBQVEsSUFBeEIsRUFBOEJDLFNBQVMsSUFBdkMsRUFBUixDQUFWO0FBQ0Q7O0FBRUQsTUFBSSxPQUFPbEIsUUFBUCxLQUFvQixVQUF4QixFQUFvQztBQUNsQ0EsYUFBU2YsSUFBVCxDQUFjLElBQWQsRUFBb0JELE9BQXBCO0FBQ0Q7QUFDRixDQXRDRDs7QUF3Q0E7OztBQUdBbkQsaUJBQWlCc0QsU0FBakIsQ0FBMkJnQyxLQUEzQixHQUFtQyxZQUFXO0FBQzVDLE1BQUksS0FBS3pFLE1BQUwsS0FBZ0IsVUFBcEIsRUFBZ0M7QUFDOUIsVUFBTSxJQUFJMEUsS0FBSixDQUNKLDREQURJLENBQU47QUFHRDs7QUFFRDtBQUNBLE9BQUsxRSxNQUFMLEdBQWMsVUFBZDs7QUFFQTtBQUNBLE9BQUtRLE9BQUwsQ0FBYWlFLEtBQWI7O0FBRUEsU0FBTyxJQUFQO0FBQ0QsQ0FkRDs7QUFnQkFFLE9BQU9DLE9BQVAsR0FBaUJ6RixnQkFBakIiLCJmaWxlIjoicGFja2FnZXMvc2l0ZW1hcC9zZXJ2ZXIvYnVpbGRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGh0dHAgPSByZXF1aXJlKCdodHRwJyk7XG5jb25zdCB1cmwgPSByZXF1aXJlKCd1cmwnKTtcbmNvbnN0IHV0aWwgPSByZXF1aXJlKCd1dGlsJyk7XG5jb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKS5FdmVudEVtaXR0ZXI7XG5jb25zdCBDcmF3bGVyID0gcmVxdWlyZSgnc2ltcGxlY3Jhd2xlcicpO1xuY29uc3QgY2hlZXJpbyA9IHJlcXVpcmUoJ2NoZWVyaW8nKTtcbmNvbnN0IHhtbGJ1aWxkZXIgPSByZXF1aXJlKCd4bWxidWlsZGVyJyk7XG5jb25zdCBhc3NpZ24gPSByZXF1aXJlKCdsb2Rhc2gvYXNzaWduJyk7XG5jb25zdCBmb3JJbiA9IHJlcXVpcmUoJ2xvZGFzaC9mb3JJbicpO1xuY29uc3QgZm9ybWF0ID0gcmVxdWlyZSgnZGF0ZS1mbnMvZm9ybWF0Jyk7XG5cbi8qKlxuICogQnVpbGRzIGFuIFVSTCBzdHJpbmcgZnJvbSBhIHBhcnNlZCBVUkwgT2JqZWN0LlxuICpcbiAqIEByZXR1cm4ge1N0cmluZ30gc3RyaW5naWZpZWQgVVJMXG4gKi9cbmZ1bmN0aW9uIHN0cmluZ2lmeVVybChwYXJzZWRVcmwpIHtcbiAgcmV0dXJuIGAke3BhcnNlZFVybC5wcm90b2NvbH06Ly8ke3BhcnNlZFVybC5ob3N0fSR7cGFyc2VkVXJsLnVyaVBhdGh9YDtcbn1cblxuLyoqXG4gKiBHZW5lcmF0b3Igb2JqZWN0LCBoYW5kbGluZyB0aGUgY3Jhd2xlciBhbmQgc2l0ZW1hcCBnZW5lcmF0aW9uLlxuICpcbiAqIEBwYXJhbSAge1N0cmluZ30gdXJpICAgICAgIFVSTCB0byBwYXJzZVxuICogQHBhcmFtICB7T2JqZWN0fSBvcHRpb25zICAgdmFyaW91cyBvcHRpb25zXG4gKi9cbmZ1bmN0aW9uIFNpdGVtYXBHZW5lcmF0b3IodXJpLCBvcHRpb25zKSB7XG4gIGNvbnN0IHNlbGYgPSB0aGlzO1xuXG4gIC8vIGRlZmF1bHRzXG4gIGNvbnN0IGRlZmF1bHRPcHRpb25zID0ge1xuICAgIHN0cmlwUXVlcnlzdHJpbmc6IHRydWUsXG4gICAgcmVzdHJpY3RUb0Jhc2VwYXRoOiBmYWxzZSxcbiAgfTtcblxuICAvLyBleGNsdWRlZCBmaWxldHlwZXNcbiAgY29uc3QgZXhjbHVkZSA9IFtcbiAgICAnZ2lmJyxcbiAgICAnanBnJyxcbiAgICAnanBlZycsXG4gICAgJ3BuZycsXG4gICAgJ2ljbycsXG4gICAgJ2JtcCcsXG4gICAgJ29nZycsXG4gICAgJ3dlYnAnLFxuICAgICdtcDQnLFxuICAgICd3ZWJtJyxcbiAgICAnbXAzJyxcbiAgICAndHRmJyxcbiAgICAnd29mZicsXG4gICAgJ2pzb24nLFxuICAgICdyc3MnLFxuICAgICdhdG9tJyxcbiAgICAnZ3onLFxuICAgICd6aXAnLFxuICAgICdyYXInLFxuICAgICc3eicsXG4gICAgJ2NzcycsXG4gICAgJ2pzJyxcbiAgICAnZ3ppcCcsXG4gICAgJ2V4ZScsXG4gICAgJ3N2ZycsXG4gIF07XG4gIGNvbnN0IGV4dHMgPSBleGNsdWRlLmpvaW4oJ3wnKTtcbiAgY29uc3QgZXh0UmVnZXggPSBuZXcgUmVnRXhwKGAuKCR7ZXh0c30pYCwgJ2knKTtcblxuICAvLyB0aHJvdyBlcnJvciBpZiBubyBiYXNlVXJsIGlzIHByb3ZpZGVkXG4gIGlmICghdXJpKSB7XG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkZpcnN0IHBhcmFtZXRlciAndXJpJyBpcyByZXF1aXJlZCFcIik7XG4gIH1cblxuICAvLyBzZXQgZGVmYXVsdCBzdGF0dXNcbiAgdGhpcy5zdGF0dXMgPSAnaWRsZSc7XG5cbiAgLy8gYXNzaWduIGRlZmF1bHQgb3B0aW9uc1xuICB0aGlzLm9wdGlvbnMgPSBhc3NpZ24oe30sIGRlZmF1bHRPcHRpb25zLCBvcHRpb25zKTtcblxuICAvLyBzdG9yZSBmb3IgZGlzY292ZXJlZCByZXNzb3VyY2VzXG4gIHRoaXMuc3RvcmUgPSB7XG4gICAgZXJyb3I6IFtdLFxuICAgIGZvdW5kOiBbXSxcbiAgICBpZ25vcmVkOiBbXSxcbiAgfTtcblxuICAvLyBwcmVwZW5kIHByb3RvY29sIGlmIG5vdCBwcm92aWRlZFxuICBsZXQgYmFzZVVybCA9IHVyaTtcbiAgaWYgKCEvXmh0dHBzPzpcXC9cXC8vLnRlc3QodXJpKSkge1xuICAgIGJhc2VVcmwgPSBgaHR0cDovLyR7YmFzZVVybH1gO1xuICB9XG5cbiAgLy8gY3JlYXRlIFVSTCBvYmplY3RcbiAgdGhpcy5iYXNlVXJsID0gdXJsLnBhcnNlKGJhc2VVcmwpO1xuXG4gIC8vIGNyZWF0ZSBDcmF3bGVyXG4gIHRoaXMuY3Jhd2xlciA9IG5ldyBDcmF3bGVyKHRoaXMuYmFzZVVybC5ocmVmKTtcblxuICAvLyBzZXQgaW5pdGlhbCBwYXRoIHRvIHN1YnBhZ2UgaWYgcHJvdmlkZWRcbiAgbGV0IGluaXRpYWxQYXRoID0gJy8nO1xuICBpZiAodGhpcy5iYXNlVXJsLnBhdGhuYW1lKSB7XG4gICAgaW5pdGlhbFBhdGggPSB0aGlzLmJhc2VVcmwucGF0aG5hbWU7XG4gIH1cbiAgLy8gc2V0IGluaXRpYWwgcGF0aFxuICB0aGlzLmNyYXdsZXIuaW5pdGlhbFBhdGggPSBpbml0aWFsUGF0aDtcblxuICAvLyBkZWNvZGUgcmVzcG9uc2VzXG4gIHRoaXMuY3Jhd2xlci5kZWNvZGVSZXNwb25zZXMgPSB0cnVlO1xuXG4gIC8vIHJlc3BlY3Qgcm9ib3RzIHR4dCBydWxlc1xuICB0aGlzLmNyYXdsZXIucmVzcGVjdFJvYm90c1R4dCA9IHRydWU7XG5cbiAgLy8gc2V0IGluaXRpYWwgcHJvdG9jb2xcbiAgdGhpcy5jcmF3bGVyLmluaXRpYWxQcm90b2NvbCA9IHRoaXMuYmFzZVVybC5wcm90b2NvbC5yZXBsYWNlKCc6JywgJycpO1xuXG4gIC8vIHNldCB1c2VyIGFnZW50XG4gIHRoaXMuY3Jhd2xlci51c2VyQWdlbnQgPSAnTm9kZS9TaXRlbWFwR2VuZXJhdG9yJztcblxuICAvLyBwYXNzIHF1ZXJ5IHN0cmluZyBoYW5kbGluZyBvcHRpb24gdG8gY3Jhd2xlclxuICB0aGlzLmNyYXdsZXIuc3RyaXBRdWVyeXN0cmluZyA9IHRoaXMub3B0aW9ucy5zdHJpcFF1ZXJ5c3RyaW5nO1xuXG4gIC8vIHJlc3RyaWN0IGNyYXdsZXIgdG8gc3VicGFnZXMgaWYgaW5pdGlhbCBwYWdlIGlzIHByaXZpZGVkXG4gIGlmICh0aGlzLm9wdGlvbnMucmVzdHJpY3RUb0Jhc2VwYXRoKSB7XG4gICAgdGhpcy5jcmF3bGVyLmFkZEZldGNoQ29uZGl0aW9uKHBhcnNlZFVybCA9PiB7XG4gICAgICBjb25zdCBiYXNlVXJsUGF0aCA9IHVybC5yZXNvbHZlKFxuICAgICAgICBzZWxmLmJhc2VVcmwuaG9zdG5hbWUsXG4gICAgICAgIHNlbGYuYmFzZVVybC5wYXRobmFtZSxcbiAgICAgICk7XG4gICAgICBjb25zdCBiYXNlVXJsUmVnZXggPSBuZXcgUmVnRXhwKGAke2Jhc2VVcmxQYXRofS4qYCk7XG4gICAgICByZXR1cm4gc3RyaW5naWZ5VXJsKHBhcnNlZFVybCkubWF0Y2goYmFzZVVybFJlZ2V4KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8vIGZpbGUgdHlwZSBleGNsdXNpb25cbiAgdGhpcy5jcmF3bGVyLmFkZEZldGNoQ29uZGl0aW9uKHBhcnNlZFVybCA9PiAhcGFyc2VkVXJsLnBhdGgubWF0Y2goZXh0UmVnZXgpKTtcblxuICAvLyBhcnJheSB3aXRoIHVybHMgdGhhdCBhcmUgY3Jhd2xlZCBidXQgc2hvdWxkbid0IGJlIGluZGV4ZWRcbiAgdGhpcy5jcmF3bGVyLm5vaW5kZXggPSBbXTtcblxuICAvLyBjdXN0b20gZGlzY292ZXIgZnVuY3Rpb25cbiAgdGhpcy5jcmF3bGVyLmRpc2NvdmVyUmVzb3VyY2VzID0gdGhpcy5fZGlzY292ZXJSZXNvdXJjZXM7XG5cbiAgLy8gcmVnaXN0ZXIgZXZlbnQgaGFuZGxlcnMgYW5kIGVtaXQgb3duIGV2ZW50c1xuICB0aGlzLmNyYXdsZXIub24oJ2ZldGNoNDA0JywgcXVldWVJdGVtID0+IHtcbiAgICBzZWxmLnN0b3JlLmVycm9yLnB1c2gocXVldWVJdGVtLnVybCk7XG4gICAgc2VsZi5lbWl0KCdmZXRjaCcsIGh0dHAuU1RBVFVTX0NPREVTWyc0MDQnXSwgcXVldWVJdGVtLnVybCk7XG4gIH0pO1xuXG4gIHRoaXMuY3Jhd2xlci5vbignZmV0Y2h0aW1lb3V0JywgKHF1ZXVlSXRlbSwgcmVzcG9uc2UpID0+IHtcbiAgICBzZWxmLnN0b3JlLmVycm9yLnB1c2gocXVldWVJdGVtLnVybCk7XG4gICAgc2VsZi5lbWl0KCdmZXRjaCcsIGh0dHAuU1RBVFVTX0NPREVTWyc0MDgnXSwgcmVzcG9uc2UpO1xuICB9KTtcblxuICB0aGlzLmNyYXdsZXIub24oJ2NsaWVudGVycm9yJywgKHF1ZXVlRXJyb3IsIGVycm9yRGF0YSkgPT4ge1xuICAgIHNlbGYuZW1pdCgnY2xpZW50ZXJyb3InLCBxdWV1ZUVycm9yLCBlcnJvckRhdGEpO1xuICB9KTtcblxuICB0aGlzLmNyYXdsZXIub24oJ2ZldGNoZGlzYWxsb3dlZCcsIHF1ZXVlSXRlbSA9PiB7XG4gICAgaWYgKHNlbGYuc3RvcmUuaWdub3JlZC5pbmRleE9mKHF1ZXVlSXRlbS51cmwpID09PSAtMSkge1xuICAgICAgc2VsZi5zdG9yZS5pZ25vcmVkLnB1c2gocXVldWVJdGVtLnVybCk7XG4gICAgICBzZWxmLmVtaXQoJ2lnbm9yZScsIHF1ZXVlSXRlbS51cmwpO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gZmV0Y2ggY29tcGxldGUgZXZlbnRcbiAgdGhpcy5jcmF3bGVyLm9uKCdmZXRjaGNvbXBsZXRlJywgcXVldWVJdGVtID0+IHtcbiAgICBzZWxmLnN0b3JlLmZvdW5kLnB1c2gocXVldWVJdGVtLnVybCk7XG4gICAgc2VsZi5lbWl0KCdmZXRjaCcsIGh0dHAuU1RBVFVTX0NPREVTWycyMDAnXSwgcXVldWVJdGVtLnVybCk7XG4gIH0pO1xuXG4gIC8vIGNyYXdsZXIgZG9uZSBldmVudFxuICB0aGlzLmNyYXdsZXIub24oXG4gICAgJ2NvbXBsZXRlJyxcbiAgICB0aGlzLl9idWlsZFhNTC5iaW5kKHRoaXMsIGZ1bmN0aW9uKHNpdGVtYXApIHtcbiAgICAgIC8vIHVwZGF0ZSBzdGF0dXNcbiAgICAgIHRoaXMuc3RhdHVzID0gJ2lkbGUnO1xuXG4gICAgICAvLyBlbWl0IGRvbmUgZXZlbnRcbiAgICAgIHRoaXMuZW1pdCgnZG9uZScsIHNpdGVtYXAsIHRoaXMuc3RvcmUpO1xuICAgIH0pLFxuICApO1xuXG4gIEV2ZW50RW1pdHRlci5jYWxsKHRoaXMpO1xufVxuXG51dGlsLmluaGVyaXRzKFNpdGVtYXBHZW5lcmF0b3IsIEV2ZW50RW1pdHRlcik7XG5cbi8qKlxuICogUGFyc2VzIHJlc3BvbnNlIGRhdGEgZm9yIGxpbmtzLlxuICovXG5TaXRlbWFwR2VuZXJhdG9yLnByb3RvdHlwZS5fZGlzY292ZXJSZXNvdXJjZXMgPSBmdW5jdGlvbihidWZmZXIsIHF1ZXVlSXRlbSkge1xuICBjb25zdCAkID0gY2hlZXJpby5sb2FkKGJ1ZmZlci50b1N0cmluZygndXRmOCcpKTtcblxuICAvLyBjYW5jZWwgaWYgbWV0YSByb2JvdHMgbm9mb2xsb3cgaXMgcHJlc2VudFxuICBjb25zdCBtZXRhUm9ib3RzID0gJCgnbWV0YVtuYW1lPVwicm9ib3RzXCJdJyk7XG5cbiAgLy8gYWRkIHRvIG5vaW5kZXggZm9yIGl0IGxhdGVyIHRvIGJlIHJlbW92ZWQgZnJvbSB0aGUgc3RvcmUgYmVmb3JlIGEgc2l0ZW1hcCBpcyBidWlsdFxuICBpZiAobWV0YVJvYm90cy5sZW5ndGggJiYgL25vaW5kZXgvaS50ZXN0KG1ldGFSb2JvdHMuYXR0cignY29udGVudCcpKSkge1xuICAgIHRoaXMubm9pbmRleC5wdXNoKHF1ZXVlSXRlbS51cmwpO1xuICB9XG5cbiAgaWYgKG1ldGFSb2JvdHMubGVuZ3RoICYmIC9ub2ZvbGxvdy9pLnRlc3QobWV0YVJvYm90cy5hdHRyKCdjb250ZW50JykpKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgLy8gcGFyc2UgbGlua3NcbiAgY29uc3QgbGlua3MgPSAkKCdhW2hyZWZdJykubWFwKGZ1bmN0aW9uKCkge1xuICAgIGxldCBocmVmID0gJCh0aGlzKS5hdHRyKCdocmVmJyk7XG5cbiAgICAvLyBleGNsdWRlIFwibWFpbHRvOlwiIGV0Y1xuICAgIGlmICgvXlthLXpdKzooPyFcXC9cXC8pL2kudGVzdChocmVmKSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLy8gcmVtb3ZlIGFuY2hvcnNcbiAgICBocmVmID0gaHJlZi5yZXBsYWNlKC8oIy4qKSQvLCAnJyk7XG5cbiAgICAvLyBoYW5kbGUgXCIvL1wiXG4gICAgaWYgKC9eXFwvXFwvLy50ZXN0KGhyZWYpKSB7XG4gICAgICByZXR1cm4gYCR7cXVldWVJdGVtLnByb3RvY29sfToke2hyZWZ9YDtcbiAgICB9XG5cbiAgICAvLyBjaGVjayBpZiBsaW5rIGlzIHJlbGF0aXZlXG4gICAgLy8gKGRvZXMgbm90IHN0YXJ0IHdpdGggXCJodHRwKHMpXCIgb3IgXCIvL1wiKVxuICAgIGlmICghL15odHRwcz86XFwvXFwvLy50ZXN0KGhyZWYpKSB7XG4gICAgICBjb25zdCBiYXNlID0gJCgnYmFzZScpLmZpcnN0KCk7XG4gICAgICBpZiAoYmFzZS5sZW5ndGgpIHtcbiAgICAgICAgLy8gYmFzZSB0YWcgaXMgc2V0LCBwcmVwZW5kIGl0XG4gICAgICAgIGhyZWYgPSB1cmwucmVzb2x2ZShiYXNlLmF0dHIoJ2hyZWYnKSwgaHJlZik7XG4gICAgICB9XG5cbiAgICAgIC8vIGhhbmRsZSBsaW5rcyBzdWNoIGFzIFwiLi9mb29cIiwgXCIuLi9mb29cIiwgXCIvZm9vXCJcbiAgICAgIGlmICgvXlxcLlxcLj9cXC8uKi8udGVzdChocmVmKSB8fCAvXlxcL1teXFwvXS4qLy50ZXN0KGhyZWYpKSB7XG4gICAgICAgIGhyZWYgPSB1cmwucmVzb2x2ZShxdWV1ZUl0ZW0udXJsLCBocmVmKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gaHJlZjtcbiAgfSk7XG5cbiAgcmV0dXJuIGxpbmtzLmdldCgpO1xufTtcblxuLyoqXG4gKiBDcmVhdGVzIHRoZSBYTUwgbWFya3VwLlxuICpcbiAqIEBwYXJhbSAge0Z1bmN0aW9ufSBjYWxsYmFjayBDYWxsYmFjayBmdW5jdGlvbiB0byBleGVjdXRlXG4gKi9cblNpdGVtYXBHZW5lcmF0b3IucHJvdG90eXBlLl9idWlsZFhNTCA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7XG4gIGxldCBzaXRlbWFwID0gbnVsbDtcblxuICBpZiAoXG4gICAgdGhpcy5zdG9yZS5mb3VuZC5sZW5ndGggPiAwICYmXG4gICAgdGhpcy5zdG9yZS5mb3VuZC5sZW5ndGggIT09IHRoaXMuY3Jhd2xlci5ub2luZGV4Lmxlbmd0aFxuICApIHtcbiAgICAvLyBSZW1vdmUgdXJscyB3aXRoIGEgcm9ib3RzIG1ldGEgdGFnICdub2luZGV4JyBiZWZvcmUgYnVpbGRpbmcgdGhlIHNpdGVtYXBcbiAgICB0aGlzLmNyYXdsZXIubm9pbmRleC5mb3JFYWNoKGZ1bmN0aW9uKHBhZ2UpIHtcbiAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5zdG9yZS5mb3VuZC5pbmRleE9mKHBhZ2UpO1xuICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgICAvLyByZW1vdmUgdXJsIGZyb20gZm91bmQgYXJyYXlcbiAgICAgICAgY29uc3QgaWdub3JlZCA9IHRoaXMuc3RvcmUuZm91bmQuc3BsaWNlKGluZGV4LCAxKVswXTtcbiAgICAgICAgLy8gYWRkIHVybCB0byBpZ25vcmVkIHVybFxuICAgICAgICB0aGlzLnN0b3JlLmlnbm9yZWQucHVzaChpZ25vcmVkKTtcbiAgICAgIH1cbiAgICB9LCB0aGlzKTtcblxuICAgIC8vIHhtbCBiYXNlXG4gICAgY29uc3QgeG1sID0geG1sYnVpbGRlclxuICAgICAgLmNyZWF0ZSgndXJsc2V0JywgeyB2ZXJzaW9uOiAnMS4wJywgZW5jb2Rpbmc6ICdVVEYtOCcgfSlcbiAgICAgIC5hdHQoJ3htbG5zJywgJ2h0dHA6Ly93d3cuc2l0ZW1hcHMub3JnL3NjaGVtYXMvc2l0ZW1hcC8wLjknKTtcblxuICAgIC8vIGFkZCBlbGVtZW50c1xuICAgIGZvckluKHRoaXMuc3RvcmUuZm91bmQsIGZvdW5kVVJMID0+IHtcbiAgICAgIHhtbC5lbGUoJ3VybCcpLmVsZSh7XG4gICAgICAgIGxvYzogZm91bmRVUkwsXG4gICAgICAgIGxhc3Rtb2Q6IGZvcm1hdChuZXcgRGF0ZSgpLCAnWVlZWS1NTS1ERFRISDptbTpzcy0wMDowMCcpLCAvLyAyMDE2LTA2LTA2VDIwOjAwOjAwLTAwOjAwXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIC8vIGZpbmlzaCB4bWwgbWFya3VwXG4gICAgc2l0ZW1hcCA9IHhtbC5lbmQoeyBwcmV0dHk6IHRydWUsIGluZGVudDogJyAgJywgbmV3bGluZTogJ1xcbicgfSk7XG4gIH1cblxuICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7XG4gICAgY2FsbGJhY2suY2FsbCh0aGlzLCBzaXRlbWFwKTtcbiAgfVxufTtcblxuLyoqXG4gKiBTdGFydHMgdGhlIGNyYXdsZXIuXG4gKi9cblNpdGVtYXBHZW5lcmF0b3IucHJvdG90eXBlLnN0YXJ0ID0gZnVuY3Rpb24oKSB7XG4gIGlmICh0aGlzLnN0YXR1cyA9PT0gJ2NyYXdsaW5nJykge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICdUaGlzIFNpdGVtYXBHZW5lcmF0b3IgaW5zdGFuY2UgaXMgYWxyZWFkeSBjcmF3bGluZyBhIHNpdGUuJyxcbiAgICApO1xuICB9XG5cbiAgLy8gdXBkYXRlIHN0YXR1c1xuICB0aGlzLnN0YXR1cyA9ICdjcmF3bGluZyc7XG5cbiAgLy8gc3RhcnQgdGhlIGNyYXdsZXJcbiAgdGhpcy5jcmF3bGVyLnN0YXJ0KCk7XG5cbiAgcmV0dXJuIHRoaXM7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IFNpdGVtYXBHZW5lcmF0b3I7XG4iXX0=
