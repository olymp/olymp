var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

/* globals define */

(function (root, factory) {
  ;

  /* istanbul ignore next:cant test */
  if ((typeof module === 'undefined' ? 'undefined' : _typeof(module)) === 'object' && _typeof(module.exports) === 'object') {
    module.exports = factory();
  } else if (typeof define === 'function' && define.amd) {
    // AMD. Register as an anonymous module.
    define([], factory);
  } else {
    // Browser globals
    root.objectPath = factory();
  }
})(this, function () {
  'use strict';

  var _hasOwnProperty = Object.prototype.hasOwnProperty;

  function isEmpty(value) {
    if (!value) {
      return true;
    }
    if (isArray(value) && value.length === 0) {
      return true;
    } else if (!isString(value)) {
      for (var i in value) {
        if (_hasOwnProperty.call(value, i)) {
          return false;
        }
      }
      return true;
    }
    return false;
  }

  function isNumber(value) {
    return typeof value === 'number';
  }

  function isString(obj) {
    return typeof obj === 'string';
  }

  function isArray(obj) {
    return Array.isArray(obj);
  }

  function getKey(key) {
    var intKey = parseInt(key);
    if (intKey.toString() === key) {
      return intKey;
    }
    return key;
  }

  var objectPathImmutable = function objectPathImmutable(src) {
    var dest = src;
    var committed = false;

    var transaction = Object.keys(api).reduce(function (proxy, prop) {
      /* istanbul ignore else */
      if (typeof api[prop] === 'function') {
        proxy[prop] = function () {
          var args = [dest, src].concat(Array.prototype.slice.call(arguments));

          if (committed) {
            throw new Error('Cannot call ' + prop + ' after `value`');
          }

          dest = api[prop].apply(null, args);

          return transaction;
        };
      }

      return proxy;
    }, {});

    transaction.value = function () {
      committed = true;
      return dest;
    };

    return transaction;
  };

  function clone(obj, createIfEmpty, assumeArray) {
    if (obj == null) {
      if (createIfEmpty) {
        if (assumeArray) {
          return [];
        }

        return {};
      }

      return obj;
    } else if (isArray(obj)) {
      return obj.slice();
    }

    var res = {};
    for (var key in obj) {
      if (obj.hasOwnProperty(key)) {
        res[key] = obj[key];
      }
    }

    return res;
  }

  function changeImmutable(dest, src, path, changeCallback) {
    if (isNumber(path)) {
      path = [path];
    }
    if (isEmpty(path)) {
      return src;
    }
    if (isString(path)) {
      return changeImmutable(dest, src, path.split('.').map(getKey), changeCallback);
    }
    var currentPath = path[0];

    if (!dest || dest === src) {
      dest = clone(src, true, isNumber(currentPath));
    }

    if (path.length === 1) {
      return changeCallback(dest, currentPath);
    }

    if (src != null) {
      src = src[currentPath];
    }

    dest[currentPath] = changeImmutable(dest[currentPath], src, path.slice(1), changeCallback);

    return dest;
  }

  var api = {};
  api.set = function set(dest, src, path, value) {
    return changeImmutable(dest, src, path, function (clonedObj, finalPath) {
      clonedObj[finalPath] = value;
      return clonedObj;
    });
  };

  api.update = function update(dest, src, path, updater) {
    return changeImmutable(dest, src, path, function (clonedObj, finalPath) {
      clonedObj[finalPath] = updater(clonedObj[finalPath]);
      return clonedObj;
    });
  };

  api.push = function push(dest, src, path /*, values */) {
    var values = Array.prototype.slice.call(arguments, 3);
    return changeImmutable(dest, src, path, function (clonedObj, finalPath) {
      if (!isArray(clonedObj[finalPath])) {
        clonedObj[finalPath] = values;
      } else {
        clonedObj[finalPath] = clonedObj[finalPath].concat(values);
      }
      return clonedObj;
    });
  };

  api.insert = function insert(dest, src, path, value, at) {
    at = ~~at;
    return changeImmutable(dest, src, path, function (clonedObj, finalPath) {
      var arr = clonedObj[finalPath];
      if (!isArray(arr)) {
        if (arr != null && typeof arr !== 'undefined') {
          throw new Error('Expected ' + path + 'to be an array. Instead got ' + (typeof path === 'undefined' ? 'undefined' : _typeof(path)));
        }
        arr = [];
      }

      var first = arr.slice(0, at);
      first.push(value);
      clonedObj[finalPath] = first.concat(arr.slice(at));
      return clonedObj;
    });
  };

  api.del = function del(dest, src, path, value, at) {
    return changeImmutable(dest, src, path, function (clonedObj, finalPath) {
      if (Array.isArray(clonedObj)) {
        if (clonedObj[finalPath] !== undefined) {
          clonedObj.splice(finalPath, 1);
        }
      } else {
        if (clonedObj.hasOwnProperty(finalPath)) {
          delete clonedObj[finalPath];
        }
      }
      return clonedObj;
    });
  };

  api.assign = function assign(dest, src, path, source) {
    return changeImmutable(dest, src, path, function (clonedObj, finalPath) {
      source = Object(source);
      var target = clone(clonedObj[finalPath], true);

      for (var key in source) {
        if (_hasOwnProperty.call(source, key)) {
          target[key] = source[key];
        }
      }

      clonedObj[finalPath] = target;
      return clonedObj;
    });
  };

  return Object.keys(api).reduce(function (objectPathImmutable, method) {
    objectPathImmutable[method] = api[method].bind(null, null);

    return objectPathImmutable;
  }, objectPathImmutable);
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhY2thZ2VzL3V0aWxzL2ltbXV0YWJsZS5lczYiXSwibmFtZXMiOlsicm9vdCIsImZhY3RvcnkiLCJtb2R1bGUiLCJleHBvcnRzIiwiZGVmaW5lIiwiYW1kIiwib2JqZWN0UGF0aCIsIl9oYXNPd25Qcm9wZXJ0eSIsIk9iamVjdCIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiaXNFbXB0eSIsInZhbHVlIiwiaXNBcnJheSIsImxlbmd0aCIsImlzU3RyaW5nIiwiaSIsImNhbGwiLCJpc051bWJlciIsIm9iaiIsIkFycmF5IiwiZ2V0S2V5Iiwia2V5IiwiaW50S2V5IiwicGFyc2VJbnQiLCJ0b1N0cmluZyIsIm9iamVjdFBhdGhJbW11dGFibGUiLCJzcmMiLCJkZXN0IiwiY29tbWl0dGVkIiwidHJhbnNhY3Rpb24iLCJrZXlzIiwiYXBpIiwicmVkdWNlIiwicHJveHkiLCJwcm9wIiwiYXJncyIsImNvbmNhdCIsInNsaWNlIiwiYXJndW1lbnRzIiwiRXJyb3IiLCJhcHBseSIsImNsb25lIiwiY3JlYXRlSWZFbXB0eSIsImFzc3VtZUFycmF5IiwicmVzIiwiY2hhbmdlSW1tdXRhYmxlIiwicGF0aCIsImNoYW5nZUNhbGxiYWNrIiwic3BsaXQiLCJtYXAiLCJjdXJyZW50UGF0aCIsInNldCIsImNsb25lZE9iaiIsImZpbmFsUGF0aCIsInVwZGF0ZSIsInVwZGF0ZXIiLCJwdXNoIiwidmFsdWVzIiwiaW5zZXJ0IiwiYXQiLCJhcnIiLCJmaXJzdCIsImRlbCIsInVuZGVmaW5lZCIsInNwbGljZSIsImFzc2lnbiIsInNvdXJjZSIsInRhcmdldCIsIm1ldGhvZCIsImJpbmQiXSwibWFwcGluZ3MiOiI7O0FBQUE7O0FBRUMsV0FBVUEsSUFBVixFQUFnQkMsT0FBaEIsRUFBeUI7QUFDeEI7O0FBRUE7QUFDQSxNQUFJLFFBQU9DLE1BQVAseUNBQU9BLE1BQVAsT0FBa0IsUUFBbEIsSUFBOEIsUUFBT0EsT0FBT0MsT0FBZCxNQUEwQixRQUE1RCxFQUFzRTtBQUNw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LEVBQXFCQyxTQUFyQixFQUFnQztBQUN0RWEsZUFBUzNELE9BQU8yRCxNQUFQLENBQVQ7QUFDQSxVQUFJQyxTQUFTMUIsTUFBTVcsVUFBVUMsU0FBVixDQUFOLEVBQTRCLElBQTVCLENBQWI7O0FBRUEsV0FBSyxJQUFJaEMsR0FBVCxJQUFnQjZDLE1BQWhCLEVBQXdCO0FBQ3RCLFlBQUk1RCxnQkFBZ0JVLElBQWhCLENBQXFCa0QsTUFBckIsRUFBNkI3QyxHQUE3QixDQUFKLEVBQXVDO0FBQ3JDOEMsaUJBQU85QyxHQUFQLElBQWM2QyxPQUFPN0MsR0FBUCxDQUFkO0FBQ0Q7QUFDRjs7QUFFRCtCLGdCQUFVQyxTQUFWLElBQXVCYyxNQUF2QjtBQUNBLGFBQU9mLFNBQVA7QUFDRCxLQVpNLENBQVA7QUFhRCxHQWREOztBQWdCQSxTQUFPN0MsT0FBT3VCLElBQVAsQ0FBWUMsR0FBWixFQUFpQkMsTUFBakIsQ0FBd0IsVUFBVVAsbUJBQVYsRUFBK0IyQyxNQUEvQixFQUF1QztBQUNwRTNDLHdCQUFvQjJDLE1BQXBCLElBQThCckMsSUFBSXFDLE1BQUosRUFBWUMsSUFBWixDQUFpQixJQUFqQixFQUF1QixJQUF2QixDQUE5Qjs7QUFFQSxXQUFPNUMsbUJBQVA7QUFDRCxHQUpNLEVBSUpBLG1CQUpJLENBQVA7QUFLRCxDQTVOQSxDQUFEIiwiZmlsZSI6InBhY2thZ2VzL3V0aWxzL2ltbXV0YWJsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGdsb2JhbHMgZGVmaW5lICovXG5cbihmdW5jdGlvbiAocm9vdCwgZmFjdG9yeSkge1xuICA7XG5cbiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQ6Y2FudCB0ZXN0ICovXG4gIGlmICh0eXBlb2YgbW9kdWxlID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgbW9kdWxlLmV4cG9ydHMgPT09ICdvYmplY3QnKSB7XG4gICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KCk7XG4gIH0gZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7XG4gICAgLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLlxuICAgIGRlZmluZShbXSwgZmFjdG9yeSk7XG4gIH0gZWxzZSB7XG4gICAgLy8gQnJvd3NlciBnbG9iYWxzXG4gICAgcm9vdC5vYmplY3RQYXRoID0gZmFjdG9yeSgpO1xuICB9XG59KHRoaXMsIGZ1bmN0aW9uICgpIHtcbiAgJ3VzZSBzdHJpY3QnXG4gIHZhciBfaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5XG5cbiAgZnVuY3Rpb24gaXNFbXB0eSAodmFsdWUpIHtcbiAgICBpZiAoIXZhbHVlKSB7XG4gICAgICByZXR1cm4gdHJ1ZVxuICAgIH1cbiAgICBpZiAoaXNBcnJheSh2YWx1ZSkgJiYgdmFsdWUubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gdHJ1ZVxuICAgIH0gZWxzZSBpZiAoIWlzU3RyaW5nKHZhbHVlKSkge1xuICAgICAgZm9yICh2YXIgaSBpbiB2YWx1ZSkge1xuICAgICAgICBpZiAoX2hhc093blByb3BlcnR5LmNhbGwodmFsdWUsIGkpKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuICAgIHJldHVybiBmYWxzZVxuICB9XG5cbiAgZnVuY3Rpb24gaXNOdW1iZXIgKHZhbHVlKSB7XG4gICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcidcbiAgfVxuXG4gIGZ1bmN0aW9uIGlzU3RyaW5nIChvYmopIHtcbiAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ3N0cmluZydcbiAgfVxuXG4gIGZ1bmN0aW9uIGlzQXJyYXkgKG9iaikge1xuICAgIHJldHVybiBBcnJheS5pc0FycmF5KG9iailcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEtleSAoa2V5KSB7XG4gICAgdmFyIGludEtleSA9IHBhcnNlSW50KGtleSlcbiAgICBpZiAoaW50S2V5LnRvU3RyaW5nKCkgPT09IGtleSkge1xuICAgICAgcmV0dXJuIGludEtleVxuICAgIH1cbiAgICByZXR1cm4ga2V5XG4gIH1cblxuICB2YXIgb2JqZWN0UGF0aEltbXV0YWJsZSA9IGZ1bmN0aW9uIChzcmMpIHtcbiAgICB2YXIgZGVzdCA9IHNyY1xuICAgIHZhciBjb21taXR0ZWQgPSBmYWxzZVxuXG4gICAgdmFyIHRyYW5zYWN0aW9uID0gT2JqZWN0LmtleXMoYXBpKS5yZWR1Y2UoZnVuY3Rpb24gKHByb3h5LCBwcm9wKSB7XG4gICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqL1xuICAgICAgaWYgKHR5cGVvZiBhcGlbcHJvcF0gPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgcHJveHlbcHJvcF0gPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgdmFyIGFyZ3MgPSBbZGVzdCwgc3JjXS5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSlcblxuICAgICAgICAgIGlmIChjb21taXR0ZWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGNhbGwgJyArIHByb3AgKyAnIGFmdGVyIGB2YWx1ZWAnKVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGRlc3QgPSBhcGlbcHJvcF0uYXBwbHkobnVsbCwgYXJncylcblxuICAgICAgICAgIHJldHVybiB0cmFuc2FjdGlvblxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBwcm94eVxuICAgIH0sIHt9KVxuXG4gICAgdHJhbnNhY3Rpb24udmFsdWUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICBjb21taXR0ZWQgPSB0cnVlXG4gICAgICByZXR1cm4gZGVzdFxuICAgIH1cblxuICAgIHJldHVybiB0cmFuc2FjdGlvblxuICB9XG5cbiAgZnVuY3Rpb24gY2xvbmUgKG9iaiwgY3JlYXRlSWZFbXB0eSwgYXNzdW1lQXJyYXkpIHtcbiAgICBpZiAob2JqID09IG51bGwpIHtcbiAgICAgIGlmIChjcmVhdGVJZkVtcHR5KSB7XG4gICAgICAgIGlmIChhc3N1bWVBcnJheSkge1xuICAgICAgICAgIHJldHVybiBbXVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHt9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBvYmpcbiAgICB9IGVsc2UgaWYgKGlzQXJyYXkob2JqKSkge1xuICAgICAgcmV0dXJuIG9iai5zbGljZSgpXG4gICAgfVxuXG4gICAgdmFyIHJlcyA9IHt9XG4gICAgZm9yICh2YXIga2V5IGluIG9iaikge1xuICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgIHJlc1trZXldID0gb2JqW2tleV1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcmVzXG4gIH1cblxuICBmdW5jdGlvbiBjaGFuZ2VJbW11dGFibGUgKGRlc3QsIHNyYywgcGF0aCwgY2hhbmdlQ2FsbGJhY2spIHtcbiAgICBpZiAoaXNOdW1iZXIocGF0aCkpIHtcbiAgICAgIHBhdGggPSBbcGF0aF1cbiAgICB9XG4gICAgaWYgKGlzRW1wdHkocGF0aCkpIHtcbiAgICAgIHJldHVybiBzcmNcbiAgICB9XG4gICAgaWYgKGlzU3RyaW5nKHBhdGgpKSB7XG4gICAgICByZXR1cm4gY2hhbmdlSW1tdXRhYmxlKGRlc3QsIHNyYywgcGF0aC5zcGxpdCgnLicpLm1hcChnZXRLZXkpLCBjaGFuZ2VDYWxsYmFjaylcbiAgICB9XG4gICAgdmFyIGN1cnJlbnRQYXRoID0gcGF0aFswXVxuXG4gICAgaWYgKCFkZXN0IHx8IGRlc3QgPT09IHNyYykge1xuICAgICAgZGVzdCA9IGNsb25lKHNyYywgdHJ1ZSwgaXNOdW1iZXIoY3VycmVudFBhdGgpKVxuICAgIH1cblxuICAgIGlmIChwYXRoLmxlbmd0aCA9PT0gMSkge1xuICAgICAgcmV0dXJuIGNoYW5nZUNhbGxiYWNrKGRlc3QsIGN1cnJlbnRQYXRoKVxuICAgIH1cblxuICAgIGlmIChzcmMgIT0gbnVsbCkge1xuICAgICAgc3JjID0gc3JjW2N1cnJlbnRQYXRoXVxuICAgIH1cblxuICAgIGRlc3RbY3VycmVudFBhdGhdID0gY2hhbmdlSW1tdXRhYmxlKGRlc3RbY3VycmVudFBhdGhdLCBzcmMsIHBhdGguc2xpY2UoMSksIGNoYW5nZUNhbGxiYWNrKVxuXG4gICAgcmV0dXJuIGRlc3RcbiAgfVxuXG4gIHZhciBhcGkgPSB7fVxuICBhcGkuc2V0ID0gZnVuY3Rpb24gc2V0IChkZXN0LCBzcmMsIHBhdGgsIHZhbHVlKSB7XG4gICAgcmV0dXJuIGNoYW5nZUltbXV0YWJsZShkZXN0LCBzcmMsIHBhdGgsIGZ1bmN0aW9uIChjbG9uZWRPYmosIGZpbmFsUGF0aCkge1xuICAgICAgY2xvbmVkT2JqW2ZpbmFsUGF0aF0gPSB2YWx1ZVxuICAgICAgcmV0dXJuIGNsb25lZE9ialxuICAgIH0pXG4gIH1cblxuICBhcGkudXBkYXRlID0gZnVuY3Rpb24gdXBkYXRlIChkZXN0LCBzcmMsIHBhdGgsIHVwZGF0ZXIpIHtcbiAgICByZXR1cm4gY2hhbmdlSW1tdXRhYmxlKGRlc3QsIHNyYywgcGF0aCwgZnVuY3Rpb24gKGNsb25lZE9iaiwgZmluYWxQYXRoKSB7XG4gICAgICBjbG9uZWRPYmpbZmluYWxQYXRoXSA9IHVwZGF0ZXIoY2xvbmVkT2JqW2ZpbmFsUGF0aF0pXG4gICAgICByZXR1cm4gY2xvbmVkT2JqXG4gICAgfSlcbiAgfVxuXG4gIGFwaS5wdXNoID0gZnVuY3Rpb24gcHVzaCAoZGVzdCwgc3JjLCBwYXRoIC8qLCB2YWx1ZXMgKi8pIHtcbiAgICB2YXIgdmFsdWVzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAzKVxuICAgIHJldHVybiBjaGFuZ2VJbW11dGFibGUoZGVzdCwgc3JjLCBwYXRoLCBmdW5jdGlvbiAoY2xvbmVkT2JqLCBmaW5hbFBhdGgpIHtcbiAgICAgIGlmICghaXNBcnJheShjbG9uZWRPYmpbZmluYWxQYXRoXSkpIHtcbiAgICAgICAgY2xvbmVkT2JqW2ZpbmFsUGF0aF0gPSB2YWx1ZXNcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNsb25lZE9ialtmaW5hbFBhdGhdID0gY2xvbmVkT2JqW2ZpbmFsUGF0aF0uY29uY2F0KHZhbHVlcylcbiAgICAgIH1cbiAgICAgIHJldHVybiBjbG9uZWRPYmpcbiAgICB9KVxuICB9XG5cbiAgYXBpLmluc2VydCA9IGZ1bmN0aW9uIGluc2VydCAoZGVzdCwgc3JjLCBwYXRoLCB2YWx1ZSwgYXQpIHtcbiAgICBhdCA9IH5+YXRcbiAgICByZXR1cm4gY2hhbmdlSW1tdXRhYmxlKGRlc3QsIHNyYywgcGF0aCwgZnVuY3Rpb24gKGNsb25lZE9iaiwgZmluYWxQYXRoKSB7XG4gICAgICB2YXIgYXJyID0gY2xvbmVkT2JqW2ZpbmFsUGF0aF1cbiAgICAgIGlmICghaXNBcnJheShhcnIpKSB7XG4gICAgICAgIGlmIChhcnIgIT0gbnVsbCAmJiB0eXBlb2YgYXJyICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRXhwZWN0ZWQgJyArIHBhdGggKyAndG8gYmUgYW4gYXJyYXkuIEluc3RlYWQgZ290ICcgKyB0eXBlb2YgcGF0aClcbiAgICAgICAgfVxuICAgICAgICBhcnIgPSBbXVxuICAgICAgfVxuXG4gICAgICB2YXIgZmlyc3QgPSBhcnIuc2xpY2UoMCwgYXQpXG4gICAgICBmaXJzdC5wdXNoKHZhbHVlKVxuICAgICAgY2xvbmVkT2JqW2ZpbmFsUGF0aF0gPSBmaXJzdC5jb25jYXQoYXJyLnNsaWNlKGF0KSlcbiAgICAgIHJldHVybiBjbG9uZWRPYmpcbiAgICB9KVxuICB9XG5cbiAgYXBpLmRlbCA9IGZ1bmN0aW9uIGRlbCAoZGVzdCwgc3JjLCBwYXRoLCB2YWx1ZSwgYXQpIHtcbiAgICByZXR1cm4gY2hhbmdlSW1tdXRhYmxlKGRlc3QsIHNyYywgcGF0aCwgZnVuY3Rpb24gKGNsb25lZE9iaiwgZmluYWxQYXRoKSB7XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShjbG9uZWRPYmopKSB7XG4gICAgICAgIGlmIChjbG9uZWRPYmpbZmluYWxQYXRoXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgY2xvbmVkT2JqLnNwbGljZShmaW5hbFBhdGgsIDEpXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChjbG9uZWRPYmouaGFzT3duUHJvcGVydHkoZmluYWxQYXRoKSkge1xuICAgICAgICAgIGRlbGV0ZSBjbG9uZWRPYmpbZmluYWxQYXRoXVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gY2xvbmVkT2JqXG4gICAgfSlcbiAgfVxuXG4gIGFwaS5hc3NpZ24gPSBmdW5jdGlvbiBhc3NpZ24gKGRlc3QsIHNyYywgcGF0aCwgc291cmNlKSB7XG4gICAgcmV0dXJuIGNoYW5nZUltbXV0YWJsZShkZXN0LCBzcmMsIHBhdGgsIGZ1bmN0aW9uIChjbG9uZWRPYmosIGZpbmFsUGF0aCkge1xuICAgICAgc291cmNlID0gT2JqZWN0KHNvdXJjZSlcbiAgICAgIHZhciB0YXJnZXQgPSBjbG9uZShjbG9uZWRPYmpbZmluYWxQYXRoXSwgdHJ1ZSlcblxuICAgICAgZm9yICh2YXIga2V5IGluIHNvdXJjZSkge1xuICAgICAgICBpZiAoX2hhc093blByb3BlcnR5LmNhbGwoc291cmNlLCBrZXkpKSB7XG4gICAgICAgICAgdGFyZ2V0W2tleV0gPSBzb3VyY2Vba2V5XVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGNsb25lZE9ialtmaW5hbFBhdGhdID0gdGFyZ2V0XG4gICAgICByZXR1cm4gY2xvbmVkT2JqXG4gICAgfSlcbiAgfVxuXG4gIHJldHVybiBPYmplY3Qua2V5cyhhcGkpLnJlZHVjZShmdW5jdGlvbiAob2JqZWN0UGF0aEltbXV0YWJsZSwgbWV0aG9kKSB7XG4gICAgb2JqZWN0UGF0aEltbXV0YWJsZVttZXRob2RdID0gYXBpW21ldGhvZF0uYmluZChudWxsLCBudWxsKVxuXG4gICAgcmV0dXJuIG9iamVjdFBhdGhJbW11dGFibGVcbiAgfSwgb2JqZWN0UGF0aEltbXV0YWJsZSlcbn0pKTtcbiJdfQ==
