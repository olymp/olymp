'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
var cloudinary = require('cloudinary');
var lodash = require('lodash');

var APP = process.env.APP;
var parseURI = exports.parseURI = function parseURI(uri) {
  var config = {};
  if (uri) {
    var split1 = uri.split('@');
    var split2 = split1[0].split('://');
    var split3 = split2[1].split(':');
    config.cloud_name = split1[1];
    config.api_key = split3[0];
    config.api_secret = split3[1];
    cloudinary.config(config);
  }

  return config;
};

var transform = exports.transform = function transform(image) {
  var newImage = {};
  Object.keys(image).forEach(function (key) {
    var originalKey = key;
    key = lodash.camelCase(key);
    if (key === 'publicId') {
      newImage.publicId = image.public_id;
      return;
    } else if (key === 'secureUrl') {
      return;
    } else if (key === 'url') {
      newImage.url = image.secure_url || image.url;
      return;
    } else if (key === 'colors') {
      return;
    } else if (key === 'context' && image[key].custom) {
      newImage.caption = image[key].custom.caption;
      newImage.source = image[key].custom.source;
      newImage.removed = image[key].custom.removed;
      return;
    } else if (key === 'predominant') {
      // Geht nur bei Single Pictures!!!
      newImage.colors = image.predominant.google.map(function (x) {
        return x[0];
      });
      return;
    } else if (key === 'pages') {
      // Geht nur bei Single Pictures und PDFs!!!
      newImage.pages = image.pages;
      return;
    }
    if (['id', 'format', 'version', 'resourceType', 'type', 'createdAt', 'height', 'width', 'bytes', 'url', 'caption', 'source', 'removed', 'pages', 'colors', 'tags'].indexOf(key) !== -1) {
      newImage[key] = image[key];
    }
  });
  return newImage;
};

var transformSignature = exports.transformSignature = function transformSignature(_ref, _ref2) {
  var cloud_name = _ref.cloud_name;
  var signature = _ref2.signature,
      api_key = _ref2.api_key,
      timestamp = _ref2.timestamp,
      folder = _ref2.folder;
  return {
    url: 'https://api.cloudinary.com/v1_1/' + cloud_name + '/auto/upload', // eslint-disable-line
    signature: signature,
    folder: folder,
    timestamp: timestamp,
    apiKey: api_key
  };
};

var getImages = exports.getImages = function getImages(config) {
  var images = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  var nextCursor = arguments[2];
  return new Promise(function (yay, nay) {
    cloudinary.api.resources(function (result) {
      if (result.error) {
        return nay(result.error);
      }

      // Aktuelle Bilder an Ausgabe-Array anh√§ngen (max 500)
      var results = result.resources && result.resources.length ? images.concat(result.resources.map(transform)) : [];

      // Falls noch weitere Bilder in Mediathek sind, diese auch laden
      if (result.next_cursor) {
        console.error('WARNING, MORE THAN 500 IMAGES!');
        return getImages(config, results, result.next_cursor).then(yay);
      }
      return yay(results);
    }, Object.assign({}, config, {
      tags: true,
      context: true,
      type: 'upload',
      colors: true,
      max_results: 500,
      next_cursor: nextCursor,
      prefix: APP && APP !== 'gzk' ? APP + '/' : ''
    }));
  });
};

var getImageById = exports.getImageById = function getImageById(config, id) {
  return new Promise(function (yay) {
    return cloudinary.api.resource(id, function (result) {
      yay(result);
    }, Object.assign({}, config, {
      tags: true,
      context: true,
      type: 'upload',
      colors: true,
      pages: true,
      prefix: APP && APP !== 'gzk' ? APP + '/' : ''
    }));
  }).then(transform);
};

var getSignedRequest = exports.getSignedRequest = function getSignedRequest(config) {
  return transformSignature(config, cloudinary.utils.sign_request({
    timestamp: Math.round(new Date().getTime() / 1000),
    folder: APP ? APP + '/' : null
  }, config));
};

var updateImage = exports.updateImage = function updateImage(id, tags, source, caption, config, removed) {
  var context = [];

  if (source) {
    context.push('source=' + source);
  }

  if (caption) {
    context.push('caption=' + caption);
  }

  if (removed) {
    context.push('removed=true');
  }

  return new Promise(function (yay) {
    cloudinary.api.update(id, function (result) {
      return yay(result);
    }, Object.assign({}, config, {
      prefix: APP ? APP + '/' : '',
      tags: (tags || []).join(','),
      context: context.join('|')
    }));
  }).then(transform);
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNtcy9jbG91ZGluYXJ5L3NlcnZlci9jbG91ZGluYXJ5LmVzNiJdLCJuYW1lcyI6WyJjbG91ZGluYXJ5IiwicmVxdWlyZSIsImxvZGFzaCIsIkFQUCIsInByb2Nlc3MiLCJlbnYiLCJwYXJzZVVSSSIsInVyaSIsImNvbmZpZyIsInNwbGl0MSIsInNwbGl0Iiwic3BsaXQyIiwic3BsaXQzIiwiY2xvdWRfbmFtZSIsImFwaV9rZXkiLCJhcGlfc2VjcmV0IiwidHJhbnNmb3JtIiwiaW1hZ2UiLCJuZXdJbWFnZSIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwia2V5Iiwib3JpZ2luYWxLZXkiLCJjYW1lbENhc2UiLCJwdWJsaWNJZCIsInB1YmxpY19pZCIsInVybCIsInNlY3VyZV91cmwiLCJjdXN0b20iLCJjYXB0aW9uIiwic291cmNlIiwicmVtb3ZlZCIsImNvbG9ycyIsInByZWRvbWluYW50IiwiZ29vZ2xlIiwibWFwIiwieCIsInBhZ2VzIiwiaW5kZXhPZiIsInRyYW5zZm9ybVNpZ25hdHVyZSIsInNpZ25hdHVyZSIsInRpbWVzdGFtcCIsImZvbGRlciIsImFwaUtleSIsImdldEltYWdlcyIsImltYWdlcyIsIm5leHRDdXJzb3IiLCJQcm9taXNlIiwieWF5IiwibmF5IiwiYXBpIiwicmVzb3VyY2VzIiwicmVzdWx0IiwiZXJyb3IiLCJyZXN1bHRzIiwibGVuZ3RoIiwiY29uY2F0IiwibmV4dF9jdXJzb3IiLCJjb25zb2xlIiwidGhlbiIsImFzc2lnbiIsInRhZ3MiLCJjb250ZXh0IiwidHlwZSIsIm1heF9yZXN1bHRzIiwicHJlZml4IiwiZ2V0SW1hZ2VCeUlkIiwiaWQiLCJyZXNvdXJjZSIsImdldFNpZ25lZFJlcXVlc3QiLCJ1dGlscyIsInNpZ25fcmVxdWVzdCIsIk1hdGgiLCJyb3VuZCIsIkRhdGUiLCJnZXRUaW1lIiwidXBkYXRlSW1hZ2UiLCJwdXNoIiwidXBkYXRlIiwiam9pbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxJQUFNQSxhQUFhQyxR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Q0FGRixDQUQ4QjtBQUFBLENBQXpCOztBQVlBLElBQU1xRSxvQ0FBYyxTQUFkQSxXQUFjLENBQUNULEVBQUQsRUFBS04sSUFBTCxFQUFXL0IsTUFBWCxFQUFtQkQsT0FBbkIsRUFBNEJ0QixNQUE1QixFQUFvQ3dCLE9BQXBDLEVBQWdEO0FBQ3pFLE1BQU0rQixVQUFVLEVBQWhCOztBQUVBLE1BQUloQyxNQUFKLEVBQVk7QUFDVmdDLFlBQVFlLElBQVIsYUFBdUIvQyxNQUF2QjtBQUNEOztBQUVELE1BQUlELE9BQUosRUFBYTtBQUNYaUMsWUFBUWUsSUFBUixjQUF3QmhELE9BQXhCO0FBQ0Q7O0FBRUQsTUFBSUUsT0FBSixFQUFhO0FBQ1grQixZQUFRZSxJQUFSLENBQWEsY0FBYjtBQUNEOztBQUVELFNBQU8sSUFBSTlCLE9BQUosQ0FBWSxVQUFDQyxHQUFELEVBQVM7QUFDMUJqRCxlQUFXbUQsR0FBWCxDQUFlNEIsTUFBZixDQUNFWCxFQURGLEVBRUU7QUFBQSxhQUFVbkIsSUFBSUksTUFBSixDQUFWO0FBQUEsS0FGRixFQUdFbEMsT0FBTzBDLE1BQVAsQ0FBYyxFQUFkLEVBQWtCckQsTUFBbEIsRUFBMEI7QUFDeEIwRCxjQUFRL0QsTUFBU0EsR0FBVCxTQUFrQixFQURGO0FBRXhCMkQsWUFBTSxDQUFDQSxRQUFRLEVBQVQsRUFBYWtCLElBQWIsQ0FBa0IsR0FBbEIsQ0FGa0I7QUFHeEJqQixlQUFTQSxRQUFRaUIsSUFBUixDQUFhLEdBQWI7QUFIZSxLQUExQixDQUhGO0FBU0QsR0FWTSxFQVVKcEIsSUFWSSxDQVVDNUMsU0FWRCxDQUFQO0FBV0QsQ0ExQk0iLCJmaWxlIjoiY21zL2Nsb3VkaW5hcnkvc2VydmVyL2Nsb3VkaW5hcnkuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBjbG91ZGluYXJ5ID0gcmVxdWlyZSgnY2xvdWRpbmFyeScpO1xuY29uc3QgbG9kYXNoID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5cbmNvbnN0IHsgQVBQIH0gPSBwcm9jZXNzLmVudjtcblxuZXhwb3J0IGNvbnN0IHBhcnNlVVJJID0gKHVyaSkgPT4ge1xuICBjb25zdCBjb25maWcgPSB7fTtcbiAgaWYgKHVyaSkge1xuICAgIGNvbnN0IHNwbGl0MSA9IHVyaS5zcGxpdCgnQCcpO1xuICAgIGNvbnN0IHNwbGl0MiA9IHNwbGl0MVswXS5zcGxpdCgnOi8vJyk7XG4gICAgY29uc3Qgc3BsaXQzID0gc3BsaXQyWzFdLnNwbGl0KCc6Jyk7XG4gICAgY29uZmlnLmNsb3VkX25hbWUgPSBzcGxpdDFbMV07XG4gICAgY29uZmlnLmFwaV9rZXkgPSBzcGxpdDNbMF07XG4gICAgY29uZmlnLmFwaV9zZWNyZXQgPSBzcGxpdDNbMV07XG4gICAgY2xvdWRpbmFyeS5jb25maWcoY29uZmlnKTtcbiAgfVxuXG4gIHJldHVybiBjb25maWc7XG59O1xuXG5leHBvcnQgY29uc3QgdHJhbnNmb3JtID0gKGltYWdlKSA9PiB7XG4gIGNvbnN0IG5ld0ltYWdlID0ge307XG4gIE9iamVjdC5rZXlzKGltYWdlKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICBjb25zdCBvcmlnaW5hbEtleSA9IGtleTtcbiAgICBrZXkgPSBsb2Rhc2guY2FtZWxDYXNlKGtleSk7XG4gICAgaWYgKGtleSA9PT0gJ3B1YmxpY0lkJykge1xuICAgICAgbmV3SW1hZ2UucHVibGljSWQgPSBpbWFnZS5wdWJsaWNfaWQ7XG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIGlmIChrZXkgPT09ICdzZWN1cmVVcmwnKSB7XG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIGlmIChrZXkgPT09ICd1cmwnKSB7XG4gICAgICBuZXdJbWFnZS51cmwgPSBpbWFnZS5zZWN1cmVfdXJsIHx8IGltYWdlLnVybDtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2UgaWYgKGtleSA9PT0gJ2NvbG9ycycpIHtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2UgaWYgKGtleSA9PT0gJ2NvbnRleHQnICYmIGltYWdlW2tleV0uY3VzdG9tKSB7XG4gICAgICBuZXdJbWFnZS5jYXB0aW9uID0gaW1hZ2Vba2V5XS5jdXN0b20uY2FwdGlvbjtcbiAgICAgIG5ld0ltYWdlLnNvdXJjZSA9IGltYWdlW2tleV0uY3VzdG9tLnNvdXJjZTtcbiAgICAgIG5ld0ltYWdlLnJlbW92ZWQgPSBpbWFnZVtrZXldLmN1c3RvbS5yZW1vdmVkO1xuICAgICAgcmV0dXJuO1xuICAgIH0gZWxzZSBpZiAoa2V5ID09PSAncHJlZG9taW5hbnQnKSB7XG4gICAgICAvLyBHZWh0IG51ciBiZWkgU2luZ2xlIFBpY3R1cmVzISEhXG4gICAgICBuZXdJbWFnZS5jb2xvcnMgPSBpbWFnZS5wcmVkb21pbmFudC5nb29nbGUubWFwKHggPT4geFswXSk7XG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIGlmIChrZXkgPT09ICdwYWdlcycpIHtcbiAgICAgIC8vIEdlaHQgbnVyIGJlaSBTaW5nbGUgUGljdHVyZXMgdW5kIFBERnMhISFcbiAgICAgIG5ld0ltYWdlLnBhZ2VzID0gaW1hZ2UucGFnZXM7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChcbiAgICAgIFtcbiAgICAgICAgJ2lkJyxcbiAgICAgICAgJ2Zvcm1hdCcsXG4gICAgICAgICd2ZXJzaW9uJyxcbiAgICAgICAgJ3Jlc291cmNlVHlwZScsXG4gICAgICAgICd0eXBlJyxcbiAgICAgICAgJ2NyZWF0ZWRBdCcsXG4gICAgICAgICdoZWlnaHQnLFxuICAgICAgICAnd2lkdGgnLFxuICAgICAgICAnYnl0ZXMnLFxuICAgICAgICAndXJsJyxcbiAgICAgICAgJ2NhcHRpb24nLFxuICAgICAgICAnc291cmNlJyxcbiAgICAgICAgJ3JlbW92ZWQnLFxuICAgICAgICAncGFnZXMnLFxuICAgICAgICAnY29sb3JzJyxcbiAgICAgICAgJ3RhZ3MnLFxuICAgICAgXS5pbmRleE9mKGtleSkgIT09IC0xXG4gICAgKSB7XG4gICAgICBuZXdJbWFnZVtrZXldID0gaW1hZ2Vba2V5XTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gbmV3SW1hZ2U7XG59O1xuXG5leHBvcnQgY29uc3QgdHJhbnNmb3JtU2lnbmF0dXJlID0gKHsgY2xvdWRfbmFtZSB9LCB7IHNpZ25hdHVyZSwgYXBpX2tleSwgdGltZXN0YW1wLCBmb2xkZXIgfSkgPT4gKHtcbiAgdXJsOiBgaHR0cHM6Ly9hcGkuY2xvdWRpbmFyeS5jb20vdjFfMS8ke2Nsb3VkX25hbWV9L2F1dG8vdXBsb2FkYCwgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICBzaWduYXR1cmUsXG4gIGZvbGRlcixcbiAgdGltZXN0YW1wLFxuICBhcGlLZXk6IGFwaV9rZXksXG59KTtcblxuZXhwb3J0IGNvbnN0IGdldEltYWdlcyA9IChjb25maWcsIGltYWdlcyA9IFtdLCBuZXh0Q3Vyc29yKSA9PlxuICBuZXcgUHJvbWlzZSgoeWF5LCBuYXkpID0+IHtcbiAgICBjbG91ZGluYXJ5LmFwaS5yZXNvdXJjZXMoXG4gICAgICAocmVzdWx0KSA9PiB7XG4gICAgICAgIGlmIChyZXN1bHQuZXJyb3IpIHtcbiAgICAgICAgICByZXR1cm4gbmF5KHJlc3VsdC5lcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBBa3R1ZWxsZSBCaWxkZXIgYW4gQXVzZ2FiZS1BcnJheSBhbmjDpG5nZW4gKG1heCA1MDApXG4gICAgICAgIGNvbnN0IHJlc3VsdHMgPVxuICAgICAgICAgIHJlc3VsdC5yZXNvdXJjZXMgJiYgcmVzdWx0LnJlc291cmNlcy5sZW5ndGhcbiAgICAgICAgICAgID8gaW1hZ2VzLmNvbmNhdChyZXN1bHQucmVzb3VyY2VzLm1hcCh0cmFuc2Zvcm0pKVxuICAgICAgICAgICAgOiBbXTtcblxuICAgICAgICAvLyBGYWxscyBub2NoIHdlaXRlcmUgQmlsZGVyIGluIE1lZGlhdGhlayBzaW5kLCBkaWVzZSBhdWNoIGxhZGVuXG4gICAgICAgIGlmIChyZXN1bHQubmV4dF9jdXJzb3IpIHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdXQVJOSU5HLCBNT1JFIFRIQU4gNTAwIElNQUdFUyEnKTtcbiAgICAgICAgICByZXR1cm4gZ2V0SW1hZ2VzKGNvbmZpZywgcmVzdWx0cywgcmVzdWx0Lm5leHRfY3Vyc29yKS50aGVuKHlheSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHlheShyZXN1bHRzKTtcbiAgICAgIH0sXG4gICAgICBPYmplY3QuYXNzaWduKHt9LCBjb25maWcsIHtcbiAgICAgICAgdGFnczogdHJ1ZSxcbiAgICAgICAgY29udGV4dDogdHJ1ZSxcbiAgICAgICAgdHlwZTogJ3VwbG9hZCcsXG4gICAgICAgIGNvbG9yczogdHJ1ZSxcbiAgICAgICAgbWF4X3Jlc3VsdHM6IDUwMCxcbiAgICAgICAgbmV4dF9jdXJzb3I6IG5leHRDdXJzb3IsXG4gICAgICAgIHByZWZpeDogQVBQICYmIEFQUCAhPT0gJ2d6aycgPyBgJHtBUFB9L2AgOiAnJyxcbiAgICAgIH0pLFxuICAgICk7XG4gIH0pO1xuXG5leHBvcnQgY29uc3QgZ2V0SW1hZ2VCeUlkID0gKGNvbmZpZywgaWQpID0+XG4gIG5ldyBQcm9taXNlKHlheSA9PlxuICAgIGNsb3VkaW5hcnkuYXBpLnJlc291cmNlKFxuICAgICAgaWQsXG4gICAgICAocmVzdWx0KSA9PiB7XG4gICAgICAgIHlheShyZXN1bHQpO1xuICAgICAgfSxcbiAgICAgIE9iamVjdC5hc3NpZ24oe30sIGNvbmZpZywge1xuICAgICAgICB0YWdzOiB0cnVlLFxuICAgICAgICBjb250ZXh0OiB0cnVlLFxuICAgICAgICB0eXBlOiAndXBsb2FkJyxcbiAgICAgICAgY29sb3JzOiB0cnVlLFxuICAgICAgICBwYWdlczogdHJ1ZSxcbiAgICAgICAgcHJlZml4OiBBUFAgJiYgQVBQICE9PSAnZ3prJyA/IGAke0FQUH0vYCA6ICcnLFxuICAgICAgfSksXG4gICAgKSxcbiAgKS50aGVuKHRyYW5zZm9ybSk7XG5cbmV4cG9ydCBjb25zdCBnZXRTaWduZWRSZXF1ZXN0ID0gY29uZmlnID0+XG4gIHRyYW5zZm9ybVNpZ25hdHVyZShcbiAgICBjb25maWcsXG4gICAgY2xvdWRpbmFyeS51dGlscy5zaWduX3JlcXVlc3QoXG4gICAgICB7XG4gICAgICAgIHRpbWVzdGFtcDogTWF0aC5yb3VuZChuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIDEwMDApLFxuICAgICAgICBmb2xkZXI6IEFQUCA/IGAke0FQUH0vYCA6IG51bGwsXG4gICAgICB9LFxuICAgICAgY29uZmlnLFxuICAgICksXG4gICk7XG5cbmV4cG9ydCBjb25zdCB1cGRhdGVJbWFnZSA9IChpZCwgdGFncywgc291cmNlLCBjYXB0aW9uLCBjb25maWcsIHJlbW92ZWQpID0+IHtcbiAgY29uc3QgY29udGV4dCA9IFtdO1xuXG4gIGlmIChzb3VyY2UpIHtcbiAgICBjb250ZXh0LnB1c2goYHNvdXJjZT0ke3NvdXJjZX1gKTtcbiAgfVxuXG4gIGlmIChjYXB0aW9uKSB7XG4gICAgY29udGV4dC5wdXNoKGBjYXB0aW9uPSR7Y2FwdGlvbn1gKTtcbiAgfVxuXG4gIGlmIChyZW1vdmVkKSB7XG4gICAgY29udGV4dC5wdXNoKCdyZW1vdmVkPXRydWUnKTtcbiAgfVxuXG4gIHJldHVybiBuZXcgUHJvbWlzZSgoeWF5KSA9PiB7XG4gICAgY2xvdWRpbmFyeS5hcGkudXBkYXRlKFxuICAgICAgaWQsXG4gICAgICByZXN1bHQgPT4geWF5KHJlc3VsdCksXG4gICAgICBPYmplY3QuYXNzaWduKHt9LCBjb25maWcsIHtcbiAgICAgICAgcHJlZml4OiBBUFAgPyBgJHtBUFB9L2AgOiAnJyxcbiAgICAgICAgdGFnczogKHRhZ3MgfHwgW10pLmpvaW4oJywnKSxcbiAgICAgICAgY29udGV4dDogY29udGV4dC5qb2luKCd8JyksXG4gICAgICB9KSxcbiAgICApO1xuICB9KS50aGVuKHRyYW5zZm9ybSk7XG59O1xuIl19
