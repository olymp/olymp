import { Text, Block, Inline } from 'slate';
import hasBlock from './utils/has-block';

var addBlock = function addBlock(value, node, schema, parentKey) {
  var index = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : 0;
  var transform = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : value.change();
  var _node = node,
      defaultNodes = _node.defaultNodes,
      defaultText = _node.defaultText;
  var _node2 = node,
      type = _node2.type,
      initNode = _node2.initNode;

  var defaultNode = 'paragraph';

  var document = value.document,
      blocks = value.blocks;

  // Handle everything but list buttons.

  if (type !== 'bulleted-list' && type !== 'numbered-list') {
    var isActive = hasBlock(value, type);
    var isList = hasBlock(value, 'bulleted-list-item') || hasBlock(value, 'numbered-list-item');

    if (isList) {
      transform = transform.setBlock(isActive ? defaultNode : type).unwrapBlock('bulleted-list').unwrapBlock('numbered-list');
    } else {
      if (initNode) {
        node = initNode(node, { value: value, schema: schema, parentKey: parentKey, index: index, transform: transform });
      }
      var block = createBlock(node);

      if (defaultNodes && typeof defaultNodes === 'function') {
        defaultNodes = defaultNodes({ value: value, node: node, schema: schema, parentKey: parentKey, index: index, transform: transform });
      } else if (!defaultNodes && !block.isVoid) {
        defaultNodes = [Text.create(defaultText)];
      }

      if (block && block.kind === 'block') {
        transform = parentKey ? transform.insertNodeByKey(parentKey, index, block) : transform.insertBlock(block);
      } else if (block) {
        transform = parentKey ? transform.insertNodeByKey(parentKey, index, block) : transform.insertInline(block);
      }

      if (defaultNodes) {
        defaultNodes.forEach(function (item, index) {
          if (typeof item === 'string' && schema.nodes[item]) {
            transform = addBlock(value, schema.nodes[item].slate, schema, block.key, index, transform);
          } else if (item.type && schema.nodes[item.type]) {
            transform = addBlock(value, item, schema, block.key, index, transform);
          } else if (Text.isText(item) || Block.isBlock(item) || Inline.isInline(item)) {
            transform = transform.insertNodeByKey(block.key, index, item);
          } else {
            transform = block.kind === 'block' ? transform.insertNodeByKey(block.key, index, Block.create(item)) : transform.insertNodeByKey(block.key, index, Inline.create(item));
          }
        });
      }
    }
  } else {
    // Handle the extra wrapping required for list buttons.
    var _isList = hasBlock(value, 'bulleted-list-item') || hasBlock(value, 'numbered-list-item');
    console.log(_isList);
    var isType = blocks.some(function (block) {
      return !!document.getClosest(block, function (parent) {
        return parent.type === type;
      });
    });

    if (_isList && isType) {
      transform = transform.setBlock(defaultNode).unwrapBlock('bulleted-list').unwrapBlock('numbered-list');
    } else if (_isList) {
      transform = transform.unwrapBlock(type === 'bulleted-list' ? 'bulleted-list' : 'numbered-list').wrapBlock(type);
    } else {
      transform = transform.setBlock(type === 'bulleted-list' ? 'bulleted-list-item' : 'numbered-list-item').wrapBlock(type);
    }
  }

  return transform;
};

var createBlock = function createBlock(block) {
  var type = block.type;
  var isVoid = block.isVoid,
      key = block.key,
      kind = block.kind,
      data = block.data;

  if (!type) {
    type = key;
  }
  if (kind === 'inline' || !kind && isVoid) {
    return Inline.create({
      type: type,
      isVoid: isVoid,
      kind: kind,
      data: data || {}
    });
  }
  return Block.create({
    type: type,
    isVoid: isVoid,
    kind: kind,
    data: data || {}
  });
};
export default addBlock;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhY2thZ2VzL3NsYXRlL2FkZC1ibG9jay5lczYiXSwibmFtZXMiOlsiVGV4dCIsIkJsb2NrIiwiSW5saW5lIiwiaGFzQmxvY2siLCJhZGRCbG9jayIsInZhbHVlIiwibm9kZSIsInNjaGVtYSIsInBhcmVudEtleSIsImluZGV4IiwidHJhbnNmb3JtIiwiY2hhbmdlIiwiZGVmYXVsdE5vZGVzIiwiZGVmYXVsdFRleHQiLCJ0eXBlIiwiaW5pdE5vZGUiLCJkZWZhdWx0Tm9kZSIsImRvY3VtZW50IiwiYmxvY2tzIiwiaXNBY3RpdmUiLCJpc0xpc3QiLCJzZXRCbG9jayIsInVud3JhcEJsb2NrIiwiYmxvY2siLCJjcmVhdGVCbG9jayIsImlzVm9pZCIsImNyZWF0ZSIsImtpbmQiLCJpbnNlcnROb2RlQnlLZXkiLCJpbnNlcnRCbG9jayIsImluc2VydElubGluZSIsImZvckVhY2giLCJpdGVtIiwibm9kZXMiLCJzbGF0ZSIsImtleSIsImlzVGV4dCIsImlzQmxvY2siLCJpc0lubGluZSIsImNvbnNvbGUiLCJsb2ciLCJpc1R5cGUiLCJzb21lIiwiZ2V0Q2xvc2VzdCIsInBhcmVudCIsIndyYXBCbG9jayIsImRhdGEiXSwibWFwcGluZ3MiOiJBQUFBLFNBQVNBLElBQVQsRUFBZUMsS0FBZixFQUFzQkMsTUFBdEIsUUFBb0MsT0FBcEM7QUFDQSxPQUFPQyxRQUFQLE1BQXFCLG1CQUFyQjs7QUFFQSxJQUFNQyxXQUFXLFNBQVhBLFFBQVcsQ0FBQ0MsS0FBRCxFQUFRQyxJQUFSLEVBQWNDLE1BQWQsRUFBc0JDLFNBQXRCLEVBQTJFO0FBQUEsTUFBMUNDLEtBQTBDLHVFQUFsQyxDQUFrQztBQUFBLE1BQS9CQyxTQUErQix1RUFBbkJMLE1BQU1NLE1BQU4sRUFBbUI7QUFBQSxjQUN0REwsSUFEc0Q7QUFBQSxNQUNwRk0sWUFEb0YsU0FDcEZBLFlBRG9GO0FBQUEsTUFDdEVDLFdBRHNFLFNBQ3RFQSxXQURzRTtBQUFBLGVBRS9EUCxJQUYrRDtBQUFBLE1BRWxGUSxJQUZr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Q0xKLGtCQUFZQSxVQUNUVyxRQURTLENBQ0FQLFNBQVMsZUFBVCxHQUEyQixvQkFBM0IsR0FBa0Qsb0JBRGxELEVBRVQrQixTQUZTLENBRUMvQixJQUZELENBQVo7QUFHRDtBQUNGOztBQUVELFNBQU9KLFNBQVA7QUFDRCxDQXhGRDs7QUEwRkEsSUFBTWMsY0FBYyxTQUFkQSxXQUFjLENBQUNELEtBQUQsRUFBVztBQUFBLE1BQ3ZCVCxJQUR1QixHQUNkUyxLQURjLENBQ3ZCVCxJQUR1QjtBQUFBLE1BRXJCVyxNQUZxQixHQUVPRixLQUZQLENBRXJCRSxNQUZxQjtBQUFBLE1BRWJVLEdBRmEsR0FFT1osS0FGUCxDQUViWSxHQUZhO0FBQUEsTUFFUlIsSUFGUSxHQUVPSixLQUZQLENBRVJJLElBRlE7QUFBQSxNQUVGbUIsSUFGRSxHQUVPdkIsS0FGUCxDQUVGdUIsSUFGRTs7QUFHN0IsTUFBSSxDQUFDaEMsSUFBTCxFQUFXO0FBQ1RBLFdBQU9xQixHQUFQO0FBQ0Q7QUFDRCxNQUFJUixTQUFTLFFBQVQsSUFBc0IsQ0FBQ0EsSUFBRCxJQUFTRixNQUFuQyxFQUE0QztBQUMxQyxXQUFPdkIsT0FBT3dCLE1BQVAsQ0FBYztBQUNuQlosZ0JBRG1CO0FBRW5CVyxvQkFGbUI7QUFHbkJFLGdCQUhtQjtBQUluQm1CLFlBQU1BLFFBQVE7QUFKSyxLQUFkLENBQVA7QUFNRDtBQUNELFNBQU83QyxNQUFNeUIsTUFBTixDQUFhO0FBQ2xCWixjQURrQjtBQUVsQlcsa0JBRmtCO0FBR2xCRSxjQUhrQjtBQUlsQm1CLFVBQU1BLFFBQVE7QUFKSSxHQUFiLENBQVA7QUFNRCxDQXBCRDtBQXFCQSxlQUFlMUMsUUFBZiIsImZpbGUiOiJwYWNrYWdlcy9zbGF0ZS9hZGQtYmxvY2suanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXh0LCBCbG9jaywgSW5saW5lIH0gZnJvbSAnc2xhdGUnO1xuaW1wb3J0IGhhc0Jsb2NrIGZyb20gJy4vdXRpbHMvaGFzLWJsb2NrJztcblxuY29uc3QgYWRkQmxvY2sgPSAodmFsdWUsIG5vZGUsIHNjaGVtYSwgcGFyZW50S2V5LCBpbmRleCA9IDAsIHRyYW5zZm9ybSA9IHZhbHVlLmNoYW5nZSgpKSA9PiB7XG4gIGxldCB7IGRlZmF1bHROb2RlcywgZGVmYXVsdFRleHQgfSA9IG5vZGU7XG4gIGNvbnN0IHsgdHlwZSwgaW5pdE5vZGUgfSA9IG5vZGU7XG4gIGNvbnN0IGRlZmF1bHROb2RlID0gJ3BhcmFncmFwaCc7XG5cbiAgY29uc3QgeyBkb2N1bWVudCwgYmxvY2tzIH0gPSB2YWx1ZTtcblxuICAvLyBIYW5kbGUgZXZlcnl0aGluZyBidXQgbGlzdCBidXR0b25zLlxuICBpZiAodHlwZSAhPT0gJ2J1bGxldGVkLWxpc3QnICYmIHR5cGUgIT09ICdudW1iZXJlZC1saXN0Jykge1xuICAgIGNvbnN0IGlzQWN0aXZlID0gaGFzQmxvY2sodmFsdWUsIHR5cGUpO1xuICAgIGNvbnN0IGlzTGlzdCA9IGhhc0Jsb2NrKHZhbHVlLCAnYnVsbGV0ZWQtbGlzdC1pdGVtJykgfHwgaGFzQmxvY2sodmFsdWUsICdudW1iZXJlZC1saXN0LWl0ZW0nKTtcblxuICAgIGlmIChpc0xpc3QpIHtcbiAgICAgIHRyYW5zZm9ybSA9IHRyYW5zZm9ybVxuICAgICAgICAuc2V0QmxvY2soaXNBY3RpdmUgPyBkZWZhdWx0Tm9kZSA6IHR5cGUpXG4gICAgICAgIC51bndyYXBCbG9jaygnYnVsbGV0ZWQtbGlzdCcpXG4gICAgICAgIC51bndyYXBCbG9jaygnbnVtYmVyZWQtbGlzdCcpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoaW5pdE5vZGUpIHtcbiAgICAgICAgbm9kZSA9IGluaXROb2RlKG5vZGUsIHsgdmFsdWUsIHNjaGVtYSwgcGFyZW50S2V5LCBpbmRleCwgdHJhbnNmb3JtIH0pO1xuICAgICAgfVxuICAgICAgY29uc3QgYmxvY2sgPSBjcmVhdGVCbG9jayhub2RlKTtcblxuICAgICAgaWYgKGRlZmF1bHROb2RlcyAmJiB0eXBlb2YgZGVmYXVsdE5vZGVzID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGRlZmF1bHROb2RlcyA9IGRlZmF1bHROb2Rlcyh7IHZhbHVlLCBub2RlLCBzY2hlbWEsIHBhcmVudEtleSwgaW5kZXgsIHRyYW5zZm9ybSB9KTtcbiAgICAgIH0gZWxzZSBpZiAoIWRlZmF1bHROb2RlcyAmJiAhYmxvY2suaXNWb2lkKSB7XG4gICAgICAgIGRlZmF1bHROb2RlcyA9IFtUZXh0LmNyZWF0ZShkZWZhdWx0VGV4dCldO1xuICAgICAgfVxuXG4gICAgICBpZiAoYmxvY2sgJiYgYmxvY2sua2luZCA9PT0gJ2Jsb2NrJykge1xuICAgICAgICB0cmFuc2Zvcm0gPSBwYXJlbnRLZXlcbiAgICAgICAgICA/IHRyYW5zZm9ybS5pbnNlcnROb2RlQnlLZXkocGFyZW50S2V5LCBpbmRleCwgYmxvY2spXG4gICAgICAgICAgOiB0cmFuc2Zvcm0uaW5zZXJ0QmxvY2soYmxvY2spO1xuICAgICAgfSBlbHNlIGlmIChibG9jaykge1xuICAgICAgICB0cmFuc2Zvcm0gPSBwYXJlbnRLZXlcbiAgICAgICAgICA/IHRyYW5zZm9ybS5pbnNlcnROb2RlQnlLZXkocGFyZW50S2V5LCBpbmRleCwgYmxvY2spXG4gICAgICAgICAgOiB0cmFuc2Zvcm0uaW5zZXJ0SW5saW5lKGJsb2NrKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGRlZmF1bHROb2Rlcykge1xuICAgICAgICBkZWZhdWx0Tm9kZXMuZm9yRWFjaCgoaXRlbSwgaW5kZXgpID0+IHtcbiAgICAgICAgICBpZiAodHlwZW9mIGl0ZW0gPT09ICdzdHJpbmcnICYmIHNjaGVtYS5ub2Rlc1tpdGVtXSkge1xuICAgICAgICAgICAgdHJhbnNmb3JtID0gYWRkQmxvY2soXG4gICAgICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgICAgICBzY2hlbWEubm9kZXNbaXRlbV0uc2xhdGUsXG4gICAgICAgICAgICAgIHNjaGVtYSxcbiAgICAgICAgICAgICAgYmxvY2sua2V5LFxuICAgICAgICAgICAgICBpbmRleCxcbiAgICAgICAgICAgICAgdHJhbnNmb3JtLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGVsc2UgaWYgKGl0ZW0udHlwZSAmJiBzY2hlbWEubm9kZXNbaXRlbS50eXBlXSkge1xuICAgICAgICAgICAgdHJhbnNmb3JtID0gYWRkQmxvY2sodmFsdWUsIGl0ZW0sIHNjaGVtYSwgYmxvY2sua2V5LCBpbmRleCwgdHJhbnNmb3JtKTtcbiAgICAgICAgICB9IGVsc2UgaWYgKFRleHQuaXNUZXh0KGl0ZW0pIHx8IEJsb2NrLmlzQmxvY2soaXRlbSkgfHwgSW5saW5lLmlzSW5saW5lKGl0ZW0pKSB7XG4gICAgICAgICAgICB0cmFuc2Zvcm0gPSB0cmFuc2Zvcm0uaW5zZXJ0Tm9kZUJ5S2V5KGJsb2NrLmtleSwgaW5kZXgsIGl0ZW0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0cmFuc2Zvcm0gPVxuICAgICAgICAgICAgICBibG9jay5raW5kID09PSAnYmxvY2snXG4gICAgICAgICAgICAgICAgPyB0cmFuc2Zvcm0uaW5zZXJ0Tm9kZUJ5S2V5KGJsb2NrLmtleSwgaW5kZXgsIEJsb2NrLmNyZWF0ZShpdGVtKSlcbiAgICAgICAgICAgICAgICA6IHRyYW5zZm9ybS5pbnNlcnROb2RlQnlLZXkoYmxvY2sua2V5LCBpbmRleCwgSW5saW5lLmNyZWF0ZShpdGVtKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgLy8gSGFuZGxlIHRoZSBleHRyYSB3cmFwcGluZyByZXF1aXJlZCBmb3IgbGlzdCBidXR0b25zLlxuICAgIGNvbnN0IGlzTGlzdCA9IGhhc0Jsb2NrKHZhbHVlLCAnYnVsbGV0ZWQtbGlzdC1pdGVtJykgfHwgaGFzQmxvY2sodmFsdWUsICdudW1iZXJlZC1saXN0LWl0ZW0nKTtcbiAgICBjb25zb2xlLmxvZyhpc0xpc3QpO1xuICAgIGNvbnN0IGlzVHlwZSA9IGJsb2Nrcy5zb21lKFxuICAgICAgYmxvY2sgPT4gISFkb2N1bWVudC5nZXRDbG9zZXN0KGJsb2NrLCBwYXJlbnQgPT4gcGFyZW50LnR5cGUgPT09IHR5cGUpLFxuICAgICk7XG5cbiAgICBpZiAoaXNMaXN0ICYmIGlzVHlwZSkge1xuICAgICAgdHJhbnNmb3JtID0gdHJhbnNmb3JtXG4gICAgICAgIC5zZXRCbG9jayhkZWZhdWx0Tm9kZSlcbiAgICAgICAgLnVud3JhcEJsb2NrKCdidWxsZXRlZC1saXN0JylcbiAgICAgICAgLnVud3JhcEJsb2NrKCdudW1iZXJlZC1saXN0Jyk7XG4gICAgfSBlbHNlIGlmIChpc0xpc3QpIHtcbiAgICAgIHRyYW5zZm9ybSA9IHRyYW5zZm9ybVxuICAgICAgICAudW53cmFwQmxvY2sodHlwZSA9PT0gJ2J1bGxldGVkLWxpc3QnID8gJ2J1bGxldGVkLWxpc3QnIDogJ251bWJlcmVkLWxpc3QnKVxuICAgICAgICAud3JhcEJsb2NrKHR5cGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0cmFuc2Zvcm0gPSB0cmFuc2Zvcm1cbiAgICAgICAgLnNldEJsb2NrKHR5cGUgPT09ICdidWxsZXRlZC1saXN0JyA/ICdidWxsZXRlZC1saXN0LWl0ZW0nIDogJ251bWJlcmVkLWxpc3QtaXRlbScpXG4gICAgICAgIC53cmFwQmxvY2sodHlwZSk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHRyYW5zZm9ybTtcbn07XG5cbmNvbnN0IGNyZWF0ZUJsb2NrID0gKGJsb2NrKSA9PiB7XG4gIGxldCB7IHR5cGUgfSA9IGJsb2NrO1xuICBjb25zdCB7IGlzVm9pZCwga2V5LCBraW5kLCBkYXRhIH0gPSBibG9jaztcbiAgaWYgKCF0eXBlKSB7XG4gICAgdHlwZSA9IGtleTtcbiAgfVxuICBpZiAoa2luZCA9PT0gJ2lubGluZScgfHwgKCFraW5kICYmIGlzVm9pZCkpIHtcbiAgICByZXR1cm4gSW5saW5lLmNyZWF0ZSh7XG4gICAgICB0eXBlLFxuICAgICAgaXNWb2lkLFxuICAgICAga2luZCxcbiAgICAgIGRhdGE6IGRhdGEgfHwge30sXG4gICAgfSk7XG4gIH1cbiAgcmV0dXJuIEJsb2NrLmNyZWF0ZSh7XG4gICAgdHlwZSxcbiAgICBpc1ZvaWQsXG4gICAga2luZCxcbiAgICBkYXRhOiBkYXRhIHx8IHt9LFxuICB9KTtcbn07XG5leHBvcnQgZGVmYXVsdCBhZGRCbG9jaztcbiJdfQ==
