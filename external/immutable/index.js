var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

/* globals define */
// https://github.com/mariocasciaro/object-path-immutable
(function (root, factory) {
  ;

  /* istanbul ignore next:cant test */
  if ((typeof module === 'undefined' ? 'undefined' : _typeof(module)) === 'object' && _typeof(module.exports) === 'object') {
    module.exports = factory();
  } else if (typeof define === 'function' && define.amd) {
    // AMD. Register as an anonymous module.
    define([], factory);
  } else {
    // Browser globals
    root.objectPath = factory();
  }
})(this, function () {
  'use strict';

  var _hasOwnProperty = Object.prototype.hasOwnProperty;

  function isEmpty(value) {
    if (!value) {
      return true;
    }
    if (isArray(value) && value.length === 0) {
      return true;
    } else if (!isString(value)) {
      for (var i in value) {
        if (_hasOwnProperty.call(value, i)) {
          return false;
        }
      }
      return true;
    }
    return false;
  }

  function isNumber(value) {
    return typeof value === 'number';
  }

  function isString(obj) {
    return typeof obj === 'string';
  }

  function isArray(obj) {
    return Array.isArray(obj);
  }

  function getKey(key) {
    var intKey = parseInt(key);
    if (intKey.toString() === key) {
      return intKey;
    }
    return key;
  }

  var objectPathImmutable = function objectPathImmutable(src) {
    var dest = src;
    var committed = false;

    var transaction = Object.keys(api).reduce(function (proxy, prop) {
      /* istanbul ignore else */
      if (typeof api[prop] === 'function') {
        proxy[prop] = function () {
          var args = [dest, src].concat(Array.prototype.slice.call(arguments));

          if (committed) {
            throw new Error('Cannot call ' + prop + ' after `value`');
          }

          dest = api[prop].apply(null, args);

          return transaction;
        };
      }

      return proxy;
    }, {});

    transaction.value = function () {
      committed = true;
      return dest;
    };

    return transaction;
  };

  function clone(obj, createIfEmpty, assumeArray) {
    if (obj == null) {
      if (createIfEmpty) {
        if (assumeArray) {
          return [];
        }

        return {};
      }

      return obj;
    } else if (isArray(obj)) {
      return obj.slice();
    }

    var res = {};
    for (var key in obj) {
      if (obj.hasOwnProperty(key)) {
        res[key] = obj[key];
      }
    }

    return res;
  }

  function changeImmutable(dest, src, path, changeCallback) {
    if (isNumber(path)) {
      path = [path];
    }
    if (isEmpty(path)) {
      return src;
    }
    if (isString(path)) {
      return changeImmutable(dest, src, path.split('.').map(getKey), changeCallback);
    }
    var currentPath = path[0];

    if (!dest || dest === src) {
      dest = clone(src, true, isNumber(currentPath));
    }

    if (path.length === 1) {
      return changeCallback(dest, currentPath);
    }

    if (src != null) {
      src = src[currentPath];
    }

    dest[currentPath] = changeImmutable(dest[currentPath], src, path.slice(1), changeCallback);

    return dest;
  }

  var api = {};
  api.set = function set(dest, src, path, value) {
    return changeImmutable(dest, src, path, function (clonedObj, finalPath) {
      clonedObj[finalPath] = value;
      return clonedObj;
    });
  };

  api.push = function push(dest, src, path /*, values */) {
    var values = Array.prototype.slice.call(arguments, 3);
    return changeImmutable(dest, src, path, function (clonedObj, finalPath) {
      if (!isArray(clonedObj[finalPath])) {
        clonedObj[finalPath] = values;
      } else {
        clonedObj[finalPath] = clonedObj[finalPath].concat(values);
      }
      return clonedObj;
    });
  };

  api.insert = function insert(dest, src, path, value, at) {
    at = ~~at;
    return changeImmutable(dest, src, path, function (clonedObj, finalPath) {
      var arr = clonedObj[finalPath];
      if (!isArray(arr)) {
        if (arr != null && typeof arr !== 'undefined') {
          throw new Error('Expected ' + path + 'to be an array. Instead got ' + (typeof path === 'undefined' ? 'undefined' : _typeof(path)));
        }
        arr = [];
      }

      var first = arr.slice(0, at);
      first.push(value);
      clonedObj[finalPath] = first.concat(arr.slice(at));
      return clonedObj;
    });
  };

  api.del = function del(dest, src, path, value, at) {
    return changeImmutable(dest, src, path, function (clonedObj, finalPath) {
      if (Array.isArray(clonedObj)) {
        if (clonedObj[finalPath] !== undefined) {
          clonedObj.splice(finalPath, 1);
        }
      } else {
        if (clonedObj.hasOwnProperty(finalPath)) {
          delete clonedObj[finalPath];
        }
      }
      return clonedObj;
    });
  };

  api.assign = function assign(dest, src, path, source) {
    return changeImmutable(dest, src, path, function (clonedObj, finalPath) {
      source = Object(source);
      var target = clone(clonedObj[finalPath], true);

      for (var key in source) {
        if (_hasOwnProperty.call(source, key)) {
          target[key] = source[key];
        }
      }

      clonedObj[finalPath] = target;
      return clonedObj;
    });
  };

  return Object.keys(api).reduce(function (objectPathImmutable, method) {
    objectPathImmutable[method] = api[method].bind(null, null);

    return objectPathImmutable;
  }, objectPathImmutable);
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImV4dGVybmFsL2ltbXV0YWJsZS9pbmRleC5lczYiXSwibmFtZXMiOlsicm9vdCIsImZhY3RvcnkiLCJtb2R1bGUiLCJleHBvcnRzIiwiZGVmaW5lIiwiYW1kIiwib2JqZWN0UGF0aCIsIl9oYXNPd25Qcm9wZXJ0eSIsIk9iamVjdCIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiaXNFbXB0eSIsInZhbHVlIiwiaXNBcnJheSIsImxlbmd0aCIsImlzU3RyaW5nIiwiaSIsImNhbGwiLCJpc051bWJlciIsIm9iaiIsIkFycmF5IiwiZ2V0S2V5Iiwia2V5IiwiaW50S2V5IiwicGFyc2VJbnQiLCJ0b1N0cmluZyIsIm9iamVjdFBhdGhJbW11dGFibGUiLCJzcmMiLCJkZXN0IiwiY29tbWl0dGVkIiwidHJhbnNhY3Rpb24iLCJrZXlzIiwiYXBpIiwicmVkdWNlIiwicHJveHkiLCJwcm9wIiwiYXJncyIsImNvbmNhdCIsInNsaWNlIiwiYXJndW1lbnRzIiwiRXJyb3IiLCJhcHBseSIsImNsb25lIiwiY3JlYXRlSWZFbXB0eSIsImFzc3VtZUFycmF5IiwicmVzIiwiY2hhbmdlSW1tdXRhYmxlIiwicGF0aCIsImNoYW5nZUNhbGxiYWNrIiwic3BsaXQiLCJtYXAiLCJjdXJyZW50UGF0aCIsInNldCIsImNsb25lZE9iaiIsImZpbmFsUGF0aCIsInB1c2giLCJ2YWx1ZXMiLCJpbnNlcnQiLCJhdCIsImFyciIsImZpcnN0IiwiZGVsIiwidW5kZWZpbmVkIiwic3BsaWNlIiwiYXNzaWduIiwic291cmNlIiwidGFyZ2V0IiwibWV0aG9kIiwiYmluZCJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0MsV0FBVUEsSUFBVixFQUFnQkMsT0FBaEIsRUFBeUI7QUFDeEI7O0FBRUE7QUFDQSxNQUFJLFFBQU9DLE1BQVAseUNBQU9BLE1BQVAsT0FBa0IsUUFBbEIsSUFBOEIsUUFBT0EsT0FBT0MsT0FBZCxNQUEwQixRQUE1RCxFQUFzRTtBQUNwRUQsV0FBT0MsT0FBUCxH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QlksTUFBdkI7QUFDQSxhQUFPYixTQUFQO0FBQ0QsS0FaTSxDQUFQO0FBYUQsR0FkRDs7QUFnQkEsU0FBTzdDLE9BQU91QixJQUFQLENBQVlDLEdBQVosRUFBaUJDLE1BQWpCLENBQXdCLFVBQVVQLG1CQUFWLEVBQStCeUMsTUFBL0IsRUFBdUM7QUFDcEV6Qyx3QkFBb0J5QyxNQUFwQixJQUE4Qm5DLElBQUltQyxNQUFKLEVBQVlDLElBQVosQ0FBaUIsSUFBakIsRUFBdUIsSUFBdkIsQ0FBOUI7O0FBRUEsV0FBTzFDLG1CQUFQO0FBQ0QsR0FKTSxFQUlKQSxtQkFKSSxDQUFQO0FBS0QsQ0FyTkEsQ0FBRCIsImZpbGUiOiJleHRlcm5hbC9pbW11dGFibGUvaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBnbG9iYWxzIGRlZmluZSAqL1xuLy8gaHR0cHM6Ly9naXRodWIuY29tL21hcmlvY2FzY2lhcm8vb2JqZWN0LXBhdGgtaW1tdXRhYmxlXG4oZnVuY3Rpb24gKHJvb3QsIGZhY3RvcnkpIHtcbiAgO1xuXG4gIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0OmNhbnQgdGVzdCAqL1xuICBpZiAodHlwZW9mIG1vZHVsZSA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZS5leHBvcnRzID09PSAnb2JqZWN0Jykge1xuICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpO1xuICB9IGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkge1xuICAgIC8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS5cbiAgICBkZWZpbmUoW10sIGZhY3RvcnkpO1xuICB9IGVsc2Uge1xuICAgIC8vIEJyb3dzZXIgZ2xvYmFsc1xuICAgIHJvb3Qub2JqZWN0UGF0aCA9IGZhY3RvcnkoKTtcbiAgfVxufSh0aGlzLCBmdW5jdGlvbiAoKSB7XG4gICd1c2Ugc3RyaWN0J1xuICB2YXIgX2hhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eVxuXG4gIGZ1bmN0aW9uIGlzRW1wdHkgKHZhbHVlKSB7XG4gICAgaWYgKCF2YWx1ZSkge1xuICAgICAgcmV0dXJuIHRydWVcbiAgICB9XG4gICAgaWYgKGlzQXJyYXkodmFsdWUpICYmIHZhbHVlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHRydWVcbiAgICB9IGVsc2UgaWYgKCFpc1N0cmluZyh2YWx1ZSkpIHtcbiAgICAgIGZvciAodmFyIGkgaW4gdmFsdWUpIHtcbiAgICAgICAgaWYgKF9oYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCBpKSkge1xuICAgICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2VcbiAgfVxuXG4gIGZ1bmN0aW9uIGlzTnVtYmVyICh2YWx1ZSkge1xuICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInXG4gIH1cblxuICBmdW5jdGlvbiBpc1N0cmluZyAob2JqKSB7XG4gICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdzdHJpbmcnXG4gIH1cblxuICBmdW5jdGlvbiBpc0FycmF5IChvYmopIHtcbiAgICByZXR1cm4gQXJyYXkuaXNBcnJheShvYmopXG4gIH1cblxuICBmdW5jdGlvbiBnZXRLZXkgKGtleSkge1xuICAgIHZhciBpbnRLZXkgPSBwYXJzZUludChrZXkpXG4gICAgaWYgKGludEtleS50b1N0cmluZygpID09PSBrZXkpIHtcbiAgICAgIHJldHVybiBpbnRLZXlcbiAgICB9XG4gICAgcmV0dXJuIGtleVxuICB9XG5cbiAgdmFyIG9iamVjdFBhdGhJbW11dGFibGUgPSBmdW5jdGlvbiAoc3JjKSB7XG4gICAgdmFyIGRlc3QgPSBzcmNcbiAgICB2YXIgY29tbWl0dGVkID0gZmFsc2VcblxuICAgIHZhciB0cmFuc2FjdGlvbiA9IE9iamVjdC5rZXlzKGFwaSkucmVkdWNlKGZ1bmN0aW9uIChwcm94eSwgcHJvcCkge1xuICAgICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi9cbiAgICAgIGlmICh0eXBlb2YgYXBpW3Byb3BdID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIHByb3h5W3Byb3BdID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgIHZhciBhcmdzID0gW2Rlc3QsIHNyY10uY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpXG5cbiAgICAgICAgICBpZiAoY29tbWl0dGVkKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBjYWxsICcgKyBwcm9wICsgJyBhZnRlciBgdmFsdWVgJylcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBkZXN0ID0gYXBpW3Byb3BdLmFwcGx5KG51bGwsIGFyZ3MpXG5cbiAgICAgICAgICByZXR1cm4gdHJhbnNhY3Rpb25cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gcHJveHlcbiAgICB9LCB7fSlcblxuICAgIHRyYW5zYWN0aW9uLnZhbHVlID0gZnVuY3Rpb24gKCkge1xuICAgICAgY29tbWl0dGVkID0gdHJ1ZVxuICAgICAgcmV0dXJuIGRlc3RcbiAgICB9XG5cbiAgICByZXR1cm4gdHJhbnNhY3Rpb25cbiAgfVxuXG4gIGZ1bmN0aW9uIGNsb25lIChvYmosIGNyZWF0ZUlmRW1wdHksIGFzc3VtZUFycmF5KSB7XG4gICAgaWYgKG9iaiA9PSBudWxsKSB7XG4gICAgICBpZiAoY3JlYXRlSWZFbXB0eSkge1xuICAgICAgICBpZiAoYXNzdW1lQXJyYXkpIHtcbiAgICAgICAgICByZXR1cm4gW11cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7fVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gb2JqXG4gICAgfSBlbHNlIGlmIChpc0FycmF5KG9iaikpIHtcbiAgICAgIHJldHVybiBvYmouc2xpY2UoKVxuICAgIH1cblxuICAgIHZhciByZXMgPSB7fVxuICAgIGZvciAodmFyIGtleSBpbiBvYmopIHtcbiAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICByZXNba2V5XSA9IG9ialtrZXldXG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc1xuICB9XG5cbiAgZnVuY3Rpb24gY2hhbmdlSW1tdXRhYmxlIChkZXN0LCBzcmMsIHBhdGgsIGNoYW5nZUNhbGxiYWNrKSB7XG4gICAgaWYgKGlzTnVtYmVyKHBhdGgpKSB7XG4gICAgICBwYXRoID0gW3BhdGhdXG4gICAgfVxuICAgIGlmIChpc0VtcHR5KHBhdGgpKSB7XG4gICAgICByZXR1cm4gc3JjXG4gICAgfVxuICAgIGlmIChpc1N0cmluZyhwYXRoKSkge1xuICAgICAgcmV0dXJuIGNoYW5nZUltbXV0YWJsZShkZXN0LCBzcmMsIHBhdGguc3BsaXQoJy4nKS5tYXAoZ2V0S2V5KSwgY2hhbmdlQ2FsbGJhY2spXG4gICAgfVxuICAgIHZhciBjdXJyZW50UGF0aCA9IHBhdGhbMF1cblxuICAgIGlmICghZGVzdCB8fCBkZXN0ID09PSBzcmMpIHtcbiAgICAgIGRlc3QgPSBjbG9uZShzcmMsIHRydWUsIGlzTnVtYmVyKGN1cnJlbnRQYXRoKSlcbiAgICB9XG5cbiAgICBpZiAocGF0aC5sZW5ndGggPT09IDEpIHtcbiAgICAgIHJldHVybiBjaGFuZ2VDYWxsYmFjayhkZXN0LCBjdXJyZW50UGF0aClcbiAgICB9XG5cbiAgICBpZiAoc3JjICE9IG51bGwpIHtcbiAgICAgIHNyYyA9IHNyY1tjdXJyZW50UGF0aF1cbiAgICB9XG5cbiAgICBkZXN0W2N1cnJlbnRQYXRoXSA9IGNoYW5nZUltbXV0YWJsZShkZXN0W2N1cnJlbnRQYXRoXSwgc3JjLCBwYXRoLnNsaWNlKDEpLCBjaGFuZ2VDYWxsYmFjaylcblxuICAgIHJldHVybiBkZXN0XG4gIH1cblxuICB2YXIgYXBpID0ge31cbiAgYXBpLnNldCA9IGZ1bmN0aW9uIHNldCAoZGVzdCwgc3JjLCBwYXRoLCB2YWx1ZSkge1xuICAgIHJldHVybiBjaGFuZ2VJbW11dGFibGUoZGVzdCwgc3JjLCBwYXRoLCBmdW5jdGlvbiAoY2xvbmVkT2JqLCBmaW5hbFBhdGgpIHtcbiAgICAgIGNsb25lZE9ialtmaW5hbFBhdGhdID0gdmFsdWVcbiAgICAgIHJldHVybiBjbG9uZWRPYmpcbiAgICB9KVxuICB9XG5cbiAgYXBpLnB1c2ggPSBmdW5jdGlvbiBwdXNoIChkZXN0LCBzcmMsIHBhdGggLyosIHZhbHVlcyAqLykge1xuICAgIHZhciB2YWx1ZXMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDMpXG4gICAgcmV0dXJuIGNoYW5nZUltbXV0YWJsZShkZXN0LCBzcmMsIHBhdGgsIGZ1bmN0aW9uIChjbG9uZWRPYmosIGZpbmFsUGF0aCkge1xuICAgICAgaWYgKCFpc0FycmF5KGNsb25lZE9ialtmaW5hbFBhdGhdKSkge1xuICAgICAgICBjbG9uZWRPYmpbZmluYWxQYXRoXSA9IHZhbHVlc1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2xvbmVkT2JqW2ZpbmFsUGF0aF0gPSBjbG9uZWRPYmpbZmluYWxQYXRoXS5jb25jYXQodmFsdWVzKVxuICAgICAgfVxuICAgICAgcmV0dXJuIGNsb25lZE9ialxuICAgIH0pXG4gIH1cblxuICBhcGkuaW5zZXJ0ID0gZnVuY3Rpb24gaW5zZXJ0IChkZXN0LCBzcmMsIHBhdGgsIHZhbHVlLCBhdCkge1xuICAgIGF0ID0gfn5hdFxuICAgIHJldHVybiBjaGFuZ2VJbW11dGFibGUoZGVzdCwgc3JjLCBwYXRoLCBmdW5jdGlvbiAoY2xvbmVkT2JqLCBmaW5hbFBhdGgpIHtcbiAgICAgIHZhciBhcnIgPSBjbG9uZWRPYmpbZmluYWxQYXRoXVxuICAgICAgaWYgKCFpc0FycmF5KGFycikpIHtcbiAgICAgICAgaWYgKGFyciAhPSBudWxsICYmIHR5cGVvZiBhcnIgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFeHBlY3RlZCAnICsgcGF0aCArICd0byBiZSBhbiBhcnJheS4gSW5zdGVhZCBnb3QgJyArIHR5cGVvZiBwYXRoKVxuICAgICAgICB9XG4gICAgICAgIGFyciA9IFtdXG4gICAgICB9XG5cbiAgICAgIHZhciBmaXJzdCA9IGFyci5zbGljZSgwLCBhdClcbiAgICAgIGZpcnN0LnB1c2godmFsdWUpXG4gICAgICBjbG9uZWRPYmpbZmluYWxQYXRoXSA9IGZpcnN0LmNvbmNhdChhcnIuc2xpY2UoYXQpKVxuICAgICAgcmV0dXJuIGNsb25lZE9ialxuICAgIH0pXG4gIH1cblxuICBhcGkuZGVsID0gZnVuY3Rpb24gZGVsIChkZXN0LCBzcmMsIHBhdGgsIHZhbHVlLCBhdCkge1xuICAgIHJldHVybiBjaGFuZ2VJbW11dGFibGUoZGVzdCwgc3JjLCBwYXRoLCBmdW5jdGlvbiAoY2xvbmVkT2JqLCBmaW5hbFBhdGgpIHtcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KGNsb25lZE9iaikpIHtcbiAgICAgICAgaWYgKGNsb25lZE9ialtmaW5hbFBhdGhdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBjbG9uZWRPYmouc3BsaWNlKGZpbmFsUGF0aCwgMSlcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGNsb25lZE9iai5oYXNPd25Qcm9wZXJ0eShmaW5hbFBhdGgpKSB7XG4gICAgICAgICAgZGVsZXRlIGNsb25lZE9ialtmaW5hbFBhdGhdXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBjbG9uZWRPYmpcbiAgICB9KVxuICB9XG5cbiAgYXBpLmFzc2lnbiA9IGZ1bmN0aW9uIGFzc2lnbiAoZGVzdCwgc3JjLCBwYXRoLCBzb3VyY2UpIHtcbiAgICByZXR1cm4gY2hhbmdlSW1tdXRhYmxlKGRlc3QsIHNyYywgcGF0aCwgZnVuY3Rpb24gKGNsb25lZE9iaiwgZmluYWxQYXRoKSB7XG4gICAgICBzb3VyY2UgPSBPYmplY3Qoc291cmNlKVxuICAgICAgdmFyIHRhcmdldCA9IGNsb25lKGNsb25lZE9ialtmaW5hbFBhdGhdLCB0cnVlKVxuXG4gICAgICBmb3IgKHZhciBrZXkgaW4gc291cmNlKSB7XG4gICAgICAgIGlmIChfaGFzT3duUHJvcGVydHkuY2FsbChzb3VyY2UsIGtleSkpIHtcbiAgICAgICAgICB0YXJnZXRba2V5XSA9IHNvdXJjZVtrZXldXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY2xvbmVkT2JqW2ZpbmFsUGF0aF0gPSB0YXJnZXRcbiAgICAgIHJldHVybiBjbG9uZWRPYmpcbiAgICB9KVxuICB9XG5cbiAgcmV0dXJuIE9iamVjdC5rZXlzKGFwaSkucmVkdWNlKGZ1bmN0aW9uIChvYmplY3RQYXRoSW1tdXRhYmxlLCBtZXRob2QpIHtcbiAgICBvYmplY3RQYXRoSW1tdXRhYmxlW21ldGhvZF0gPSBhcGlbbWV0aG9kXS5iaW5kKG51bGwsIG51bGwpXG5cbiAgICByZXR1cm4gb2JqZWN0UGF0aEltbXV0YWJsZVxuICB9LCBvYmplY3RQYXRoSW1tdXRhYmxlKVxufSkpO1xuIl19
