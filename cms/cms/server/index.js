import _get from 'lodash/get';

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

import createSchema from 'olymp-graphql/server';
import createMail from 'olymp-mail/server';
import { pagesGraphQL } from 'olymp-pages/server';
import { cloudinaryGraphQL } from 'olymp-cloudinary/server';
import { googleGraphQL } from 'olymp-google/server';
import { scrapeGraphQL } from 'olymp-scrape/server';
import auth0 from 'olymp-auth0/server';
import { MongoClient } from 'mongodb';
/* import createSitemap from 'olymp-sitemap/server'; */
import { modules as colModules, directives } from 'olymp-collection/server';

import algoliasearch from 'algoliasearch';

var querystring = require('querystring');

var parser = require('url');

var _process$env = process.env,
    APP = _process$env.APP,
    URL = _process$env.URL,
    MONGODB_URI = _process$env.MONGODB_URI,
    ALGOLIA = _process$env.ALGOLIA,
    POSTMARK_KEY = _process$env.POSTMARK_KEY,
    POSTMARK_FROM = _process$env.POSTMARK_FROM,
    CLOUDINARY_URI = _process$env.CLOUDINARY_URI,
    AUTH_SECRET = _process$env.AUTH_SECRET,
    NODE_ENV = _process$env.NODE_ENV,
    GOOGLE_MAPS_KEY = _process$env.GOOGLE_MAPS_KEY,
    GOOGLE_CLIENT_EMAIL = _process$env.GOOGLE_CLIENT_EMAIL,
    GOOGLE_PRIVATE_KEY = _process$env.GOOGLE_PRIVATE_KEY;


export default (function (server, options) {
  var db = null;

  var x1 = MONGODB_URI.split('?')[0];
  var x2 = MONGODB_URI.split('?')[1] || '';
  var op2 = querystring.parse(x2);
  new MongoClient(x1, _extends({}, op2, {
    ssl: !!op2.ssl
  })).connect(function (err, mongo) {
    if (err) {
      console.error(err);
      if (err.errors) {
        err.errors.forEach(function (err) {
          return console.error(err);
        });
      }
    }
    db = mongo.db(x1.split('/').pop());
  });

  auth0(server);

  var schema = createSchema({ directives: directives });
  var modules = _extends({
    helloWorld: {
      queries: '\n      helloWorld: String\n    ',
      resolvers: {
        queries: {
          helloWorld: function helloWorld() {
            return 'Hello World!';
          }
        }
      }
    },
    user: {
      schema: '\n        type User {\n          isAdmin: Boolean\n          id: String\n          email: Email\n          token: String\n          name: String\n        }\n      '
    }
  }, _get(options, 'modules', {}), colModules);
  var mail = createMail(POSTMARK_KEY, {
    from: POSTMARK_FROM,
    url: URL
  });

  var algolia = ALGOLIA ? algoliasearch(ALGOLIA.split('@')[1], ALGOLIA.split('@')[0]) : null;

  // const responseCache = createResponseCache();
  var cachedApp = null;

  server.getSchema = schema.getSchema;
  server.getDB = function () {
    return db;
  };
  server.use(function (req, res, next) {
    req.db = db;
    req.mail = mail;
    req.schema = schema.getSchema();
    req.app = APP ? { id: APP } : null;
    req.algolia = algolia;
    next();
  });

  modules.pages = pagesGraphQL();
  modules.cloudinary = cloudinaryGraphQL(CLOUDINARY_URI);
  modules.scrape = scrapeGraphQL();
  modules.google = googleGraphQL(GOOGLE_MAPS_KEY, GOOGLE_CLIENT_EMAIL, GOOGLE_PRIVATE_KEY);
  server.post('/graphql', schema.express);
  if (NODE_ENV !== 'production') {
    server.get('/graphql', schema.graphi);
  }
  schema.apply(modules);
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhY2thZ2VzL2Ntcy9zZXJ2ZXIvaW5kZXguZXM2Il0sIm5hbWVzIjpbImNyZWF0ZVNjaGVtYSIsImNyZWF0ZU1haWwiLCJwYWdlc0dyYXBoUUwiLCJjbG91ZGluYXJ5R3JhcGhRTCIsImdvb2dsZUdyYXBoUUwiLCJzY3JhcGVHcmFwaFFMIiwiYXV0aDAiLCJNb25nb0NsaWVudCIsIm1vZHVsZXMiLCJjb2xNb2R1bGVzIiwiZGlyZWN0aXZlcyIsImFsZ29saWFzZWFyY2giLCJxdWVyeXN0cmluZyIsInJlcXVpcmUiLCJwYXJzZXIiLCJwcm9jZXNzIiwiZW52IiwiQVBQIiwiVVJMIiwiTU9OR09EQl9VUkkiLCJBTEdPTElBIiwiUE9TVE1BUktfS0VZIiwiUE9TVE1BUktfRlJPTSIsIkNMT1VESU5BUllfVVJJIiwiQVVUSF9TRUNSRVQiLCJOT0RFX0VOViIsIkdPT0dMRV9NQVBTX0tFWSIsIkdPT0dMRV9DTElFTlRfRU1BSUwiLCJHT09HTEVfUFJJVkFURV9LRVkiLCJzZXJ2ZXIiLCJvcHRpb25zIiwiZGIiLCJ4MSIsInNwbGl0IiwieDIiLCJvcDIiLCJwYXJzZSIsInNzbCIsImNvbm5lY3QiLCJlcnIiLCJtb25nbyIsImNvbnNvbGUiLCJlcnJvciIsImVycm9ycyIsImZvckVhY2giLCJwb3AiLCJzY2hlbWEiLCJoZWxsb1dvcmxkIiwicXVlcmllcyIsInJlc29sdmVycyIsInVzZXIiLCJtYWlsIiwiZnJvbSIsInVybCIsImFsZ29saWEiLCJjYWNoZWRBcHAiLCJnZXRTY2hlbWEiLCJnZXREQiIsInVzZSIsInJlcSIsInJlcyIsIm5leHQiLCJhcHAiLCJpZCIsInBhZ2VzIiwiY2xvdWRpbmFyeSIsInNjcmFwZSIsImdvb2dsZSIsInBvc3QiLCJleHByZXNzIiwiZ2V0IiwiZ3JhcGhpIiwiYXBwbHkiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPQSxZQUFQLE1BQXlCLHNCQUF6QjtBQUNBLE9BQU9DLFVBQVAsTUFBdUIsbUJBQXZCO0FBQ0EsU0FBU0MsWUFB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QVdDLElBQVgsRUFBb0I7QUFDN0JGLFFBQUk1QixFQUFKLEdBQVNBLEVBQVQ7QUFDQTRCLFFBQUlSLElBQUosR0FBV0EsSUFBWDtBQUNBUSxRQUFJYixNQUFKLEdBQWFBLE9BQU9VLFNBQVAsRUFBYjtBQUNBRyxRQUFJRyxHQUFKLEdBQVU3QyxNQUFNLEVBQUU4QyxJQUFJOUMsR0FBTixFQUFOLEdBQW9CLElBQTlCO0FBQ0EwQyxRQUFJTCxPQUFKLEdBQWNBLE9BQWQ7QUFDQU87QUFDRCxHQVBEOztBQVNBckQsVUFBUXdELEtBQVIsR0FBZ0I5RCxjQUFoQjtBQUNBTSxVQUFReUQsVUFBUixHQUFxQjlELGtCQUFrQm9CLGNBQWxCLENBQXJCO0FBQ0FmLFVBQVEwRCxNQUFSLEdBQWlCN0QsZUFBakI7QUFDQUcsVUFBUTJELE1BQVIsR0FBaUIvRCxjQUNmc0IsZUFEZSxFQUVmQyxtQkFGZSxFQUdmQyxrQkFIZSxDQUFqQjtBQUtBQyxTQUFPdUMsSUFBUCxDQUFZLFVBQVosRUFBd0J0QixPQUFPdUIsT0FBL0I7QUFDQSxNQUFJNUMsYUFBYSxZQUFqQixFQUErQjtBQUM3QkksV0FBT3lDLEdBQVAsQ0FBVyxVQUFYLEVBQXVCeEIsT0FBT3lCLE1BQTlCO0FBQ0Q7QUFDRHpCLFNBQU8wQixLQUFQLENBQWFoRSxPQUFiO0FBQ0QsQ0FwRkQiLCJmaWxlIjoicGFja2FnZXMvY21zL3NlcnZlci9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjcmVhdGVTY2hlbWEgZnJvbSAnb2x5bXAtZ3JhcGhxbC9zZXJ2ZXInO1xuaW1wb3J0IGNyZWF0ZU1haWwgZnJvbSAnb2x5bXAtbWFpbC9zZXJ2ZXInO1xuaW1wb3J0IHsgcGFnZXNHcmFwaFFMIH0gZnJvbSAnb2x5bXAtcGFnZXMvc2VydmVyJztcbmltcG9ydCB7IGNsb3VkaW5hcnlHcmFwaFFMIH0gZnJvbSAnb2x5bXAtY2xvdWRpbmFyeS9zZXJ2ZXInO1xuaW1wb3J0IHsgZ29vZ2xlR3JhcGhRTCB9IGZyb20gJ29seW1wLWdvb2dsZS9zZXJ2ZXInO1xuaW1wb3J0IHsgc2NyYXBlR3JhcGhRTCB9IGZyb20gJ29seW1wLXNjcmFwZS9zZXJ2ZXInO1xuaW1wb3J0IGF1dGgwIGZyb20gJ29seW1wLWF1dGgwL3NlcnZlcic7XG5pbXBvcnQgeyBNb25nb0NsaWVudCB9IGZyb20gJ21vbmdvZGInO1xuLyogaW1wb3J0IGNyZWF0ZVNpdGVtYXAgZnJvbSAnb2x5bXAtc2l0ZW1hcC9zZXJ2ZXInOyAqL1xuaW1wb3J0IHsgbW9kdWxlcyBhcyBjb2xNb2R1bGVzLCBkaXJlY3RpdmVzIH0gZnJvbSAnb2x5bXAtY29sbGVjdGlvbi9zZXJ2ZXInO1xuaW1wb3J0IHsgZ2V0IH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBhbGdvbGlhc2VhcmNoIGZyb20gJ2FsZ29saWFzZWFyY2gnO1xuXG5jb25zdCBxdWVyeXN0cmluZyA9IHJlcXVpcmUoJ3F1ZXJ5c3RyaW5nJyk7XG5cbmNvbnN0IHBhcnNlciA9IHJlcXVpcmUoJ3VybCcpO1xuXG5jb25zdCB7XG4gIEFQUCxcbiAgVVJMLFxuICBNT05HT0RCX1VSSSxcbiAgQUxHT0xJQSxcbiAgUE9TVE1BUktfS0VZLFxuICBQT1NUTUFSS19GUk9NLFxuICBDTE9VRElOQVJZX1VSSSxcbiAgLy8gRklMRVNUQUNLX0tFWSxcbiAgQVVUSF9TRUNSRVQsXG4gIE5PREVfRU5WLFxuICBHT09HTEVfTUFQU19LRVksXG4gIEdPT0dMRV9DTElFTlRfRU1BSUwsXG4gIEdPT0dMRV9QUklWQVRFX0tFWSxcbn0gPSBwcm9jZXNzLmVudjtcblxuZXhwb3J0IGRlZmF1bHQgKHNlcnZlciwgb3B0aW9ucykgPT4ge1xuICBsZXQgZGIgPSBudWxsO1xuXG5cbiAgY29uc3QgeDEgPSBNT05HT0RCX1VSSS5zcGxpdCgnPycpWzBdO1xuICBjb25zdCB4MiA9IE1PTkdPREJfVVJJLnNwbGl0KCc/JylbMV0gfHwgJyc7XG4gIGNvbnN0IG9wMiA9IHF1ZXJ5c3RyaW5nLnBhcnNlKHgyKTtcbiAgbmV3IE1vbmdvQ2xpZW50KHgxLCB7XG4gICAgLi4ub3AyLFxuICAgIHNzbDogISFvcDIuc3NsLFxuICB9KS5jb25uZWN0KChlcnIsIG1vbmdvKSA9PiB7XG4gICAgaWYgKGVycikge1xuICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgaWYgKGVyci5lcnJvcnMpIHtcbiAgICAgICAgZXJyLmVycm9ycy5mb3JFYWNoKGVyciA9PiBjb25zb2xlLmVycm9yKGVycikpO1xuICAgICAgfVxuICAgIH1cbiAgICBkYiA9IG1vbmdvLmRiKHgxLnNwbGl0KCcvJykucG9wKCkpO1xuICB9KTtcblxuICBhdXRoMChzZXJ2ZXIpO1xuXG4gIGNvbnN0IHNjaGVtYSA9IGNyZWF0ZVNjaGVtYSh7IGRpcmVjdGl2ZXMgfSk7XG4gIGNvbnN0IG1vZHVsZXMgPSB7XG4gICAgaGVsbG9Xb3JsZDoge1xuICAgICAgcXVlcmllczogYFxuICAgICAgaGVsbG9Xb3JsZDogU3RyaW5nXG4gICAgYCxcbiAgICAgIHJlc29sdmVyczoge1xuICAgICAgICBxdWVyaWVzOiB7XG4gICAgICAgICAgaGVsbG9Xb3JsZDogKCkgPT4gJ0hlbGxvIFdvcmxkIScsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0sXG4gICAgdXNlcjoge1xuICAgICAgc2NoZW1hOiBgXG4gICAgICAgIHR5cGUgVXNlciB7XG4gICAgICAgICAgaXNBZG1pbjogQm9vbGVhblxuICAgICAgICAgIGlkOiBTdHJpbmdcbiAgICAgICAgICBlbWFpbDogRW1haWxcbiAgICAgICAgICB0b2tlbjogU3RyaW5nXG4gICAgICAgICAgbmFtZTogU3RyaW5nXG4gICAgICAgIH1cbiAgICAgIGAsXG4gICAgfSxcbiAgICAuLi5nZXQob3B0aW9ucywgJ21vZHVsZXMnLCB7fSksXG4gICAgLi4uY29sTW9kdWxlcyxcbiAgfTtcbiAgY29uc3QgbWFpbCA9IGNyZWF0ZU1haWwoUE9TVE1BUktfS0VZLCB7XG4gICAgZnJvbTogUE9TVE1BUktfRlJPTSxcbiAgICB1cmw6IFVSTCxcbiAgfSk7XG5cbiAgY29uc3QgYWxnb2xpYSA9IEFMR09MSUFcbiAgICA/IGFsZ29saWFzZWFyY2goQUxHT0xJQS5zcGxpdCgnQCcpWzFdLCBBTEdPTElBLnNwbGl0KCdAJylbMF0pXG4gICAgOiBudWxsO1xuXG4gIC8vIGNvbnN0IHJlc3BvbnNlQ2FjaGUgPSBjcmVhdGVSZXNwb25zZUNhY2hlKCk7XG4gIGNvbnN0IGNhY2hlZEFwcCA9IG51bGw7XG5cbiAgc2VydmVyLmdldFNjaGVtYSA9IHNjaGVtYS5nZXRTY2hlbWE7XG4gIHNlcnZlci5nZXREQiA9ICgpID0+IGRiO1xuICBzZXJ2ZXIudXNlKChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIHJlcS5kYiA9IGRiO1xuICAgIHJlcS5tYWlsID0gbWFpbDtcbiAgICByZXEuc2NoZW1hID0gc2NoZW1hLmdldFNjaGVtYSgpO1xuICAgIHJlcS5hcHAgPSBBUFAgPyB7IGlkOiBBUFAgfSA6IG51bGw7XG4gICAgcmVxLmFsZ29saWEgPSBhbGdvbGlhO1xuICAgIG5leHQoKTtcbiAgfSk7XG5cbiAgbW9kdWxlcy5wYWdlcyA9IHBhZ2VzR3JhcGhRTCgpO1xuICBtb2R1bGVzLmNsb3VkaW5hcnkgPSBjbG91ZGluYXJ5R3JhcGhRTChDTE9VRElOQVJZX1VSSSk7XG4gIG1vZHVsZXMuc2NyYXBlID0gc2NyYXBlR3JhcGhRTCgpO1xuICBtb2R1bGVzLmdvb2dsZSA9IGdvb2dsZUdyYXBoUUwoXG4gICAgR09PR0xFX01BUFNfS0VZLFxuICAgIEdPT0dMRV9DTElFTlRfRU1BSUwsXG4gICAgR09PR0xFX1BSSVZBVEVfS0VZLFxuICApO1xuICBzZXJ2ZXIucG9zdCgnL2dyYXBocWwnLCBzY2hlbWEuZXhwcmVzcyk7XG4gIGlmIChOT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7XG4gICAgc2VydmVyLmdldCgnL2dyYXBocWwnLCBzY2hlbWEuZ3JhcGhpKTtcbiAgfVxuICBzY2hlbWEuYXBwbHkobW9kdWxlcyk7XG59O1xuIl19
