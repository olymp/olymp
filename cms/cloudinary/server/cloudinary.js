var cloudinary = require('cloudinary');
var lodash = require('lodash');

var APP = process.env.APP;


export var parseURI = function parseURI(uri) {
  var config = {};
  if (uri) {
    var split1 = uri.split('@');
    var split2 = split1[0].split('://');
    var split3 = split2[1].split(':');
    config.cloud_name = split1[1];
    config.api_key = split3[0];
    config.api_secret = split3[1];
    cloudinary.config(config);
  }

  return config;
};

export var transform = function transform(image) {
  var newImage = {};
  Object.keys(image).forEach(function (key) {
    var originalKey = key;
    key = lodash.camelCase(key);
    if (key === 'publicId') {
      newImage.publicId = image.public_id;
      return;
    } else if (key === 'secureUrl') {
      return;
    } else if (key === 'url') {
      newImage.url = image.secure_url || image.url;
      return;
    } else if (key === 'colors') {
      return;
    } else if (key === 'context' && image[key].custom) {
      newImage.caption = image[key].custom.caption;
      newImage.source = image[key].custom.source;
      newImage.removed = image[key].custom.removed;
      return;
    } else if (key === 'predominant') {
      // Geht nur bei Single Pictures!!!
      newImage.colors = image.predominant.google.map(function (x) {
        return x[0];
      });
      return;
    } else if (key === 'pages') {
      // Geht nur bei Single Pictures und PDFs!!!
      newImage.pages = image.pages;
      return;
    }
    if (['id', 'format', 'version', 'resourceType', 'type', 'createdAt', 'height', 'width', 'bytes', 'url', 'caption', 'source', 'removed', 'pages', 'colors', 'tags'].indexOf(key) !== -1) {
      newImage[key] = image[key];
    }
  });
  return newImage;
};

export var transformSignature = function transformSignature(_ref, _ref2) {
  var cloud_name = _ref.cloud_name;
  var signature = _ref2.signature,
      api_key = _ref2.api_key,
      timestamp = _ref2.timestamp,
      folder = _ref2.folder;
  return {
    url: 'https://api.cloudinary.com/v1_1/' + cloud_name + '/auto/upload', // eslint-disable-line
    signature: signature,
    folder: folder,
    timestamp: timestamp,
    apiKey: api_key
  };
};

export var getImages = function getImages(config) {
  var images = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  var nextCursor = arguments[2];
  return new Promise(function (yay, nay) {
    cloudinary.api.resources(function (result) {
      if (result.error) {
        return nay(result.error);
      }

      // Aktuelle Bilder an Ausgabe-Array anh√§ngen (max 500)
      var results = result.resources && result.resources.length ? images.concat(result.resources.map(transform)) : [];

      // Falls noch weitere Bilder in Mediathek sind, diese auch laden
      if (result.next_cursor) {
        console.error('WARNING, MORE THAN 500 IMAGES!');
        return getImages(config, results, result.next_cursor).then(yay);
      }
      return yay(results);
    }, Object.assign({}, config, {
      tags: true,
      context: true,
      type: 'upload',
      colors: true,
      max_results: 500,
      next_cursor: nextCursor,
      prefix: APP && APP !== 'gzk' ? APP + '/' : ''
    }));
  });
};

export var getImageById = function getImageById(config, id) {
  return new Promise(function (yay) {
    return cloudinary.api.resource(id, function (result) {
      yay(result);
    }, Object.assign({}, config, {
      tags: true,
      context: true,
      type: 'upload',
      colors: true,
      pages: true,
      prefix: APP && APP !== 'gzk' ? APP + '/' : ''
    }));
  }).then(transform);
};

export var getSignedRequest = function getSignedRequest(config) {
  return transformSignature(config, cloudinary.utils.sign_request({
    timestamp: Math.round(new Date().getTime() / 1000),
    folder: APP ? APP + '/' : null
  }, config));
};

export var updateImage = function updateImage(id, tags, source, caption, config, removed) {
  var context = [];

  if (source) {
    context.push('source=' + source);
  }

  if (caption) {
    context.push('caption=' + caption);
  }

  if (removed) {
    context.push('removed=true');
  }

  return new Promise(function (yay) {
    cloudinary.api.update(id, function (result) {
      return yay(result);
    }, Object.assign({}, config, {
      prefix: APP ? APP + '/' : '',
      tags: (tags || []).join(','),
      context: context.join('|')
    }));
  }).then(transform);
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhY2thZ2VzL2Nsb3VkaW5hcnkvc2VydmVyL2Nsb3VkaW5hcnkuZXM2Il0sIm5hbWVzIjpbImNsb3VkaW5hcnkiLCJyZXF1aXJlIiwibG9kYXNoIiwiQVBQIiwicHJvY2VzcyIsImVudiIsInBhcnNlVVJJIiwidXJpIiwiY29uZmlnIiwic3BsaXQxIiwic3BsaXQiLCJzcGxpdDIiLCJzcGxpdDMiLCJjbG91ZF9uYW1lIiwiYXBpX2tleSIsImFwaV9zZWNyZXQiLCJ0cmFuc2Zvcm0iLCJpbWFnZSIsIm5ld0ltYWdlIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJrZXkiLCJvcmlnaW5hbEtleSIsImNhbWVsQ2FzZSIsInB1YmxpY0lkIiwicHVibGljX2lkIiwidXJsIiwic2VjdXJlX3VybCIsImN1c3RvbSIsImNhcHRpb24iLCJzb3VyY2UiLCJyZW1vdmVkIiwiY29sb3JzIiwicHJlZG9taW5hbnQiLCJnb29nbGUiLCJtYXAiLCJ4IiwicGFnZXMiLCJpbmRleE9mIiwidHJhbnNmb3JtU2lnbmF0dXJlIiwic2lnbmF0dXJlIiwidGltZXN0YW1wIiwiZm9sZGVyIiwiYXBpS2V5IiwiZ2V0SW1hZ2VzIiwiaW1hZ2VzIiwibmV4dEN1cnNvciIsIlByb21pc2UiLCJ5YXkiLCJuYXkiLCJhcGkiLCJyZXNvdXJjZXMiLCJyZXN1bHQiLCJlcnJvciIsInJlc3VsdHMiLCJsZW5ndGgiLCJjb25jYXQiLCJuZXh0X2N1cnNvciIsImNvbnNvbGUiLCJ0aGVuIiwiYXNzaWduIiwidGFncyIsImNvbnRleHQiLCJ0eXBlIiwibWF4X3Jlc3VsdHMiLCJwcmVmaXgiLCJnZXRJbWFnZUJ5SWQiLCJpZCIsInJlc291cmNlIiwiZ2V0U2lnbmVkUmVxdWVzdCIsInV0aWxzIiwic2lnbl9yZXF1ZXN0IiwiTWF0aCIsInJvdW5kIiwiRGF0ZSIsImdldFRpbWUiLCJ1cGRhdGVJbWFnZSIsInB1c2giLCJ1cGRhdGUiLCJqb2luIl0sIm1hcHBpbmdzIjoiQUFBQSxJQUFNQSxhQUFhQyxR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U0FBa0I7QUFGNUIsR0FERixFQUtFSyxNQUxGLENBRkYsQ0FEOEI7QUFBQSxDQUF6Qjs7QUFZUCxPQUFPLElBQU1xRSxjQUFjLFNBQWRBLFdBQWMsQ0FBQ1QsRUFBRCxFQUFLTixJQUFMLEVBQVcvQixNQUFYLEVBQW1CRCxPQUFuQixFQUE0QnRCLE1BQTVCLEVBQW9Dd0IsT0FBcEMsRUFBZ0Q7QUFDekUsTUFBTStCLFVBQVUsRUFBaEI7O0FBRUEsTUFBSWhDLE1BQUosRUFBWTtBQUNWZ0MsWUFBUWUsSUFBUixhQUF1Qi9DLE1BQXZCO0FBQ0Q7O0FBRUQsTUFBSUQsT0FBSixFQUFhO0FBQ1hpQyxZQUFRZSxJQUFSLGNBQXdCaEQsT0FBeEI7QUFDRDs7QUFFRCxNQUFJRSxPQUFKLEVBQWE7QUFDWCtCLFlBQVFlLElBQVIsQ0FBYSxjQUFiO0FBQ0Q7O0FBRUQsU0FBTyxJQUFJOUIsT0FBSixDQUFZLFVBQUNDLEdBQUQsRUFBUztBQUMxQmpELGVBQVdtRCxHQUFYLENBQWU0QixNQUFmLENBQ0VYLEVBREYsRUFFRTtBQUFBLGFBQVVuQixJQUFJSSxNQUFKLENBQVY7QUFBQSxLQUZGLEVBR0VsQyxPQUFPMEMsTUFBUCxDQUFjLEVBQWQsRUFBa0JyRCxNQUFsQixFQUEwQjtBQUN4QjBELGNBQVEvRCxNQUFTQSxHQUFULFNBQWtCLEVBREY7QUFFeEIyRCxZQUFNLENBQUNBLFFBQVEsRUFBVCxFQUFha0IsSUFBYixDQUFrQixHQUFsQixDQUZrQjtBQUd4QmpCLGVBQVNBLFFBQVFpQixJQUFSLENBQWEsR0FBYjtBQUhlLEtBQTFCLENBSEY7QUFTRCxHQVZNLEVBVUpwQixJQVZJLENBVUM1QyxTQVZELENBQVA7QUFXRCxDQTFCTSIsImZpbGUiOiJwYWNrYWdlcy9jbG91ZGluYXJ5L3NlcnZlci9jbG91ZGluYXJ5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgY2xvdWRpbmFyeSA9IHJlcXVpcmUoJ2Nsb3VkaW5hcnknKTtcbmNvbnN0IGxvZGFzaCA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xuXG5jb25zdCB7IEFQUCB9ID0gcHJvY2Vzcy5lbnY7XG5cbmV4cG9ydCBjb25zdCBwYXJzZVVSSSA9ICh1cmkpID0+IHtcbiAgY29uc3QgY29uZmlnID0ge307XG4gIGlmICh1cmkpIHtcbiAgICBjb25zdCBzcGxpdDEgPSB1cmkuc3BsaXQoJ0AnKTtcbiAgICBjb25zdCBzcGxpdDIgPSBzcGxpdDFbMF0uc3BsaXQoJzovLycpO1xuICAgIGNvbnN0IHNwbGl0MyA9IHNwbGl0MlsxXS5zcGxpdCgnOicpO1xuICAgIGNvbmZpZy5jbG91ZF9uYW1lID0gc3BsaXQxWzFdO1xuICAgIGNvbmZpZy5hcGlfa2V5ID0gc3BsaXQzWzBdO1xuICAgIGNvbmZpZy5hcGlfc2VjcmV0ID0gc3BsaXQzWzFdO1xuICAgIGNsb3VkaW5hcnkuY29uZmlnKGNvbmZpZyk7XG4gIH1cblxuICByZXR1cm4gY29uZmlnO1xufTtcblxuZXhwb3J0IGNvbnN0IHRyYW5zZm9ybSA9IChpbWFnZSkgPT4ge1xuICBjb25zdCBuZXdJbWFnZSA9IHt9O1xuICBPYmplY3Qua2V5cyhpbWFnZSkuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgY29uc3Qgb3JpZ2luYWxLZXkgPSBrZXk7XG4gICAga2V5ID0gbG9kYXNoLmNhbWVsQ2FzZShrZXkpO1xuICAgIGlmIChrZXkgPT09ICdwdWJsaWNJZCcpIHtcbiAgICAgIG5ld0ltYWdlLnB1YmxpY0lkID0gaW1hZ2UucHVibGljX2lkO1xuICAgICAgcmV0dXJuO1xuICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnc2VjdXJlVXJsJykge1xuICAgICAgcmV0dXJuO1xuICAgIH0gZWxzZSBpZiAoa2V5ID09PSAndXJsJykge1xuICAgICAgbmV3SW1hZ2UudXJsID0gaW1hZ2Uuc2VjdXJlX3VybCB8fCBpbWFnZS51cmw7XG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIGlmIChrZXkgPT09ICdjb2xvcnMnKSB7XG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIGlmIChrZXkgPT09ICdjb250ZXh0JyAmJiBpbWFnZVtrZXldLmN1c3RvbSkge1xuICAgICAgbmV3SW1hZ2UuY2FwdGlvbiA9IGltYWdlW2tleV0uY3VzdG9tLmNhcHRpb247XG4gICAgICBuZXdJbWFnZS5zb3VyY2UgPSBpbWFnZVtrZXldLmN1c3RvbS5zb3VyY2U7XG4gICAgICBuZXdJbWFnZS5yZW1vdmVkID0gaW1hZ2Vba2V5XS5jdXN0b20ucmVtb3ZlZDtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2UgaWYgKGtleSA9PT0gJ3ByZWRvbWluYW50Jykge1xuICAgICAgLy8gR2VodCBudXIgYmVpIFNpbmdsZSBQaWN0dXJlcyEhIVxuICAgICAgbmV3SW1hZ2UuY29sb3JzID0gaW1hZ2UucHJlZG9taW5hbnQuZ29vZ2xlLm1hcCh4ID0+IHhbMF0pO1xuICAgICAgcmV0dXJuO1xuICAgIH0gZWxzZSBpZiAoa2V5ID09PSAncGFnZXMnKSB7XG4gICAgICAvLyBHZWh0IG51ciBiZWkgU2luZ2xlIFBpY3R1cmVzIHVuZCBQREZzISEhXG4gICAgICBuZXdJbWFnZS5wYWdlcyA9IGltYWdlLnBhZ2VzO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoXG4gICAgICBbXG4gICAgICAgICdpZCcsXG4gICAgICAgICdmb3JtYXQnLFxuICAgICAgICAndmVyc2lvbicsXG4gICAgICAgICdyZXNvdXJjZVR5cGUnLFxuICAgICAgICAndHlwZScsXG4gICAgICAgICdjcmVhdGVkQXQnLFxuICAgICAgICAnaGVpZ2h0JyxcbiAgICAgICAgJ3dpZHRoJyxcbiAgICAgICAgJ2J5dGVzJyxcbiAgICAgICAgJ3VybCcsXG4gICAgICAgICdjYXB0aW9uJyxcbiAgICAgICAgJ3NvdXJjZScsXG4gICAgICAgICdyZW1vdmVkJyxcbiAgICAgICAgJ3BhZ2VzJyxcbiAgICAgICAgJ2NvbG9ycycsXG4gICAgICAgICd0YWdzJyxcbiAgICAgIF0uaW5kZXhPZihrZXkpICE9PSAtMVxuICAgICkge1xuICAgICAgbmV3SW1hZ2Vba2V5XSA9IGltYWdlW2tleV07XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIG5ld0ltYWdlO1xufTtcblxuZXhwb3J0IGNvbnN0IHRyYW5zZm9ybVNpZ25hdHVyZSA9ICh7IGNsb3VkX25hbWUgfSwgeyBzaWduYXR1cmUsIGFwaV9rZXksIHRpbWVzdGFtcCwgZm9sZGVyIH0pID0+ICh7XG4gIHVybDogYGh0dHBzOi8vYXBpLmNsb3VkaW5hcnkuY29tL3YxXzEvJHtjbG91ZF9uYW1lfS9hdXRvL3VwbG9hZGAsIC8vIGVzbGludC1kaXNhYmxlLWxpbmVcbiAgc2lnbmF0dXJlLFxuICBmb2xkZXIsXG4gIHRpbWVzdGFtcCxcbiAgYXBpS2V5OiBhcGlfa2V5LFxufSk7XG5cbmV4cG9ydCBjb25zdCBnZXRJbWFnZXMgPSAoY29uZmlnLCBpbWFnZXMgPSBbXSwgbmV4dEN1cnNvcikgPT5cbiAgbmV3IFByb21pc2UoKHlheSwgbmF5KSA9PiB7XG4gICAgY2xvdWRpbmFyeS5hcGkucmVzb3VyY2VzKFxuICAgICAgKHJlc3VsdCkgPT4ge1xuICAgICAgICBpZiAocmVzdWx0LmVycm9yKSB7XG4gICAgICAgICAgcmV0dXJuIG5heShyZXN1bHQuZXJyb3IpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQWt0dWVsbGUgQmlsZGVyIGFuIEF1c2dhYmUtQXJyYXkgYW5ow6RuZ2VuIChtYXggNTAwKVxuICAgICAgICBjb25zdCByZXN1bHRzID1cbiAgICAgICAgICByZXN1bHQucmVzb3VyY2VzICYmIHJlc3VsdC5yZXNvdXJjZXMubGVuZ3RoXG4gICAgICAgICAgICA/IGltYWdlcy5jb25jYXQocmVzdWx0LnJlc291cmNlcy5tYXAodHJhbnNmb3JtKSlcbiAgICAgICAgICAgIDogW107XG5cbiAgICAgICAgLy8gRmFsbHMgbm9jaCB3ZWl0ZXJlIEJpbGRlciBpbiBNZWRpYXRoZWsgc2luZCwgZGllc2UgYXVjaCBsYWRlblxuICAgICAgICBpZiAocmVzdWx0Lm5leHRfY3Vyc29yKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignV0FSTklORywgTU9SRSBUSEFOIDUwMCBJTUFHRVMhJyk7XG4gICAgICAgICAgcmV0dXJuIGdldEltYWdlcyhjb25maWcsIHJlc3VsdHMsIHJlc3VsdC5uZXh0X2N1cnNvcikudGhlbih5YXkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB5YXkocmVzdWx0cyk7XG4gICAgICB9LFxuICAgICAgT2JqZWN0LmFzc2lnbih7fSwgY29uZmlnLCB7XG4gICAgICAgIHRhZ3M6IHRydWUsXG4gICAgICAgIGNvbnRleHQ6IHRydWUsXG4gICAgICAgIHR5cGU6ICd1cGxvYWQnLFxuICAgICAgICBjb2xvcnM6IHRydWUsXG4gICAgICAgIG1heF9yZXN1bHRzOiA1MDAsXG4gICAgICAgIG5leHRfY3Vyc29yOiBuZXh0Q3Vyc29yLFxuICAgICAgICBwcmVmaXg6IEFQUCAmJiBBUFAgIT09ICdnemsnID8gYCR7QVBQfS9gIDogJycsXG4gICAgICB9KSxcbiAgICApO1xuICB9KTtcblxuZXhwb3J0IGNvbnN0IGdldEltYWdlQnlJZCA9IChjb25maWcsIGlkKSA9PlxuICBuZXcgUHJvbWlzZSh5YXkgPT5cbiAgICBjbG91ZGluYXJ5LmFwaS5yZXNvdXJjZShcbiAgICAgIGlkLFxuICAgICAgKHJlc3VsdCkgPT4ge1xuICAgICAgICB5YXkocmVzdWx0KTtcbiAgICAgIH0sXG4gICAgICBPYmplY3QuYXNzaWduKHt9LCBjb25maWcsIHtcbiAgICAgICAgdGFnczogdHJ1ZSxcbiAgICAgICAgY29udGV4dDogdHJ1ZSxcbiAgICAgICAgdHlwZTogJ3VwbG9hZCcsXG4gICAgICAgIGNvbG9yczogdHJ1ZSxcbiAgICAgICAgcGFnZXM6IHRydWUsXG4gICAgICAgIHByZWZpeDogQVBQICYmIEFQUCAhPT0gJ2d6aycgPyBgJHtBUFB9L2AgOiAnJyxcbiAgICAgIH0pLFxuICAgICksXG4gICkudGhlbih0cmFuc2Zvcm0pO1xuXG5leHBvcnQgY29uc3QgZ2V0U2lnbmVkUmVxdWVzdCA9IGNvbmZpZyA9PlxuICB0cmFuc2Zvcm1TaWduYXR1cmUoXG4gICAgY29uZmlnLFxuICAgIGNsb3VkaW5hcnkudXRpbHMuc2lnbl9yZXF1ZXN0KFxuICAgICAge1xuICAgICAgICB0aW1lc3RhbXA6IE1hdGgucm91bmQobmV3IERhdGUoKS5nZXRUaW1lKCkgLyAxMDAwKSxcbiAgICAgICAgZm9sZGVyOiBBUFAgPyBgJHtBUFB9L2AgOiBudWxsLFxuICAgICAgfSxcbiAgICAgIGNvbmZpZyxcbiAgICApLFxuICApO1xuXG5leHBvcnQgY29uc3QgdXBkYXRlSW1hZ2UgPSAoaWQsIHRhZ3MsIHNvdXJjZSwgY2FwdGlvbiwgY29uZmlnLCByZW1vdmVkKSA9PiB7XG4gIGNvbnN0IGNvbnRleHQgPSBbXTtcblxuICBpZiAoc291cmNlKSB7XG4gICAgY29udGV4dC5wdXNoKGBzb3VyY2U9JHtzb3VyY2V9YCk7XG4gIH1cblxuICBpZiAoY2FwdGlvbikge1xuICAgIGNvbnRleHQucHVzaChgY2FwdGlvbj0ke2NhcHRpb259YCk7XG4gIH1cblxuICBpZiAocmVtb3ZlZCkge1xuICAgIGNvbnRleHQucHVzaCgncmVtb3ZlZD10cnVlJyk7XG4gIH1cblxuICByZXR1cm4gbmV3IFByb21pc2UoKHlheSkgPT4ge1xuICAgIGNsb3VkaW5hcnkuYXBpLnVwZGF0ZShcbiAgICAgIGlkLFxuICAgICAgcmVzdWx0ID0+IHlheShyZXN1bHQpLFxuICAgICAgT2JqZWN0LmFzc2lnbih7fSwgY29uZmlnLCB7XG4gICAgICAgIHByZWZpeDogQVBQID8gYCR7QVBQfS9gIDogJycsXG4gICAgICAgIHRhZ3M6ICh0YWdzIHx8IFtdKS5qb2luKCcsJyksXG4gICAgICAgIGNvbnRleHQ6IGNvbnRleHQuam9pbignfCcpLFxuICAgICAgfSksXG4gICAgKTtcbiAgfSkudGhlbih0cmFuc2Zvcm0pO1xufTtcbiJdfQ==
