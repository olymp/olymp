import _upperFirst from 'lodash/upperFirst';

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

import { visit, Kind } from 'graphql/language';
import createTypeFetcher from './fetch-type';
import addDefinition from './add-definition';

var fetch = createTypeFetcher(function (node, value) {
  return node.kind.endsWith('TypeDefinition') && node.name && node.name.value === value;
});

var transformASTTypeToInput = function transformASTTypeToInput(type, _ref) {
  var newName = _ref.newName,
      ast = _ref.ast,
      _ref$exclude = _ref.exclude,
      exclude = _ref$exclude === undefined ? [] : _ref$exclude,
      _ref$optional = _ref.optional,
      optional = _ref$optional === undefined ? [] : _ref$optional;
  var generatedInputHistory = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];

  var definitions = ast.definitions || ast;
  return visit(type, {
    enter: function enter(node /* , key, parent, path, ancestors*/) {
      var copy = Object.assign({}, node);
      copy.directives = [];
      switch (copy.kind) {
        case Kind.OBJECT_TYPE_DEFINITION:
          copy.kind = Kind.INPUT_OBJECT_TYPE_DEFINITION;
          copy.name = Object.assign({}, copy.name);
          copy.name.value = newName;
          break;
        case Kind.FIELD_DEFINITION:
          if (exclude.indexOf(node.name.value) !== -1) {
            return null;
          } // Delete this node
          copy.kind = Kind.INPUT_VALUE_DEFINITION;
          var fieldName = copy.name.value;
          var typeName = null;
          visit(copy, _defineProperty({}, Kind.NAMED_TYPE, function (typeNode) {
            typeName = typeNode.name.value;
          }));
          var fieldType = fetch(ast, typeName);
          if (fieldType && fieldType.kind === Kind.OBJECT_TYPE_DEFINITION) {
            var inputName = _upperFirst(fieldType.name.value) + 'Input';
            if (generatedInputHistory.indexOf(inputName) === -1) {
              generatedInputHistory.push(inputName);
              if (!fetch(ast, inputName) && fieldType.name.value !== type.name.value) {
                var newInput = transformASTTypeToInput(fieldType, { newName: inputName, ast: ast }, generatedInputHistory);
                definitions.push(newInput);
              }
            }
            copy = visit(copy, _defineProperty({}, Kind.NAMED_TYPE, function (typeNode) {
              var newNode = Object.assign({}, typeNode);
              newNode.name = Object.assign({}, newNode.name);
              newNode.name.value = inputName;
              return newNode;
            }));
            if (optional.indexOf(fieldName) !== -1) {
              while (copy.type.kind === Kind.NON_NULL_TYPE) {
                copy.type = Object.assign({}, copy.type.type);
              }
            }
          }
          break;
      }
      return copy;
    }
  });
};

export default (function (ast, node) {
  var input = transformASTTypeToInput(node, {
    newName: node.name.value + 'Input',
    ast: ast.definitions
  });
  addDefinition(ast.definitions, input);
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhY2thZ2VzL2dyYXBocWwvc2VydmVyL3V0aWxzL2FkZC1pbnB1dC5lczYiXSwibmFtZXMiOlsidmlzaXQiLCJLaW5kIiwiY3JlYXRlVHlwZUZldGNoZXIiLCJhZGREZWZpbml0aW9uIiwiZmV0Y2giLCJub2RlIiwidmFsdWUiLCJraW5kIiwiZW5kc1dpdGgiLCJuYW1lIiwidHJhbnNmb3JtQVNUVHlwZVRvSW5wdXQiLCJ0eXBlIiwibmV3TmFtZSIsImFzdCIsImV4Y2x1ZGUiLCJvcHRpb25hbCIsImdlbmVyYXRlZElucHV0SGlzdG9yeSIsImRlZmluaXRpb25zIiwiZW50ZXIiLCJjb3B5IiwiT2JqZWN0IiwiYXNzaWduIiwiZGlyZWN0aXZlcyIsIk9CSkVDVF9UWVBFX0RFRklOSVRJT04iLCJJTlBVVF9PQkpFQ1RfVFlQRV9ERUZJTklUSU9OIiwiRklFTERfREVGSU5JVElPTiIsImluZGV4T2YiLCJJTlBVVF9WQUxVRV9ERUZJTklUSU9OIiwiZmllbGROYW1lIiwidHlwZU5hbWUiLCJOQU1FRF9UWVBFIiwidHlwZU5vZGUiLCJmaWVsZFR5cGUiLCJpbnB1dE5hbWUiLCJwdXNoIiwibmV3SW5wdXQiLCJuZXdOb2RlIiwiTk9OX05VTExfVFlQRSIsImlucHV0Il0sIm1hcHBpbmdzIjoiOzs7O0FBQ0EsU0FBU0EsS0FBVCxFQUFnQkMsSUFBaEIsUUFBNEIsa0JBQTVCO0FBQ0EsT0FBT0MsaUJBQVAsTUFBOEIsY0FBOUI7QUFDQSxPQUFPQyxhQUFQLE1BQTBCLGtCQUExQjs7QUFFQSxJQUFNQyxRQUFRRixrQkFDWixVQUFDRyxJQUFELEVBQU9DLEtBQVA7QUFBQSxTQUNFRCxLQUFLRSxJQUFMLENBQVVDLFFBQVYsQ0FBbUIsZ0JBQW5CLEtBQ0FILEtBQUtJLElBREwsSUFFQUosS0FBS0ksSUFBTCxDQUFVSCxLQUFWLEtBQW9CQSxLQUh0QjtBQUFBLENBRFksQ0FBZDs7QUFPQSxJQUFNSSwwQkFBMEIsU0FBMUJBLHVCQUEwQixDQUM5QkMsSUFEOEIsUUFJM0I7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YUFBL0IsRUFBOEM7QUFDNUNsQixxQkFBS1IsSUFBTCxHQUFZUyxPQUFPQyxNQUFQLENBQWMsRUFBZCxFQUFrQkYsS0FBS1IsSUFBTCxDQUFVQSxJQUE1QixDQUFaO0FBQ0Q7QUFDRjtBQUNGO0FBQ0Q7QUFqREo7QUFtREEsYUFBT1EsSUFBUDtBQUNEO0FBeERnQixHQUFaLENBQVA7QUEwREQsQ0FoRUQ7O0FBa0VBLGdCQUFlLFVBQUNOLEdBQUQsRUFBTVIsSUFBTixFQUFlO0FBQzVCLE1BQU1pQyxRQUFRNUIsd0JBQXdCTCxJQUF4QixFQUE4QjtBQUMxQ08sYUFBWVAsS0FBS0ksSUFBTCxDQUFVSCxLQUF0QixVQUQwQztBQUUxQ08sU0FBS0EsSUFBSUk7QUFGaUMsR0FBOUIsQ0FBZDtBQUlBZCxnQkFBY1UsSUFBSUksV0FBbEIsRUFBK0JxQixLQUEvQjtBQUNELENBTkQiLCJmaWxlIjoicGFja2FnZXMvZ3JhcGhxbC9zZXJ2ZXIvdXRpbHMvYWRkLWlucHV0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgdXBwZXJGaXJzdCB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyB2aXNpdCwgS2luZCB9IGZyb20gJ2dyYXBocWwvbGFuZ3VhZ2UnO1xuaW1wb3J0IGNyZWF0ZVR5cGVGZXRjaGVyIGZyb20gJy4vZmV0Y2gtdHlwZSc7XG5pbXBvcnQgYWRkRGVmaW5pdGlvbiBmcm9tICcuL2FkZC1kZWZpbml0aW9uJztcblxuY29uc3QgZmV0Y2ggPSBjcmVhdGVUeXBlRmV0Y2hlcihcbiAgKG5vZGUsIHZhbHVlKSA9PlxuICAgIG5vZGUua2luZC5lbmRzV2l0aCgnVHlwZURlZmluaXRpb24nKSAmJlxuICAgIG5vZGUubmFtZSAmJlxuICAgIG5vZGUubmFtZS52YWx1ZSA9PT0gdmFsdWVcbik7XG5cbmNvbnN0IHRyYW5zZm9ybUFTVFR5cGVUb0lucHV0ID0gKFxuICB0eXBlLFxuICB7IG5ld05hbWUsIGFzdCwgZXhjbHVkZSA9IFtdLCBvcHRpb25hbCA9IFtdIH0sXG4gIGdlbmVyYXRlZElucHV0SGlzdG9yeSA9IFtdXG4pID0+IHtcbiAgY29uc3QgZGVmaW5pdGlvbnMgPSBhc3QuZGVmaW5pdGlvbnMgfHwgYXN0O1xuICByZXR1cm4gdmlzaXQodHlwZSwge1xuICAgIGVudGVyKG5vZGUgLyogLCBrZXksIHBhcmVudCwgcGF0aCwgYW5jZXN0b3JzKi8pIHtcbiAgICAgIGxldCBjb3B5ID0gT2JqZWN0LmFzc2lnbih7fSwgbm9kZSk7XG4gICAgICBjb3B5LmRpcmVjdGl2ZXMgPSBbXTtcbiAgICAgIHN3aXRjaCAoY29weS5raW5kKSB7XG4gICAgICAgIGNhc2UgS2luZC5PQkpFQ1RfVFlQRV9ERUZJTklUSU9OOlxuICAgICAgICAgIGNvcHkua2luZCA9IEtpbmQuSU5QVVRfT0JKRUNUX1RZUEVfREVGSU5JVElPTjtcbiAgICAgICAgICBjb3B5Lm5hbWUgPSBPYmplY3QuYXNzaWduKHt9LCBjb3B5Lm5hbWUpO1xuICAgICAgICAgIGNvcHkubmFtZS52YWx1ZSA9IG5ld05hbWU7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgS2luZC5GSUVMRF9ERUZJTklUSU9OOlxuICAgICAgICAgIGlmIChleGNsdWRlLmluZGV4T2Yobm9kZS5uYW1lLnZhbHVlKSAhPT0gLTEpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgIH0gLy8gRGVsZXRlIHRoaXMgbm9kZVxuICAgICAgICAgIGNvcHkua2luZCA9IEtpbmQuSU5QVVRfVkFMVUVfREVGSU5JVElPTjtcbiAgICAgICAgICBjb25zdCBmaWVsZE5hbWUgPSBjb3B5Lm5hbWUudmFsdWU7XG4gICAgICAgICAgbGV0IHR5cGVOYW1lID0gbnVsbDtcbiAgICAgICAgICB2aXNpdChjb3B5LCB7XG4gICAgICAgICAgICBbS2luZC5OQU1FRF9UWVBFXSh0eXBlTm9kZSkge1xuICAgICAgICAgICAgICB0eXBlTmFtZSA9IHR5cGVOb2RlLm5hbWUudmFsdWU7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIGNvbnN0IGZpZWxkVHlwZSA9IGZldGNoKGFzdCwgdHlwZU5hbWUpO1xuICAgICAgICAgIGlmIChmaWVsZFR5cGUgJiYgZmllbGRUeXBlLmtpbmQgPT09IEtpbmQuT0JKRUNUX1RZUEVfREVGSU5JVElPTikge1xuICAgICAgICAgICAgY29uc3QgaW5wdXROYW1lID0gYCR7dXBwZXJGaXJzdChmaWVsZFR5cGUubmFtZS52YWx1ZSl9SW5wdXRgO1xuICAgICAgICAgICAgaWYgKGdlbmVyYXRlZElucHV0SGlzdG9yeS5pbmRleE9mKGlucHV0TmFtZSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgIGdlbmVyYXRlZElucHV0SGlzdG9yeS5wdXNoKGlucHV0TmFtZSk7XG4gICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAhZmV0Y2goYXN0LCBpbnB1dE5hbWUpICYmXG4gICAgICAgICAgICAgICAgZmllbGRUeXBlLm5hbWUudmFsdWUgIT09IHR5cGUubmFtZS52YWx1ZVxuICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdJbnB1dCA9IHRyYW5zZm9ybUFTVFR5cGVUb0lucHV0KFxuICAgICAgICAgICAgICAgICAgZmllbGRUeXBlLFxuICAgICAgICAgICAgICAgICAgeyBuZXdOYW1lOiBpbnB1dE5hbWUsIGFzdCB9LFxuICAgICAgICAgICAgICAgICAgZ2VuZXJhdGVkSW5wdXRIaXN0b3J5XG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBkZWZpbml0aW9ucy5wdXNoKG5ld0lucHV0KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29weSA9IHZpc2l0KGNvcHksIHtcbiAgICAgICAgICAgICAgW0tpbmQuTkFNRURfVFlQRV0odHlwZU5vZGUpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdOb2RlID0gT2JqZWN0LmFzc2lnbih7fSwgdHlwZU5vZGUpO1xuICAgICAgICAgICAgICAgIG5ld05vZGUubmFtZSA9IE9iamVjdC5hc3NpZ24oe30sIG5ld05vZGUubmFtZSk7XG4gICAgICAgICAgICAgICAgbmV3Tm9kZS5uYW1lLnZhbHVlID0gaW5wdXROYW1lO1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXdOb2RlO1xuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAob3B0aW9uYWwuaW5kZXhPZihmaWVsZE5hbWUpICE9PSAtMSkge1xuICAgICAgICAgICAgICB3aGlsZSAoY29weS50eXBlLmtpbmQgPT09IEtpbmQuTk9OX05VTExfVFlQRSkge1xuICAgICAgICAgICAgICAgIGNvcHkudHlwZSA9IE9iamVjdC5hc3NpZ24oe30sIGNvcHkudHlwZS50eXBlKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIHJldHVybiBjb3B5O1xuICAgIH0sXG4gIH0pO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgKGFzdCwgbm9kZSkgPT4ge1xuICBjb25zdCBpbnB1dCA9IHRyYW5zZm9ybUFTVFR5cGVUb0lucHV0KG5vZGUsIHtcbiAgICBuZXdOYW1lOiBgJHtub2RlLm5hbWUudmFsdWV9SW5wdXRgLFxuICAgIGFzdDogYXN0LmRlZmluaXRpb25zLFxuICB9KTtcbiAgYWRkRGVmaW5pdGlvbihhc3QuZGVmaW5pdGlvbnMsIGlucHV0KTtcbn07XG4iXX0=
