require('dotenv').config();
import express from 'express';
import compression from 'compression';
import session from 'express-session';
import path from 'path';
import React from 'react';
import fetch from 'isomorphic-fetch';
import { renderToString, renderToStaticMarkup } from 'react-dom/server';
import { ApolloProvider, getDataFromTree } from 'react-apollo';
import { ApolloClient, createNetworkInterface } from 'apollo-client';
import { AsyncComponentProvider, createAsyncContext, } from 'react-async-component';
import asyncBootstrapper from 'react-async-bootstrapper';
import { Provider } from 'react-fela';
import Helmet from 'react-helmet';
import helmet from 'helmet';
import template from '../templates/default';
import amp from '../templates/amp';
import { AmpProvider, UAProvider, UAParser } from 'olymp-utils';
import { GatewayProvider } from 'react-gateway';
import 'source-map-support/register';
import createRedisStore from 'connect-redis';
import fs from 'fs';
import useragent from 'express-useragent';
import sslRedirect from 'heroku-ssl-redirect';
import bodyparser from 'body-parser';
import { createFela, felaReducer } from 'olymp-fela';
import { createHistory, attachHistory, routerMiddleware, routerReducer, } from 'olymp-router';
import App from '@app';
var init = require('@app').init;
var version = +fs.statSync(__filename).mtime;
console.log('VERSION', version);
import { createStore, combineReducers, applyMiddleware, compose } from 'redux';
var RedisStore = createRedisStore(session);
global.fetch = fetch;
var isProd = process.env.NODE_ENV === 'production';
var port = parseInt(process.env.PORT, 10);
var devPort = parseInt(process.env.DEV_PORT, 10);
var clientAssetsPath = path.resolve(__dirname, '..', 'web', 'assets.json');
var clientAssets = fs.existsSync(clientAssetsPath)
    ? JSON.parse(fs.readFileSync(clientAssetsPath))
    : null;
var app = express();
app.use(helmet());
if (process.env.NODE_ENV === 'production' && process.env.URL) {
    app.use(sslRedirect());
}
app.use(compression());
app.use(useragent.express());
app.use(express.static(path.resolve(process.cwd(), 'public')));
app.use(express.static(path.resolve(process.cwd(), 'build', 'web')));
app.use(express.static(path.resolve(process.cwd(), 'node_modules', 'olymp', 'public')));
app.use(bodyparser.json());
app.use(function (req, res, next) {
    if (req.subdomains &&
        req.subdomains.length === 1 &&
        req.subdomains[0] === 'amp') {
        req.isAmp = true;
    }
    else if (req.query.amp !== undefined) {
        req.isAmp = true;
    }
    next();
});
var trust = process.env.TRUST_PROXY !== undefined ? parseInt(process.env.TRUST_PROXY) : 2;
var secure = process.env.COOKIE_SECURE !== undefined
    ? "" + process.env.COOKIE_SECURE === 'true'
    : isProd;
var domain = process.env.URL !== undefined ? process.env.URL.split('/')[2] : undefined;
if (isProd) {
    app.set('trust proxy', trust);
}
app.use(session({
    store: process.env.REDIS_URL
        ? new RedisStore({ url: process.env.REDIS_URL, logErrors: true })
        : undefined,
    resave: false,
    saveUninitialized: true,
    httpOnly: true,
    proxy: !!trust,
    domain: domain,
    secret: process.env.SESSION_SECRET || 'keyboard cat',
    cookie: {
        secure: secure,
        maxAge: 1000 * 60 * 60 * 24 * 7,
    },
}));
try {
    var server = require('@root/server');
    if (server.default) {
        server.default(app);
    }
    else {
        server(app);
    }
}
catch (err) {
    console.log('No server.js or server/index.js file found, using default settings', err);
}
app.get('*', function (req, res) {
    var networkInterface = createNetworkInterface({
        uri: process.env.GRAPHQL_URL || "http://localhost:" + port + "/graphql",
        opts: {
            credentials: 'same-origin',
            headers: req.headers,
        },
    });
    var client = new ApolloClient({
        networkInterface: networkInterface,
        dataIdFromObject: function (o) { return o.id; },
        ssrMode: true,
    });
    var ua = new UAParser(req.headers['user-agent']);
    var renderer = createFela(ua);
    var history = createHistory(req.url);
    var store = createStore(combineReducers({
        apollo: client.reducer(),
        location: routerReducer(history),
        fela: felaReducer,
    }), {}, compose(applyMiddleware(client.middleware()), applyMiddleware(routerMiddleware(history))));
    attachHistory(history, store);
    var asyncContext = createAsyncContext();
    if (typeof init !== undefined && init) {
        init({ renderer: renderer, client: client, store: store });
    }
    var context = {};
    var reactApp = (React.createElement(AsyncComponentProvider, { asyncContext: asyncContext },
        React.createElement(ApolloProvider, { store: store, client: client },
            React.createElement(Provider, { renderer: renderer },
                React.createElement(GatewayProvider, null,
                    React.createElement(UAProvider, { ua: ua },
                        React.createElement(AmpProvider, { amp: req.isAmp },
                            React.createElement(App, null))))))));
    return asyncBootstrapper(reactApp)
        .then(function () { return getDataFromTree(reactApp); })
        .then(function () {
        var reactAppString = req.isAmp
            ? renderToStaticMarkup(reactApp)
            : renderToString(reactApp);
        var scripts = req.isAmp
            ? []
            : [
                isProd
                    ? "" + clientAssets.main.js
                    : process.env.DEV_URL + "/main.js",
            ];
        var styles = req.isAmp
            ? []
            : isProd ? ["" + clientAssets.main.css] : [];
        var cssMarkup = renderer.renderToString();
        var asyncState = asyncContext.getState();
        var html = (req.isAmp ? amp : template)({
            root: reactAppString,
            scripts: scripts,
            styles: styles,
            cssMarkup: cssMarkup,
            helmet: Helmet.rewind(),
            initialState: { apollo: client.getInitialState() },
            asyncState: asyncState,
            gaTrackingId: process.env.GA_TRACKING_ID,
            hotjarId: process.env.HOTJAR_ID,
        });
        if (context.url) {
            res.status(301).setHeader('Location', context.url);
            res.end();
            return;
        }
        res.status(context.missed ? 404 : 200);
        res.send(html);
    })
        .catch(function (err) {
        console.error(err);
        res.status(500).send(err);
    });
});
export default app;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhY2thZ2VzL2NvcmUvbm9kZS9zZXJ2ZXIudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUUzQixPQUFPLE9BQU8sTUFBTSxTQUFTLENBQUM7QUFDOUIsT0FBTyxXQUFXLE1BQU0sYUFBYSxDQUFDO0FBQ3RDLE9BQU8sT0FBTyxNQUFNLGlCQUFpQixDQUFDO0FBQ3RDLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUN4QixPQUFPLEtBQUssTUFBTSxPQUFPLENBQUM7QUFDMUIsT0FBTyxLQUFLLE1BQU0sa0JBQWtCLENBQUM7QUFDckMsT0FBTyxFQUFFLGNBQWMsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3hFLE9BQU8sRUFBRSxjQUFjLEVBQUUsZUFBZSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQy9ELE9BQU8sRUFBRSxZQUFZLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckUsT0FBTyxFQUNMLHNCQUFzQixFQUN0QixrQkFBa0IsR0FDbkIsTUFBTSx1QkFBdUIsQ0FBQztBQUMvQixPQUFPLGlCQUFpQixNQUFNLDBCQUEwQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDdEMsT0FBTyxNQUFNLE1BQU0sY0FBYyxDQUFDO0FBQ2xDLE9BQU8sTUFBTSxNQUFNLFFBQVEsQ0FBQztBQUM1QixPQUFPLFFBQVEsTUFBTSxzQkFBc0IsQ0FBQztBQUM1QyxPQUFPLEdBQUcsTUFBTSxrQkFBa0IsQ0FBQztBQUNuQyxPQUFPLEVBQUUsV0FBVyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDaEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNoRCxPQUFPLDZCQUE2QixDQUFDO0FBQ3JDLE9BQU8sZ0JBQWdCLE1BQU0sZUFBZSxDQUFDO0FBQzdD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QUFDO0FBRUgsZUFBZSxHQUFHLENBQUMiLCJmaWxlIjoicGFja2FnZXMvY29yZS9ub2RlL3NlcnZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbInJlcXVpcmUoJ2RvdGVudicpLmNvbmZpZygpO1xuXG5pbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCBjb21wcmVzc2lvbiBmcm9tICdjb21wcmVzc2lvbic7XG5pbXBvcnQgc2Vzc2lvbiBmcm9tICdleHByZXNzLXNlc3Npb24nO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IGZldGNoIGZyb20gJ2lzb21vcnBoaWMtZmV0Y2gnO1xuaW1wb3J0IHsgcmVuZGVyVG9TdHJpbmcsIHJlbmRlclRvU3RhdGljTWFya3VwIH0gZnJvbSAncmVhY3QtZG9tL3NlcnZlcic7XG5pbXBvcnQgeyBBcG9sbG9Qcm92aWRlciwgZ2V0RGF0YUZyb21UcmVlIH0gZnJvbSAncmVhY3QtYXBvbGxvJztcbmltcG9ydCB7IEFwb2xsb0NsaWVudCwgY3JlYXRlTmV0d29ya0ludGVyZmFjZSB9IGZyb20gJ2Fwb2xsby1jbGllbnQnO1xuaW1wb3J0IHtcbiAgQXN5bmNDb21wb25lbnRQcm92aWRlcixcbiAgY3JlYXRlQXN5bmNDb250ZXh0LFxufSBmcm9tICdyZWFjdC1hc3luYy1jb21wb25lbnQnO1xuaW1wb3J0IGFzeW5jQm9vdHN0cmFwcGVyIGZyb20gJ3JlYWN0LWFzeW5jLWJvb3RzdHJhcHBlcic7XG5pbXBvcnQgeyBQcm92aWRlciB9IGZyb20gJ3JlYWN0LWZlbGEnO1xuaW1wb3J0IEhlbG1ldCBmcm9tICdyZWFjdC1oZWxtZXQnO1xuaW1wb3J0IGhlbG1ldCBmcm9tICdoZWxtZXQnO1xuaW1wb3J0IHRlbXBsYXRlIGZyb20gJy4uL3RlbXBsYXRlcy9kZWZhdWx0JztcbmltcG9ydCBhbXAgZnJvbSAnLi4vdGVtcGxhdGVzL2FtcCc7XG5pbXBvcnQgeyBBbXBQcm92aWRlciwgVUFQcm92aWRlciwgVUFQYXJzZXIgfSBmcm9tICdvbHltcC11dGlscyc7XG5pbXBvcnQgeyBHYXRld2F5UHJvdmlkZXIgfSBmcm9tICdyZWFjdC1nYXRld2F5JztcbmltcG9ydCAnc291cmNlLW1hcC1zdXBwb3J0L3JlZ2lzdGVyJztcbmltcG9ydCBjcmVhdGVSZWRpc1N0b3JlIGZyb20gJ2Nvbm5lY3QtcmVkaXMnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCB1c2VyYWdlbnQgZnJvbSAnZXhwcmVzcy11c2VyYWdlbnQnO1xuaW1wb3J0IHNzbFJlZGlyZWN0IGZyb20gJ2hlcm9rdS1zc2wtcmVkaXJlY3QnO1xuaW1wb3J0IGJvZHlwYXJzZXIgZnJvbSAnYm9keS1wYXJzZXInO1xuLy8gaW1wb3J0IHsgU2VydmVyIGFzIFdlYlNvY2tldFNlcnZlciB9IGZyb20gJ3dzJztcbmltcG9ydCB7IGNyZWF0ZUZlbGEsIGZlbGFSZWR1Y2VyIH0gZnJvbSAnb2x5bXAtZmVsYSc7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuaW1wb3J0IHtcbiAgY3JlYXRlSGlzdG9yeSxcbiAgYXR0YWNoSGlzdG9yeSxcbiAgcm91dGVyTWlkZGxld2FyZSxcbiAgcm91dGVyUmVkdWNlcixcbn0gZnJvbSAnb2x5bXAtcm91dGVyJztcbmltcG9ydCBBcHAgZnJvbSAnQGFwcCc7XG5cbmNvbnN0IGluaXQgPSByZXF1aXJlKCdAYXBwJykuaW5pdDtcblxuY29uc3QgdmVyc2lvbiA9ICtmcy5zdGF0U3luYyhfX2ZpbGVuYW1lKS5tdGltZTtcbmNvbnNvbGUubG9nKCdWRVJTSU9OJywgdmVyc2lvbik7XG5cbi8vIFJlZHV4IHN0dWZmXG5pbXBvcnQgeyBjcmVhdGVTdG9yZSwgY29tYmluZVJlZHVjZXJzLCBhcHBseU1pZGRsZXdhcmUsIGNvbXBvc2UgfSBmcm9tICdyZWR1eCc7XG4vLyBFbmQgUmVkdXggc3R1ZmZcblxuY29uc3QgUmVkaXNTdG9yZSA9IGNyZWF0ZVJlZGlzU3RvcmUoc2Vzc2lvbik7XG5cbi8vIGltcG9ydCB7IHJlbmRlciwgdGVtcGxhdGUgfSBmcm9tICdyYXBzY2FsbGlvbic7XG5cbmdsb2JhbC5mZXRjaCA9IGZldGNoO1xuXG5jb25zdCBpc1Byb2QgPSBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nO1xuY29uc3QgcG9ydCA9IHBhcnNlSW50KHByb2Nlc3MuZW52LlBPUlQsIDEwKTtcbmNvbnN0IGRldlBvcnQgPSBwYXJzZUludChwcm9jZXNzLmVudi5ERVZfUE9SVCwgMTApO1xuXG4vLyBDbGllbnQgYXNzZXRzXG5jb25zdCBjbGllbnRBc3NldHNQYXRoID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJ3dlYicsICdhc3NldHMuanNvbicpO1xuY29uc3QgY2xpZW50QXNzZXRzID0gZnMuZXhpc3RzU3luYyhjbGllbnRBc3NldHNQYXRoKVxuICA/IEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKGNsaWVudEFzc2V0c1BhdGgpKVxuICA6IG51bGw7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgaW1wb3J0L25vLWR5bmFtaWMtcmVxdWlyZVxuY29uc3QgYXBwID0gZXhwcmVzcygpO1xuLyphcHAuZW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuLy8gV2Vic29ja2V0IFNlcnZlclxuYXBwLmxpc3RlbldTID0gKG9wdGlvbnMpID0+IHtcbiAgY29uc3Qgd3NzID0gbmV3IFdlYlNvY2tldFNlcnZlcihvcHRpb25zKTtcbiAgd3NzLm9uKCdjb25uZWN0aW9uJywgKHNvY2tldCkgPT4ge1xuICAgIGNvbnN0IG9uUGluZyA9IChtZXNzYWdlKSA9PiB7XG4gICAgICBzb2NrZXQuc2VuZChKU09OLnN0cmluZ2lmeSh7IHR5cGU6ICdwb25nJywgdmVyc2lvbiB9KSk7XG4gICAgfTtcblxuICAgIGNvbnN0IG9uTWVzc2FnZSA9IChyYXcpID0+IHtcbiAgICAgIGlmICghcmF3KSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmIChyYXcgPT09ICdwaW5nJykge1xuICAgICAgICByZXR1cm4gb25QaW5nKHJhdyk7XG4gICAgICB9XG4gICAgICBjb25zb2xlLmxvZygnV1MnLCByYXcpO1xuICAgICAgbGV0IGpzb24gPSB7fTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGpzb24gPSBKU09OLnBhcnNlKHJhdyk7XG4gICAgICAgIGlmIChqc29uKSB7XG4gICAgICAgICAgYXBwLmVtaXR0ZXIuZW1pdCgnd3MnLCB7IGpzb24sIHJhdywgc29ja2V0IH0pO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignV2Vic29ja2V0IGVycm9yJywgZXJyKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHNvY2tldC5vbignbWVzc2FnZScsIG9uTWVzc2FnZSk7XG4gIH0pO1xuICByZXR1cm4gd3NzO1xufTtcblxuLy8gYXBwLndzcy5jbG9zZSgpO1xuLy8gLS0tKi9cblxuYXBwLnVzZShoZWxtZXQoKSk7XG5pZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdwcm9kdWN0aW9uJyAmJiBwcm9jZXNzLmVudi5VUkwpIHtcbiAgYXBwLnVzZShzc2xSZWRpcmVjdCgpKTtcbiAgLyogYXBwLnVzZSgocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICByZXMuc2V0SGVhZGVyKCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nLCBwcm9jZXNzLmVudi5VUkwpO1xuICAgIHJlcy5zZXRIZWFkZXIoJ0FjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHMnLCAnR0VULCBQT1NULCBPUFRJT05TLCBQVVQsIFBBVENILCBERUxFVEUnKTtcbiAgICByZXMuc2V0SGVhZGVyKCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJywgJ1gtUmVxdWVzdGVkLVdpdGgsY29udGVudC10eXBlJyk7XG4gICAgcmVzLnNldEhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctQ3JlZGVudGlhbHMnLCB0cnVlKTtcbiAgICBuZXh0KCk7XG4gIH0pOyovXG59XG5cbi8vIENvbXByZXNzIChnemlwKSBhc3NldHMgaW4gcHJvZHVjdGlvbi5cbmFwcC51c2UoY29tcHJlc3Npb24oKSk7XG5hcHAudXNlKHVzZXJhZ2VudC5leHByZXNzKCkpO1xuXG4vLyBTZXR1cCB0aGUgcHVibGljIGRpcmVjdG9yeSBzbyB0aGF0IHdlIGNhbiBzZXJ2ZXIgc3RhdGljIGFzc2V0cy5cbmFwcC51c2UoZXhwcmVzcy5zdGF0aWMocGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksICdwdWJsaWMnKSkpO1xuYXBwLnVzZShleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgJ2J1aWxkJywgJ3dlYicpKSk7XG5hcHAudXNlKFxuICBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgJ25vZGVfbW9kdWxlcycsICdvbHltcCcsICdwdWJsaWMnKSlcbik7XG5hcHAudXNlKGJvZHlwYXJzZXIuanNvbigpKTtcblxuYXBwLnVzZSgocmVxLCByZXMsIG5leHQpID0+IHtcbiAgaWYgKFxuICAgIHJlcS5zdWJkb21haW5zICYmXG4gICAgcmVxLnN1YmRvbWFpbnMubGVuZ3RoID09PSAxICYmXG4gICAgcmVxLnN1YmRvbWFpbnNbMF0gPT09ICdhbXAnXG4gICkge1xuICAgIHJlcS5pc0FtcCA9IHRydWU7XG4gIH0gZWxzZSBpZiAocmVxLnF1ZXJ5LmFtcCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgcmVxLmlzQW1wID0gdHJ1ZTtcbiAgfVxuICBuZXh0KCk7XG59KTtcblxuY29uc3QgdHJ1c3QgPVxuICBwcm9jZXNzLmVudi5UUlVTVF9QUk9YWSAhPT0gdW5kZWZpbmVkID8gcGFyc2VJbnQocHJvY2Vzcy5lbnYuVFJVU1RfUFJPWFkpIDogMjtcbmNvbnN0IHNlY3VyZSA9XG4gIHByb2Nlc3MuZW52LkNPT0tJRV9TRUNVUkUgIT09IHVuZGVmaW5lZFxuICAgID8gYCR7cHJvY2Vzcy5lbnYuQ09PS0lFX1NFQ1VSRX1gID09PSAndHJ1ZSdcbiAgICA6IGlzUHJvZDtcbmNvbnN0IGRvbWFpbiA9XG4gIHByb2Nlc3MuZW52LlVSTCAhPT0gdW5kZWZpbmVkID8gcHJvY2Vzcy5lbnYuVVJMLnNwbGl0KCcvJylbMl0gOiB1bmRlZmluZWQ7XG5cbmlmIChpc1Byb2QpIHtcbiAgYXBwLnNldCgndHJ1c3QgcHJveHknLCB0cnVzdCk7XG59XG5hcHAudXNlKFxuICBzZXNzaW9uKHtcbiAgICBzdG9yZTogcHJvY2Vzcy5lbnYuUkVESVNfVVJMXG4gICAgICA/IG5ldyBSZWRpc1N0b3JlKHsgdXJsOiBwcm9jZXNzLmVudi5SRURJU19VUkwsIGxvZ0Vycm9yczogdHJ1ZSB9KVxuICAgICAgOiB1bmRlZmluZWQsXG4gICAgcmVzYXZlOiBmYWxzZSxcbiAgICBzYXZlVW5pbml0aWFsaXplZDogdHJ1ZSxcbiAgICBodHRwT25seTogdHJ1ZSxcbiAgICBwcm94eTogISF0cnVzdCxcbiAgICBkb21haW4sXG4gICAgc2VjcmV0OiBwcm9jZXNzLmVudi5TRVNTSU9OX1NFQ1JFVCB8fCAna2V5Ym9hcmQgY2F0JyxcbiAgICBjb29raWU6IHtcbiAgICAgIHNlY3VyZSxcbiAgICAgIG1heEFnZTogMTAwMCAqIDYwICogNjAgKiAyNCAqIDcsIC8vIDcgZGF5c1xuICAgIH0sXG4gIH0pXG4pO1xuXG50cnkge1xuICBjb25zdCBzZXJ2ZXIgPSByZXF1aXJlKCdAcm9vdC9zZXJ2ZXInKTtcbiAgaWYgKHNlcnZlci5kZWZhdWx0KSB7XG4gICAgc2VydmVyLmRlZmF1bHQoYXBwKTtcbiAgfSBlbHNlIHtcbiAgICBzZXJ2ZXIoYXBwKTtcbiAgfVxufSBjYXRjaCAoZXJyKSB7XG4gIGNvbnNvbGUubG9nKFxuICAgICdObyBzZXJ2ZXIuanMgb3Igc2VydmVyL2luZGV4LmpzIGZpbGUgZm91bmQsIHVzaW5nIGRlZmF1bHQgc2V0dGluZ3MnLFxuICAgIGVyclxuICApO1xufVxuXG4vLyBTZXR1cCBzZXJ2ZXIgc2lkZSByb3V0aW5nLlxuYXBwLmdldCgnKicsIChyZXEsIHJlcykgPT4ge1xuICBjb25zdCBuZXR3b3JrSW50ZXJmYWNlID0gY3JlYXRlTmV0d29ya0ludGVyZmFjZSh7XG4gICAgdXJpOiBwcm9jZXNzLmVudi5HUkFQSFFMX1VSTCB8fCBgaHR0cDovL2xvY2FsaG9zdDoke3BvcnR9L2dyYXBocWxgLFxuICAgIG9wdHM6IHtcbiAgICAgIGNyZWRlbnRpYWxzOiAnc2FtZS1vcmlnaW4nLFxuICAgICAgaGVhZGVyczogcmVxLmhlYWRlcnMsXG4gICAgfSxcbiAgfSk7XG4gIGNvbnN0IGNsaWVudCA9IG5ldyBBcG9sbG9DbGllbnQoe1xuICAgIG5ldHdvcmtJbnRlcmZhY2UsXG4gICAgZGF0YUlkRnJvbU9iamVjdDogbyA9PiBvLmlkLFxuICAgIHNzck1vZGU6IHRydWUsXG4gIH0pO1xuICBjb25zdCB1YSA9IG5ldyBVQVBhcnNlcihyZXEuaGVhZGVyc1sndXNlci1hZ2VudCddKTtcbiAgY29uc3QgcmVuZGVyZXIgPSBjcmVhdGVGZWxhKHVhKTtcbiAgY29uc3QgaGlzdG9yeSA9IGNyZWF0ZUhpc3RvcnkocmVxLnVybCk7XG5cbiAgY29uc3Qgc3RvcmUgPSBjcmVhdGVTdG9yZShcbiAgICBjb21iaW5lUmVkdWNlcnMoe1xuICAgICAgYXBvbGxvOiBjbGllbnQucmVkdWNlcigpLFxuICAgICAgbG9jYXRpb246IHJvdXRlclJlZHVjZXIoaGlzdG9yeSksXG4gICAgICBmZWxhOiBmZWxhUmVkdWNlcixcbiAgICB9KSxcbiAgICB7fSxcbiAgICBjb21wb3NlKFxuICAgICAgYXBwbHlNaWRkbGV3YXJlKGNsaWVudC5taWRkbGV3YXJlKCkpLFxuICAgICAgYXBwbHlNaWRkbGV3YXJlKHJvdXRlck1pZGRsZXdhcmUoaGlzdG9yeSkpXG4gICAgKVxuICApO1xuICBhdHRhY2hIaXN0b3J5KGhpc3RvcnksIHN0b3JlKTtcblxuICBjb25zdCBhc3luY0NvbnRleHQgPSBjcmVhdGVBc3luY0NvbnRleHQoKTtcblxuICAvLyBDcmVhdGUgb3VyIFJlYWN0IGFwcGxpY2F0aW9uIGFuZCByZW5kZXIgaXQgaW50byBhIHN0cmluZy5cbiAgaWYgKHR5cGVvZiBpbml0ICE9PSB1bmRlZmluZWQgJiYgaW5pdCkge1xuICAgIGluaXQoeyByZW5kZXJlciwgY2xpZW50LCBzdG9yZSB9KTtcbiAgfVxuXG4gIGNvbnN0IGNvbnRleHQgPSB7fTtcbiAgY29uc3QgcmVhY3RBcHAgPSAoXG4gICAgPEFzeW5jQ29tcG9uZW50UHJvdmlkZXIgYXN5bmNDb250ZXh0PXthc3luY0NvbnRleHR9PlxuICAgICAgPEFwb2xsb1Byb3ZpZGVyIHN0b3JlPXtzdG9yZX0gY2xpZW50PXtjbGllbnR9PlxuICAgICAgICA8UHJvdmlkZXIgcmVuZGVyZXI9e3JlbmRlcmVyfT5cbiAgICAgICAgICA8R2F0ZXdheVByb3ZpZGVyPlxuICAgICAgICAgICAgPFVBUHJvdmlkZXIgdWE9e3VhfT5cbiAgICAgICAgICAgICAgPEFtcFByb3ZpZGVyIGFtcD17cmVxLmlzQW1wfT5cbiAgICAgICAgICAgICAgICA8QXBwIC8+XG4gICAgICAgICAgICAgIDwvQW1wUHJvdmlkZXI+XG4gICAgICAgICAgICA8L1VBUHJvdmlkZXI+XG4gICAgICAgICAgPC9HYXRld2F5UHJvdmlkZXI+XG4gICAgICAgIDwvUHJvdmlkZXI+XG4gICAgICA8L0Fwb2xsb1Byb3ZpZGVyPlxuICAgIDwvQXN5bmNDb21wb25lbnRQcm92aWRlcj5cbiAgKTtcblxuICByZXR1cm4gYXN5bmNCb290c3RyYXBwZXIocmVhY3RBcHApXG4gICAgLnRoZW4oKCkgPT4gZ2V0RGF0YUZyb21UcmVlKHJlYWN0QXBwKSlcbiAgICAudGhlbigoKSA9PiB7XG4gICAgICBjb25zdCByZWFjdEFwcFN0cmluZyA9IHJlcS5pc0FtcFxuICAgICAgICA/IHJlbmRlclRvU3RhdGljTWFya3VwKHJlYWN0QXBwKVxuICAgICAgICA6IHJlbmRlclRvU3RyaW5nKHJlYWN0QXBwKTtcbiAgICAgIGNvbnN0IHNjcmlwdHMgPSByZXEuaXNBbXBcbiAgICAgICAgPyBbXVxuICAgICAgICA6IFtcbiAgICAgICAgICAgIGlzUHJvZFxuICAgICAgICAgICAgICA/IGAke2NsaWVudEFzc2V0cy5tYWluLmpzfWBcbiAgICAgICAgICAgICAgOiBgJHtwcm9jZXNzLmVudi5ERVZfVVJMfS9tYWluLmpzYCxcbiAgICAgICAgICBdO1xuICAgICAgY29uc3Qgc3R5bGVzID0gcmVxLmlzQW1wXG4gICAgICAgID8gW11cbiAgICAgICAgOiBpc1Byb2QgPyBbYCR7Y2xpZW50QXNzZXRzLm1haW4uY3NzfWBdIDogW107XG4gICAgICBjb25zdCBjc3NNYXJrdXAgPSByZW5kZXJlci5yZW5kZXJUb1N0cmluZygpO1xuICAgICAgY29uc3QgYXN5bmNTdGF0ZSA9IGFzeW5jQ29udGV4dC5nZXRTdGF0ZSgpO1xuXG4gICAgICAvLyBHZW5lcmF0ZSB0aGUgaHRtbCByZXMuXG4gICAgICBjb25zdCBodG1sID0gKHJlcS5pc0FtcCA/IGFtcCA6IHRlbXBsYXRlKSh7XG4gICAgICAgIHJvb3Q6IHJlYWN0QXBwU3RyaW5nLFxuICAgICAgICBzY3JpcHRzLFxuICAgICAgICBzdHlsZXMsXG4gICAgICAgIGNzc01hcmt1cCxcbiAgICAgICAgaGVsbWV0OiBIZWxtZXQucmV3aW5kKCksXG4gICAgICAgIGluaXRpYWxTdGF0ZTogeyBhcG9sbG86IGNsaWVudC5nZXRJbml0aWFsU3RhdGUoKSB9LFxuICAgICAgICBhc3luY1N0YXRlLFxuICAgICAgICBnYVRyYWNraW5nSWQ6IHByb2Nlc3MuZW52LkdBX1RSQUNLSU5HX0lELFxuICAgICAgICBob3RqYXJJZDogcHJvY2Vzcy5lbnYuSE9USkFSX0lELFxuICAgICAgfSk7XG5cbiAgICAgIC8vIENoZWNrIGlmIHRoZSByZW5kZXIgcmVzdWx0IGNvbnRhaW5zIGEgcmVkaXJlY3QsIGlmIHNvIHdlIG5lZWQgdG8gc2V0XG4gICAgICAvLyB0aGUgc3BlY2lmaWMgc3RhdHVzIGFuZCByZWRpcmVjdCBoZWFkZXIgYW5kIGVuZCB0aGUgcmVzLlxuICAgICAgaWYgKGNvbnRleHQudXJsKSB7XG4gICAgICAgIHJlcy5zdGF0dXMoMzAxKS5zZXRIZWFkZXIoJ0xvY2F0aW9uJywgY29udGV4dC51cmwpO1xuICAgICAgICByZXMuZW5kKCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgcmVzLnN0YXR1cyhjb250ZXh0Lm1pc3NlZCA/IDQwNCA6IDIwMCk7XG4gICAgICByZXMuc2VuZChodG1sKTtcbiAgICAgIC8vIHJlc3BvbnNlUmVuZGVyZXIudG9TdHJlYW0oKS5waXBlKHJlc3BvbnNlKTtcbiAgICB9KVxuICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLnNlbmQoZXJyKTtcbiAgICB9KTtcbn0pO1xuXG5leHBvcnQgZGVmYXVsdCBhcHA7XG4iXX0=
