#!/usr/bin/env node
var fs = require('fs');
var path = require('path');
var rimraf = require('rimraf');
var webpack = require('webpack');
var urlUtil = require('url');
require('dotenv').config();
var createConfig = require(path.resolve(__dirname, '..', 'webpack-config.js'));
var command = process.argv[process.argv.length - 1];
if (['start', 'build'].includes(command)) {
    process.env.NODE_ENV = 'production';
}
var _a = process.env, SSR = _a.SSR, SERVERLESS = _a.SERVERLESS, NODE_ENV = _a.NODE_ENV, PORT = _a.PORT, URL = _a.URL;
var ssr = SSR != 'false';
var serverless = SERVERLESS == 'true';
if (command === 'dev') {
    var port = parseInt(PORT, 10);
    var url = new urlUtil.URL(URL || "http://localhost:" + port);
    var devPort = serverless ? port : port + 2;
    var devUrl = serverless
        ? url
        : new urlUtil.URL(url.protocol + "//" + url.hostname + ":" + devPort);
    var notifier_1 = require('node-notifier');
    var compiler = void 0;
    var watch = {
        aggregateTimeout: 300,
        poll: false,
        ignored: /node_modules/,
    };
    if (serverless) {
        compiler = webpack([
            createConfig({
                target: 'web',
                mode: 'development',
                devPort: devPort,
                devUrl: devUrl,
                ssr: ssr,
                serverless: serverless,
            }),
        ]);
    }
    else {
        compiler = webpack([
            createConfig({
                target: 'web',
                mode: 'development',
                devPort: devPort,
                devUrl: devUrl,
                ssr: ssr,
                serverless: serverless,
            }),
            createConfig({
                target: 'node',
                mode: 'development',
                devPort: devPort,
                devUrl: devUrl,
                ssr: ssr,
                serverless: serverless,
            }),
        ]);
        compiler.compilers[1].watch(watch, function (err, compilation) {
            if (err) {
                return console.log('[webpack] error:', err);
            }
            var stats = compilation.stats || [compilation];
            console.log('[webpack] the following asset bundles were built:');
            stats.forEach(function (c) { return console.log(c.toString()); });
            notifier_1.notify('Ready');
        });
    }
    var WebpackDevServer = require('webpack-dev-server');
    var server = new WebpackDevServer(compiler.compilers[0], {
        headers: {
            'Access-Control-Allow-Origin': '*',
        },
        watchOptions: watch,
        host: devUrl.hostname,
        port: devUrl.port,
        disableHostCheck: true,
        historyApiFallback: true,
        hot: true,
        stats: {
            colors: true,
            hash: false,
            version: false,
            timings: false,
            assets: false,
            chunks: false,
            modules: false,
            reasons: false,
            children: false,
            source: false,
            errors: true,
            errorDetails: true,
            warnings: false,
            publicPath: false,
        },
    });
    server.listen(devPort);
}
else if (command === 'build') {
    rimraf.sync(path.resolve(process.cwd(), '.dist'));
    process.env.NODE_ENV = 'production';
    var configs = [
        createConfig({ target: 'web', mode: 'production', ssr: ssr, serverless: serverless }),
    ];
    if (!serverless) {
        configs.push(createConfig({ target: 'node', mode: 'production', ssr: ssr, serverless: serverless }));
    }
    var compiler = webpack(configs);
    compiler.run(function (err, compilation) {
        if (err) {
            console.error(err);
            return process.exit(1);
        }
        var stats = compilation.stats || [compilation];
        console.log('[webpack] the following asset bundles were built:');
        stats.forEach(function (c) { return console.log(c.toString()); });
    });
}
else if (command.indexOf('build:') === 0) {
    var target = command.split(':')[1];
    rimraf.sync(path.resolve(process.cwd(), '.dist', target));
    process.env.NODE_ENV = 'production';
    var compiler = webpack([
        createConfig({ target: target, mode: 'production', ssr: ssr, serverless: serverless }),
    ]);
    compiler.run(function (err, compilation) {
        if (err) {
            console.error(err);
            return process.exit(1);
        }
        var stats = compilation.stats || [compilation];
        console.log('[webpack] the following asset bundles were built:');
        stats.forEach(function (c) { return console.log(c.toString()); });
        stats.forEach(function (c) {
            return fs.writeFileSync(path.resolve(__dirname, 'stats.json'), c.toJson());
        });
    });
}
else if (command === 'start') {
    require(path.resolve(process.cwd(), '.dist', 'node', 'main'));
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,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Q0FBQyxDQUFDO0lBQ0gsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFDLEdBQUcsRUFBRSxXQUFXO1FBQzVCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDUixPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ25CLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3pCLENBQUM7UUFDRCxJQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsS0FBSyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDakQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtREFBbUQsQ0FBQyxDQUFDO1FBQ2pFLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxFQUF6QixDQUF5QixDQUFDLENBQUM7UUFDOUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFBLENBQUM7WUFDYixPQUFBLEVBQUUsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQW5FLENBQW1FLENBQ3BFLENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBTyxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFDL0IsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztBQUNoRSxDQUFDIiwiZmlsZSI6InBhY2thZ2VzL2FwcC9iaW4vb2x5bXAuanMiLCJzb3VyY2VzQ29udGVudCI6WyIjIS91c3IvYmluL2VudiBub2RlXG5cbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCByaW1yYWYgPSByZXF1aXJlKCdyaW1yYWYnKTtcbmNvbnN0IHdlYnBhY2sgPSByZXF1aXJlKCd3ZWJwYWNrJyk7XG5jb25zdCB1cmxVdGlsID0gcmVxdWlyZSgndXJsJyk7XG5yZXF1aXJlKCdkb3RlbnYnKS5jb25maWcoKTtcblxuY29uc3QgY3JlYXRlQ29uZmlnID0gcmVxdWlyZShwYXRoLnJlc29sdmUoXG4gIF9fZGlybmFtZSxcbiAgJy4uJyxcbiAgJ3dlYnBhY2stY29uZmlnLmpzJ1xuKSk7XG5cbmNvbnN0IGNvbW1hbmQgPSBwcm9jZXNzLmFyZ3ZbcHJvY2Vzcy5hcmd2Lmxlbmd0aCAtIDFdO1xuXG4vKiBjb25zdCBleGlzdHMgPSAocCwgdGhyb3dFcnJvcikgPT4ge1xuICBjb25zdCBkb2VzRXhpc3QgPSBmcy5leGlzdHNTeW5jKHBhdGgucmVzb2x2ZShhcHBSb290RGlyLmdldCgpLCBgJHtwfS5qc2ApKSB8fCBmcy5leGlzdHNTeW5jKHBhdGgucmVzb2x2ZShhcHBSb290RGlyLmdldCgpLCBwLCAnaW5kZXguanMnKSk7XG4gIGlmICghZG9lc0V4aXN0ICYmIHRocm93RXJyb3IpIHRocm93IG5ldyBFcnJvcihgJHtwfSBub3QgZm91bmQgaW4geW91ciByb290IGRpciFgKTtcbiAgZWxzZSBpZiAoIWRvZXNFeGlzdCkgY29uc29sZS5sb2coYCR7cH0gbm90IGZvdW5kIGluIHlvdXIgcm9vdCBkaXIhYCk7XG4gIHJldHVybiBkb2VzRXhpc3Q7XG59O1xuXG5leGlzdHMoJ3NlcnZlcicpO1xuZXhpc3RzKCdhcHAnLCB0cnVlKTtcblxucmVxdWlyZSgnYmFiZWwtcmVnaXN0ZXInKSh7XG4gIHByZXNldHM6IFtcbiAgICBbcmVxdWlyZS5yZXNvbHZlKCdiYWJlbC1wcmVzZXQtZW52JyksIHsgdGFyZ2V0czogeyBub2RlOiB0cnVlIH0gfV0sXG4gICAgcmVxdWlyZS5yZXNvbHZlKCdiYWJlbC1wcmVzZXQtc3RhZ2UtMycpLFxuICAgIHJlcXVpcmUucmVzb2x2ZSgnYmFiZWwtcHJlc2V0LXJlYWN0JyksXG4gIF0sXG4gIG9ubHk6IFtcbiAgICBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAndG9vbHMnKSxcbiAgICBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnc3JjJyksXG4gICAgcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJ2NvbmZpZycpLFxuICAgIHBhdGgucmVzb2x2ZShhcHBSb290RGlyLmdldCgpLCAndW5pdmVyc2FsbHkuY29uZmlnLmpzJylcbiAgXSxcbn0pOyovXG5cbmlmIChbJ3N0YXJ0JywgJ2J1aWxkJ10uaW5jbHVkZXMoY29tbWFuZCkpIHtcbiAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPSAncHJvZHVjdGlvbic7XG59XG5cbmNvbnN0IHsgU1NSLCBTRVJWRVJMRVNTLCBOT0RFX0VOViwgUE9SVCwgVVJMIH0gPSBwcm9jZXNzLmVudjtcblxuY29uc3Qgc3NyID0gU1NSICE9ICdmYWxzZSc7XG5jb25zdCBzZXJ2ZXJsZXNzID0gU0VSVkVSTEVTUyA9PSAndHJ1ZSc7XG5cbmlmIChjb21tYW5kID09PSAnZGV2Jykge1xuICBjb25zdCBwb3J0ID0gcGFyc2VJbnQoUE9SVCwgMTApO1xuICBjb25zdCB1cmwgPSBuZXcgdXJsVXRpbC5VUkwoVVJMIHx8IGBodHRwOi8vbG9jYWxob3N0OiR7cG9ydH1gKTtcbiAgY29uc3QgZGV2UG9ydCA9IHNlcnZlcmxlc3MgPyBwb3J0IDogcG9ydCArIDI7XG4gIGNvbnN0IGRldlVybCA9IHNlcnZlcmxlc3NcbiAgICA/IHVybFxuICAgIDogbmV3IHVybFV0aWwuVVJMKGAke3VybC5wcm90b2NvbH0vLyR7dXJsLmhvc3RuYW1lfToke2RldlBvcnR9YCk7XG5cbiAgY29uc3Qgbm90aWZpZXIgPSByZXF1aXJlKCdub2RlLW5vdGlmaWVyJyk7XG5cbiAgbGV0IGNvbXBpbGVyO1xuICBjb25zdCB3YXRjaCA9IHtcbiAgICBhZ2dyZWdhdGVUaW1lb3V0OiAzMDAsXG4gICAgcG9sbDogZmFsc2UsXG4gICAgaWdub3JlZDogL25vZGVfbW9kdWxlcy8sXG4gIH07XG4gIGlmIChzZXJ2ZXJsZXNzKSB7XG4gICAgY29tcGlsZXIgPSB3ZWJwYWNrKFtcbiAgICAgIGNyZWF0ZUNvbmZpZyh7XG4gICAgICAgIHRhcmdldDogJ3dlYicsXG4gICAgICAgIG1vZGU6ICdkZXZlbG9wbWVudCcsXG4gICAgICAgIGRldlBvcnQsXG4gICAgICAgIGRldlVybCxcbiAgICAgICAgc3NyLFxuICAgICAgICBzZXJ2ZXJsZXNzLFxuICAgICAgfSksXG4gICAgXSk7XG4gIH0gZWxzZSB7XG4gICAgY29tcGlsZXIgPSB3ZWJwYWNrKFtcbiAgICAgIGNyZWF0ZUNvbmZpZyh7XG4gICAgICAgIHRhcmdldDogJ3dlYicsXG4gICAgICAgIG1vZGU6ICdkZXZlbG9wbWVudCcsXG4gICAgICAgIGRldlBvcnQsXG4gICAgICAgIGRldlVybCxcbiAgICAgICAgc3NyLFxuICAgICAgICBzZXJ2ZXJsZXNzLFxuICAgICAgfSksXG4gICAgICBjcmVhdGVDb25maWcoe1xuICAgICAgICB0YXJnZXQ6ICdub2RlJyxcbiAgICAgICAgbW9kZTogJ2RldmVsb3BtZW50JyxcbiAgICAgICAgZGV2UG9ydCxcbiAgICAgICAgZGV2VXJsLFxuICAgICAgICBzc3IsXG4gICAgICAgIHNlcnZlcmxlc3MsXG4gICAgICB9KSxcbiAgICBdKTtcbiAgICBjb21waWxlci5jb21waWxlcnNbMV0ud2F0Y2god2F0Y2gsIChlcnIsIGNvbXBpbGF0aW9uKSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIHJldHVybiBjb25zb2xlLmxvZygnW3dlYnBhY2tdIGVycm9yOicsIGVycik7XG4gICAgICB9XG4gICAgICBjb25zdCBzdGF0cyA9IGNvbXBpbGF0aW9uLnN0YXRzIHx8IFtjb21waWxhdGlvbl07XG4gICAgICBjb25zb2xlLmxvZygnW3dlYnBhY2tdIHRoZSBmb2xsb3dpbmcgYXNzZXQgYnVuZGxlcyB3ZXJlIGJ1aWx0OicpO1xuICAgICAgc3RhdHMuZm9yRWFjaChjID0+IGNvbnNvbGUubG9nKGMudG9TdHJpbmcoKSkpO1xuICAgICAgbm90aWZpZXIubm90aWZ5KCdSZWFkeScpO1xuICAgIH0pO1xuICB9XG4gIGNvbnN0IFdlYnBhY2tEZXZTZXJ2ZXIgPSByZXF1aXJlKCd3ZWJwYWNrLWRldi1zZXJ2ZXInKTtcbiAgY29uc3Qgc2VydmVyID0gbmV3IFdlYnBhY2tEZXZTZXJ2ZXIoY29tcGlsZXIuY29tcGlsZXJzWzBdLCB7XG4gICAgaGVhZGVyczoge1xuICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICB9LFxuICAgIHdhdGNoT3B0aW9uczogd2F0Y2gsXG4gICAgaG9zdDogZGV2VXJsLmhvc3RuYW1lLFxuICAgIHBvcnQ6IGRldlVybC5wb3J0LFxuICAgIGRpc2FibGVIb3N0Q2hlY2s6IHRydWUsXG4gICAgaGlzdG9yeUFwaUZhbGxiYWNrOiB0cnVlLFxuICAgIGhvdDogdHJ1ZSxcbiAgICBzdGF0czoge1xuICAgICAgY29sb3JzOiB0cnVlLFxuICAgICAgaGFzaDogZmFsc2UsXG4gICAgICB2ZXJzaW9uOiBmYWxzZSxcbiAgICAgIHRpbWluZ3M6IGZhbHNlLFxuICAgICAgYXNzZXRzOiBmYWxzZSxcbiAgICAgIGNodW5rczogZmFsc2UsXG4gICAgICBtb2R1bGVzOiBmYWxzZSxcbiAgICAgIHJlYXNvbnM6IGZhbHNlLFxuICAgICAgY2hpbGRyZW46IGZhbHNlLFxuICAgICAgc291cmNlOiBmYWxzZSxcbiAgICAgIGVycm9yczogdHJ1ZSxcbiAgICAgIGVycm9yRGV0YWlsczogdHJ1ZSxcbiAgICAgIHdhcm5pbmdzOiBmYWxzZSxcbiAgICAgIHB1YmxpY1BhdGg6IGZhbHNlLFxuICAgIH0sXG4gIH0pO1xuICBzZXJ2ZXIubGlzdGVuKGRldlBvcnQpO1xufSBlbHNlIGlmIChjb21tYW5kID09PSAnYnVpbGQnKSB7XG4gIHJpbXJhZi5zeW5jKHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCAnLmRpc3QnKSk7XG4gIHByb2Nlc3MuZW52Lk5PREVfRU5WID0gJ3Byb2R1Y3Rpb24nO1xuICBjb25zdCBjb25maWdzID0gW1xuICAgIGNyZWF0ZUNvbmZpZyh7IHRhcmdldDogJ3dlYicsIG1vZGU6ICdwcm9kdWN0aW9uJywgc3NyLCBzZXJ2ZXJsZXNzIH0pLFxuICBdO1xuICBpZiAoIXNlcnZlcmxlc3MpIHtcbiAgICBjb25maWdzLnB1c2goXG4gICAgICBjcmVhdGVDb25maWcoeyB0YXJnZXQ6ICdub2RlJywgbW9kZTogJ3Byb2R1Y3Rpb24nLCBzc3IsIHNlcnZlcmxlc3MgfSlcbiAgICApO1xuICB9XG4gIGNvbnN0IGNvbXBpbGVyID0gd2VicGFjayhjb25maWdzKTtcbiAgY29tcGlsZXIucnVuKChlcnIsIGNvbXBpbGF0aW9uKSA9PiB7XG4gICAgaWYgKGVycikge1xuICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgcmV0dXJuIHByb2Nlc3MuZXhpdCgxKTtcbiAgICB9XG4gICAgY29uc3Qgc3RhdHMgPSBjb21waWxhdGlvbi5zdGF0cyB8fCBbY29tcGlsYXRpb25dO1xuICAgIGNvbnNvbGUubG9nKCdbd2VicGFja10gdGhlIGZvbGxvd2luZyBhc3NldCBidW5kbGVzIHdlcmUgYnVpbHQ6Jyk7XG4gICAgLyogc3RhdHMuZm9yRWFjaChjID0+XG4gICAgICBmcy53cml0ZUZpbGVTeW5jKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICdzdGF0cy5qc29uJyksIGMudG9Kc29uKCkpXG4gICAgKTsgKi9cbiAgICBzdGF0cy5mb3JFYWNoKGMgPT4gY29uc29sZS5sb2coYy50b1N0cmluZygpKSk7XG4gIH0pO1xufSBlbHNlIGlmIChjb21tYW5kLmluZGV4T2YoJ2J1aWxkOicpID09PSAwKSB7XG4gIGNvbnN0IHRhcmdldCA9IGNvbW1hbmQuc3BsaXQoJzonKVsxXTtcbiAgcmltcmFmLnN5bmMocGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksICcuZGlzdCcsIHRhcmdldCkpO1xuICBwcm9jZXNzLmVudi5OT0RFX0VOViA9ICdwcm9kdWN0aW9uJztcbiAgY29uc3QgY29tcGlsZXIgPSB3ZWJwYWNrKFtcbiAgICBjcmVhdGVDb25maWcoeyB0YXJnZXQsIG1vZGU6ICdwcm9kdWN0aW9uJywgc3NyLCBzZXJ2ZXJsZXNzIH0pLFxuICBdKTtcbiAgY29tcGlsZXIucnVuKChlcnIsIGNvbXBpbGF0aW9uKSA9PiB7XG4gICAgaWYgKGVycikge1xuICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgcmV0dXJuIHByb2Nlc3MuZXhpdCgxKTtcbiAgICB9XG4gICAgY29uc3Qgc3RhdHMgPSBjb21waWxhdGlvbi5zdGF0cyB8fCBbY29tcGlsYXRpb25dO1xuICAgIGNvbnNvbGUubG9nKCdbd2VicGFja10gdGhlIGZvbGxvd2luZyBhc3NldCBidW5kbGVzIHdlcmUgYnVpbHQ6Jyk7XG4gICAgc3RhdHMuZm9yRWFjaChjID0+IGNvbnNvbGUubG9nKGMudG9TdHJpbmcoKSkpO1xuICAgIHN0YXRzLmZvckVhY2goYyA9PlxuICAgICAgZnMud3JpdGVGaWxlU3luYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnc3RhdHMuanNvbicpLCBjLnRvSnNvbigpKVxuICAgICk7XG4gIH0pO1xufSBlbHNlIGlmIChjb21tYW5kID09PSAnc3RhcnQnKSB7XG4gIHJlcXVpcmUocGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksICcuZGlzdCcsICdub2RlJywgJ21haW4nKSk7XG59XG4iXX0=
