#!/usr/bin/env node
var __assign = (this && this.__assign) || Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
        s = arguments[i];
        for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
            t[p] = s[p];
    }
    return t;
};
var fs = require('fs');
var path = require('path');
var rimraf = require('rimraf');
var webpack = require('webpack');
var urlUtil = require('url');
var notifier = require('node-notifier');
var jsonfile = require('jsonfile');
var merge = require('deepmerge');
var argv = require('minimist')(process.argv.slice(1));
require('dotenv').config();
var createConfig = require(path.resolve(__dirname, '..', 'webpack-config.js'));
var root = process.cwd();
var olymprc = jsonfile.readFileSync(path.resolve(root, '.olymprc'), {
    throws: false,
});
if (olymprc.extends) {
    var topFolder_1 = path.resolve(__dirname, '..', '..');
    var concatMerge_1 = function (destinationArray, sourceArray, options) {
        return destinationArray.concat(sourceArray);
    };
    var requireFirst_1 = function (name) {
        return (jsonfile.readFileSync(path.resolve(topFolder_1, name, '.olymprc'), { throws: false }) ||
            jsonfile.readFileSync(path.resolve(topFolder_1, "olymp-" + name + ", '.olymprc'"), {
                throws: false,
            }) ||
            {});
    };
    olymprc = olymprc.extends.reduce(function (rc, item) { return merge(requireFirst_1(item), rc, { arrayMerge: concatMerge_1 }); }, olymprc);
}
var command = argv._[1];
if (['start', 'build'].includes(command)) {
    process.env.NODE_ENV = 'production';
}
var _a = process.env, SSR = _a.SSR, SERVERLESS = _a.SERVERLESS, NODE_ENV = _a.NODE_ENV, PORT = _a.PORT, URL = _a.URL;
var ssr = SSR != 'false';
var serverless = SERVERLESS == 'true';
if (command === 'dev') {
    var port = parseInt(PORT, 10);
    var url = new urlUtil.URL(URL || "http://localhost:" + port);
    var devPort = serverless ? port : port + 2;
    var devUrl = serverless
        ? url
        : new urlUtil.URL(url.protocol + "//" + url.hostname + ":" + devPort);
    var compiler = void 0;
    var watch = {
        aggregateTimeout: 300,
        poll: false,
        ignored: /node_modules/,
    };
    if (serverless) {
        compiler = webpack([
            createConfig(__assign({ target: 'web', mode: 'development', devPort: devPort,
                devUrl: devUrl,
                ssr: ssr,
                serverless: serverless }, olymprc)),
        ]);
    }
    else {
        compiler = webpack([
            createConfig(__assign({ target: 'web', mode: 'development', devPort: devPort,
                devUrl: devUrl,
                ssr: ssr,
                serverless: serverless }, olymprc)),
            createConfig(__assign({ target: 'node', mode: 'development', devPort: devPort,
                devUrl: devUrl,
                ssr: ssr,
                serverless: serverless }, olymprc)),
        ]);
        compiler.compilers[1].watch(watch, function (err, compilation) {
            if (err) {
                return console.log('[webpack] error:', err);
            }
            var stats = compilation.stats || [compilation];
            console.log('[webpack] the following asset bundles were built:');
            stats.forEach(function (c) { return console.log(c.toString()); });
            notifier.notify('Ready');
        });
    }
    var WebpackDevServer = require('webpack-dev-server');
    var server = new WebpackDevServer(compiler.compilers[0], {
        headers: {
            'Access-Control-Allow-Origin': '*',
        },
        watchOptions: watch,
        host: devUrl.hostname,
        port: devUrl.port,
        disableHostCheck: true,
        historyApiFallback: true,
        hot: true,
        stats: {
            colors: true,
            hash: false,
            version: false,
            timings: false,
            assets: false,
            chunks: false,
            modules: false,
            reasons: false,
            children: false,
            source: false,
            errors: true,
            errorDetails: true,
            warnings: false,
            publicPath: false,
        },
    });
    server.listen(devPort);
}
else if (command === 'build') {
    rimraf.sync(path.resolve(root, '.dist'));
    process.env.NODE_ENV = 'production';
    var configs = [
        createConfig(__assign({ target: 'web', mode: 'production', ssr: ssr,
            serverless: serverless }, olymprc)),
    ];
    if (!serverless) {
        configs.push(createConfig(__assign({ target: 'node', mode: 'production', ssr: ssr,
            serverless: serverless }, olymprc)));
    }
    var compiler = webpack(configs);
    compiler.run(function (err, compilation) {
        if (err) {
            console.error(err);
            return process.exit(1);
        }
        var stats = compilation.stats || [compilation];
        console.log('[webpack] the following asset bundles were built:');
        stats.forEach(function (c) { return console.log(c.toString()); });
    });
}
else if (command.indexOf('build:') === 0) {
    var target = command.split(':')[1];
    rimraf.sync(path.resolve(process.cwd(), '.dist', target));
    process.env.NODE_ENV = 'production';
    var compiler = webpack([
        createConfig({ target: target, mode: 'production', ssr: ssr, serverless: serverless, plugins: plugins }),
    ]);
    compiler.run(function (err, compilation) {
        if (err) {
            console.error(err);
            return process.exit(1);
        }
        var stats = compilation.stats || [compilation];
        console.log('[webpack] the following asset bundles were built:');
        stats.forEach(function (c) { return console.log(c.toString()); });
        stats.forEach(function (c) {
            return fs.writeFileSync(path.resolve(__dirname, 'stats.json'), c.toJson());
        });
    });
}
else if (command === 'start') {
    require(path.resolve(process.cwd(), '.dist', 'node', 'main'));
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhY2thZ2VzL2NvcmUvYmluL29seW1wLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUVBLElBQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN6QixJQUFNLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDN0IsSUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ2pDLElBQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUNuQyxJQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDL0IsSUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQzFDLElBQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNyQyxJQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDbkMsSUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDeEQsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRTNCLElBQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUN2QyxTQUFTLEVBQ1QsSUFBSSxFQUNKLG1CQUFtQixDQUNwQixDQUFDLENBQUM7QUFFSCxJQUFNLElBQUksR0FBRyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUM7QUFDM0IsSUFBSSxPQUFPLEdBQUcsUUFBUSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsRUFBRTtJQUNsRSxNQUFNLEVBQUUsS0FBSztDQUNkLENBQUMsQ0FBQztBQUVILEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FB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QU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztBQUNoRSxDQUFDIiwiZmlsZSI6InBhY2thZ2VzL2NvcmUvYmluL29seW1wLmpzIiwic291cmNlc0NvbnRlbnQiOlsiIyEvdXNyL2Jpbi9lbnYgbm9kZVxuXG5jb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgcmltcmFmID0gcmVxdWlyZSgncmltcmFmJyk7XG5jb25zdCB3ZWJwYWNrID0gcmVxdWlyZSgnd2VicGFjaycpO1xuY29uc3QgdXJsVXRpbCA9IHJlcXVpcmUoJ3VybCcpO1xuY29uc3Qgbm90aWZpZXIgPSByZXF1aXJlKCdub2RlLW5vdGlmaWVyJyk7XG5jb25zdCBqc29uZmlsZSA9IHJlcXVpcmUoJ2pzb25maWxlJyk7XG5jb25zdCBtZXJnZSA9IHJlcXVpcmUoJ2RlZXBtZXJnZScpO1xuY29uc3QgYXJndiA9IHJlcXVpcmUoJ21pbmltaXN0JykocHJvY2Vzcy5hcmd2LnNsaWNlKDEpKTtcbnJlcXVpcmUoJ2RvdGVudicpLmNvbmZpZygpO1xuXG5jb25zdCBjcmVhdGVDb25maWcgPSByZXF1aXJlKHBhdGgucmVzb2x2ZShcbiAgX19kaXJuYW1lLFxuICAnLi4nLFxuICAnd2VicGFjay1jb25maWcuanMnXG4pKTtcblxuY29uc3Qgcm9vdCA9IHByb2Nlc3MuY3dkKCk7XG5sZXQgb2x5bXByYyA9IGpzb25maWxlLnJlYWRGaWxlU3luYyhwYXRoLnJlc29sdmUocm9vdCwgJy5vbHltcHJjJyksIHtcbiAgdGhyb3dzOiBmYWxzZSxcbn0pO1xuXG5pZiAob2x5bXByYy5leHRlbmRzKSB7XG4gIGNvbnN0IHRvcEZvbGRlciA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicpO1xuICBjb25zdCBjb25jYXRNZXJnZSA9IChkZXN0aW5hdGlvbkFycmF5LCBzb3VyY2VBcnJheSwgb3B0aW9ucykgPT4ge1xuICAgIHJldHVybiBkZXN0aW5hdGlvbkFycmF5LmNvbmNhdChzb3VyY2VBcnJheSk7XG4gIH07XG4gIGNvbnN0IHJlcXVpcmVGaXJzdCA9IG5hbWUgPT4ge1xuICAgIHJldHVybiAoXG4gICAgICBqc29uZmlsZS5yZWFkRmlsZVN5bmMoXG4gICAgICAgIHBhdGgucmVzb2x2ZSh0b3BGb2xkZXIsIG5hbWUsICcub2x5bXByYycpLFxuICAgICAgICB7IHRocm93czogZmFsc2UgfVxuICAgICAgKSB8fFxuICAgICAganNvbmZpbGUucmVhZEZpbGVTeW5jKFxuICAgICAgICBwYXRoLnJlc29sdmUodG9wRm9sZGVyLCBgb2x5bXAtJHtuYW1lfSwgJy5vbHltcHJjJ2ApLFxuICAgICAgICB7XG4gICAgICAgICAgdGhyb3dzOiBmYWxzZSxcbiAgICAgICAgfVxuICAgICAgKSB8fFxuICAgICAge31cbiAgICApO1xuICB9O1xuICBvbHltcHJjID0gb2x5bXByYy5leHRlbmRzLnJlZHVjZShcbiAgICAocmMsIGl0ZW0pID0+IG1lcmdlKHJlcXVpcmVGaXJzdChpdGVtKSwgcmMsIHsgYXJyYXlNZXJnZTogY29uY2F0TWVyZ2UgfSksXG4gICAgb2x5bXByY1xuICApO1xufVxuXG5jb25zdCBjb21tYW5kID0gYXJndi5fWzFdO1xuXG5pZiAoWydzdGFydCcsICdidWlsZCddLmluY2x1ZGVzKGNvbW1hbmQpKSB7XG4gIHByb2Nlc3MuZW52Lk5PREVfRU5WID0gJ3Byb2R1Y3Rpb24nO1xufVxuXG5jb25zdCB7IFNTUiwgU0VSVkVSTEVTUywgTk9ERV9FTlYsIFBPUlQsIFVSTCB9ID0gcHJvY2Vzcy5lbnY7XG5cbmNvbnN0IHNzciA9IFNTUiAhPSAnZmFsc2UnO1xuY29uc3Qgc2VydmVybGVzcyA9IFNFUlZFUkxFU1MgPT0gJ3RydWUnO1xuXG5pZiAoY29tbWFuZCA9PT0gJ2RldicpIHtcbiAgY29uc3QgcG9ydCA9IHBhcnNlSW50KFBPUlQsIDEwKTtcbiAgY29uc3QgdXJsID0gbmV3IHVybFV0aWwuVVJMKFVSTCB8fCBgaHR0cDovL2xvY2FsaG9zdDoke3BvcnR9YCk7XG4gIGNvbnN0IGRldlBvcnQgPSBzZXJ2ZXJsZXNzID8gcG9ydCA6IHBvcnQgKyAyO1xuICBjb25zdCBkZXZVcmwgPSBzZXJ2ZXJsZXNzXG4gICAgPyB1cmxcbiAgICA6IG5ldyB1cmxVdGlsLlVSTChgJHt1cmwucHJvdG9jb2x9Ly8ke3VybC5ob3N0bmFtZX06JHtkZXZQb3J0fWApO1xuXG4gIGxldCBjb21waWxlcjtcbiAgY29uc3Qgd2F0Y2ggPSB7XG4gICAgYWdncmVnYXRlVGltZW91dDogMzAwLFxuICAgIHBvbGw6IGZhbHNlLFxuICAgIGlnbm9yZWQ6IC9ub2RlX21vZHVsZXMvLFxuICB9O1xuICBpZiAoc2VydmVybGVzcykge1xuICAgIGNvbXBpbGVyID0gd2VicGFjayhbXG4gICAgICBjcmVhdGVDb25maWcoe1xuICAgICAgICB0YXJnZXQ6ICd3ZWInLFxuICAgICAgICBtb2RlOiAnZGV2ZWxvcG1lbnQnLFxuICAgICAgICBkZXZQb3J0LFxuICAgICAgICBkZXZVcmwsXG4gICAgICAgIHNzcixcbiAgICAgICAgc2VydmVybGVzcyxcbiAgICAgICAgLi4ub2x5bXByYyxcbiAgICAgIH0pLFxuICAgIF0pO1xuICB9IGVsc2Uge1xuICAgIGNvbXBpbGVyID0gd2VicGFjayhbXG4gICAgICBjcmVhdGVDb25maWcoe1xuICAgICAgICB0YXJnZXQ6ICd3ZWInLFxuICAgICAgICBtb2RlOiAnZGV2ZWxvcG1lbnQnLFxuICAgICAgICBkZXZQb3J0LFxuICAgICAgICBkZXZVcmwsXG4gICAgICAgIHNzcixcbiAgICAgICAgc2VydmVybGVzcyxcbiAgICAgICAgLi4ub2x5bXByYyxcbiAgICAgIH0pLFxuICAgICAgY3JlYXRlQ29uZmlnKHtcbiAgICAgICAgdGFyZ2V0OiAnbm9kZScsXG4gICAgICAgIG1vZGU6ICdkZXZlbG9wbWVudCcsXG4gICAgICAgIGRldlBvcnQsXG4gICAgICAgIGRldlVybCxcbiAgICAgICAgc3NyLFxuICAgICAgICBzZXJ2ZXJsZXNzLFxuICAgICAgICAuLi5vbHltcHJjLFxuICAgICAgfSksXG4gICAgXSk7XG4gICAgY29tcGlsZXIuY29tcGlsZXJzWzFdLndhdGNoKHdhdGNoLCAoZXJyLCBjb21waWxhdGlvbikgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICByZXR1cm4gY29uc29sZS5sb2coJ1t3ZWJwYWNrXSBlcnJvcjonLCBlcnIpO1xuICAgICAgfVxuICAgICAgY29uc3Qgc3RhdHMgPSBjb21waWxhdGlvbi5zdGF0cyB8fCBbY29tcGlsYXRpb25dO1xuICAgICAgY29uc29sZS5sb2coJ1t3ZWJwYWNrXSB0aGUgZm9sbG93aW5nIGFzc2V0IGJ1bmRsZXMgd2VyZSBidWlsdDonKTtcbiAgICAgIHN0YXRzLmZvckVhY2goYyA9PiBjb25zb2xlLmxvZyhjLnRvU3RyaW5nKCkpKTtcbiAgICAgIG5vdGlmaWVyLm5vdGlmeSgnUmVhZHknKTtcbiAgICB9KTtcbiAgfVxuICBjb25zdCBXZWJwYWNrRGV2U2VydmVyID0gcmVxdWlyZSgnd2VicGFjay1kZXYtc2VydmVyJyk7XG4gIGNvbnN0IHNlcnZlciA9IG5ldyBXZWJwYWNrRGV2U2VydmVyKGNvbXBpbGVyLmNvbXBpbGVyc1swXSwge1xuICAgIGhlYWRlcnM6IHtcbiAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gICAgfSxcbiAgICB3YXRjaE9wdGlvbnM6IHdhdGNoLFxuICAgIGhvc3Q6IGRldlVybC5ob3N0bmFtZSxcbiAgICBwb3J0OiBkZXZVcmwucG9ydCxcbiAgICBkaXNhYmxlSG9zdENoZWNrOiB0cnVlLFxuICAgIGhpc3RvcnlBcGlGYWxsYmFjazogdHJ1ZSxcbiAgICBob3Q6IHRydWUsXG4gICAgc3RhdHM6IHtcbiAgICAgIGNvbG9yczogdHJ1ZSxcbiAgICAgIGhhc2g6IGZhbHNlLFxuICAgICAgdmVyc2lvbjogZmFsc2UsXG4gICAgICB0aW1pbmdzOiBmYWxzZSxcbiAgICAgIGFzc2V0czogZmFsc2UsXG4gICAgICBjaHVua3M6IGZhbHNlLFxuICAgICAgbW9kdWxlczogZmFsc2UsXG4gICAgICByZWFzb25zOiBmYWxzZSxcbiAgICAgIGNoaWxkcmVuOiBmYWxzZSxcbiAgICAgIHNvdXJjZTogZmFsc2UsXG4gICAgICBlcnJvcnM6IHRydWUsXG4gICAgICBlcnJvckRldGFpbHM6IHRydWUsXG4gICAgICB3YXJuaW5nczogZmFsc2UsXG4gICAgICBwdWJsaWNQYXRoOiBmYWxzZSxcbiAgICB9LFxuICB9KTtcbiAgc2VydmVyLmxpc3RlbihkZXZQb3J0KTtcbn0gZWxzZSBpZiAoY29tbWFuZCA9PT0gJ2J1aWxkJykge1xuICByaW1yYWYuc3luYyhwYXRoLnJlc29sdmUocm9vdCwgJy5kaXN0JykpO1xuICBwcm9jZXNzLmVudi5OT0RFX0VOViA9ICdwcm9kdWN0aW9uJztcbiAgY29uc3QgY29uZmlncyA9IFtcbiAgICBjcmVhdGVDb25maWcoe1xuICAgICAgdGFyZ2V0OiAnd2ViJyxcbiAgICAgIG1vZGU6ICdwcm9kdWN0aW9uJyxcbiAgICAgIHNzcixcbiAgICAgIHNlcnZlcmxlc3MsXG4gICAgICAuLi5vbHltcHJjLFxuICAgIH0pLFxuICBdO1xuICBpZiAoIXNlcnZlcmxlc3MpIHtcbiAgICBjb25maWdzLnB1c2goXG4gICAgICBjcmVhdGVDb25maWcoe1xuICAgICAgICB0YXJnZXQ6ICdub2RlJyxcbiAgICAgICAgbW9kZTogJ3Byb2R1Y3Rpb24nLFxuICAgICAgICBzc3IsXG4gICAgICAgIHNlcnZlcmxlc3MsXG4gICAgICAgIC4uLm9seW1wcmMsXG4gICAgICB9KVxuICAgICk7XG4gIH1cbiAgY29uc3QgY29tcGlsZXIgPSB3ZWJwYWNrKGNvbmZpZ3MpO1xuICBjb21waWxlci5ydW4oKGVyciwgY29tcGlsYXRpb24pID0+IHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgICByZXR1cm4gcHJvY2Vzcy5leGl0KDEpO1xuICAgIH1cbiAgICBjb25zdCBzdGF0cyA9IGNvbXBpbGF0aW9uLnN0YXRzIHx8IFtjb21waWxhdGlvbl07XG4gICAgY29uc29sZS5sb2coJ1t3ZWJwYWNrXSB0aGUgZm9sbG93aW5nIGFzc2V0IGJ1bmRsZXMgd2VyZSBidWlsdDonKTtcbiAgICAvKiBzdGF0cy5mb3JFYWNoKGMgPT5cbiAgICAgIGZzLndyaXRlRmlsZVN5bmMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJ3N0YXRzLmpzb24nKSwgYy50b0pzb24oKSlcbiAgICApOyAqL1xuICAgIHN0YXRzLmZvckVhY2goYyA9PiBjb25zb2xlLmxvZyhjLnRvU3RyaW5nKCkpKTtcbiAgfSk7XG59IGVsc2UgaWYgKGNvbW1hbmQuaW5kZXhPZignYnVpbGQ6JykgPT09IDApIHtcbiAgY29uc3QgdGFyZ2V0ID0gY29tbWFuZC5zcGxpdCgnOicpWzFdO1xuICByaW1yYWYuc3luYyhwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgJy5kaXN0JywgdGFyZ2V0KSk7XG4gIHByb2Nlc3MuZW52Lk5PREVfRU5WID0gJ3Byb2R1Y3Rpb24nO1xuICBjb25zdCBjb21waWxlciA9IHdlYnBhY2soW1xuICAgIGNyZWF0ZUNvbmZpZyh7IHRhcmdldCwgbW9kZTogJ3Byb2R1Y3Rpb24nLCBzc3IsIHNlcnZlcmxlc3MsIHBsdWdpbnMgfSksXG4gIF0pO1xuICBjb21waWxlci5ydW4oKGVyciwgY29tcGlsYXRpb24pID0+IHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgICByZXR1cm4gcHJvY2Vzcy5leGl0KDEpO1xuICAgIH1cbiAgICBjb25zdCBzdGF0cyA9IGNvbXBpbGF0aW9uLnN0YXRzIHx8IFtjb21waWxhdGlvbl07XG4gICAgY29uc29sZS5sb2coJ1t3ZWJwYWNrXSB0aGUgZm9sbG93aW5nIGFzc2V0IGJ1bmRsZXMgd2VyZSBidWlsdDonKTtcbiAgICBzdGF0cy5mb3JFYWNoKGMgPT4gY29uc29sZS5sb2coYy50b1N0cmluZygpKSk7XG4gICAgc3RhdHMuZm9yRWFjaChjID0+XG4gICAgICBmcy53cml0ZUZpbGVTeW5jKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICdzdGF0cy5qc29uJyksIGMudG9Kc29uKCkpXG4gICAgKTtcbiAgfSk7XG59IGVsc2UgaWYgKGNvbW1hbmQgPT09ICdzdGFydCcpIHtcbiAgcmVxdWlyZShwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgJy5kaXN0JywgJ25vZGUnLCAnbWFpbicpKTtcbn1cbiJdfQ==
